@Styles.Render("~/Content/chat-styles.css?v=" + DateTime.Now.Ticks)

@{
    ViewBag.Title = "Chat";
    Layout = "~/Views/Shared/_ChatLayout.cshtml";
}
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css" />

<div class="chat-view-wrapper">
    <div class="chat-main">
        <!-- Header Container -->
        <div id="chat-header-container">
            <!-- Private Header -->
            <div id="private-chat-header" class="chat-header" style="display: none;">
                <div id="user-chat-header" class="chat-header-info d-flex align-items-center">
                    <div class="chat-header-avatar-wrapper" style="cursor: pointer;">
                        <img id="chat-header-avatar" src="" alt="Avatar" class="chat-header-avatar me-2" />
                        <span class="status-indicator" id="header-status-indicator"></span>
                    </div>
                    <div style="cursor: pointer;">
                        <div id="chat-header-displayname" class="fw-bold"></div>
                        <div id="chat-header-status" class="text-muted">Đang hoạt động</div>
                    </div>
                </div>
                <div class="d-flex align-items-center">
                    <div id="user-chat-buttons" style="display: none;">
                        <button id="start-voice-call-btn" class="btn btn-light" title="Gọi thoại">
                            <i class="fas fa-phone-alt"></i>
                        </button>
                        <button id="start-video-call-btn" class="btn btn-light" title="Gọi video">
                            <i class="fas fa-video"></i>
                        </button>
                        <button id="toggle-search-sidebar-btn" class="btn btn-light" title="Tìm kiếm">
                            <i class="fas fa-search"></i>
                        </button>
                        <button id="toggle-info-sidebar-btn" class="btn btn-light" title="Thông tin hội thoại">
                            <i class="fas fa-info-circle"></i>
                        </button>
                    </div>
                    <button id="toggle-conversations-btn" class="btn btn-light" title="Ẩn/Hiện danh sách bạn bè">
                        <i class="fas fa-list-ul"></i>
                    </button>
                    <button id="create-group-btn" class="btn btn-create-group" type="button" title="Tạo nhóm mới">
                        <i class="fas fa-users"></i>
                    </button>
                </div>
            </div>

            <!-- AI Header -->
            <div id="ai-chat-header" class="ai-header px-3 py-2" style="display: none;">
                <button id="ai-back-btn" class="btn btn-link text-white p-1" title="Quay lại danh sách">
                    <i class="fas fa-chevron-left fs-4"></i>
                </button>
                <div class="ai-title text-white fw-bold d-flex align-items-center gap-1">
                    <span>Chat AI</span>
                    <i class="fas fa-check-circle text-success" title="Verified"></i>
                </div>
                <button id="ai-info-btn" class="btn btn-link text-white p-1" title="Thông tin AI">
                    <i class="fas fa-info-circle fs-5"></i>
                </button>
            </div>
        </div>

        <!-- AI Welcome Screen -->
        <div id="ai-welcome-screen" style="display: none;">
            <div class="ai-logo-circle"></div>
            <h3>Bắt đầu chat với AI</h3>
            <p>Hỏi tôi bất cứ điều gì bạn muốn</p>
            <div class="ai-prompt-suggestions">
                <button class="ai-prompt-btn" data-prompt="AI có sở trường gì?">AI có sở trường gì?</button>
                <button class="ai-prompt-btn" data-prompt="Nghĩ ra một ý tưởng sản phẩm thú vị">Nghĩ ra một ý tưởng sản phẩm thú vị</button>
                <button class="ai-prompt-btn" data-prompt="Giúp tôi khám phá ngôn ngữ tình yêu">Giúp tôi khám phá ngôn ngữ tình yêu</button>
            </div>
        </div>

        <!-- Message Area -->
        <div class="message-area" id="messagesList"></div>

        <!-- Typing Indicator -->
        <div id="typing-indicator" style="display: none; padding: 10px 20px; margin-bottom: 10px;">
            <div class="typing-dots">
                <span class="typing-avatar"></span>
                <div class="typing-bubble">
                    <span class="dot"></span>
                    <span class="dot"></span>
                    <span class="dot"></span>
                </div>
            </div>
        </div>

        <!-- Reply Banner -->
        <div id="reply-banner" style="display: none; padding: 8px 15px; background-color: #f0f2f5; border-top: 1px solid #ddd;">
            <div style="display: flex; justify-content: space-between; align-items: center;">
                <div>
                    <div id="reply-banner-text" style="font-size: 0.85rem; font-weight: 600; color: #007bff;"></div>
                    <div id="reply-banner-preview" style="font-size: 0.8rem; color: #6c757d; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; max-width: 300px;"></div>
                </div>
                <button id="close-reply-banner" class="btn btn-sm btn-light" style="border-radius: 50%; width: 28px; height: 28px; display: flex; align-items: center; justify-content: center;">&times;</button>
            </div>
        </div>

        <!-- File Inputs -->
        <input type="file" id="imageUploadInput" accept="image/*" multiple style="display: none;" />
        <input type="file" id="fileUploadInput" multiple style="display: none;" />

        <!-- Input Area -->
        <div class="input-area">
            <button id="emoji-button" class="btn btn-light" type="button" title="Biểu cảm">
                <i class="fas fa-smile"></i>
            </button>
            <button id="quick-image-btn" class="btn btn-light" type="button" title="Gửi ảnh nhanh">
                <i class="fas fa-image"></i>
            </button>
            <button id="toggle-attach-menu" class="btn btn-light" type="button" title="Đính kèm khác">
                <i class="fas fa-paperclip"></i>
            </button>
            <button id="record-voice-btn" class="btn btn-light" type="button" title="Ghi âm giọng nói">
                <i class="fas fa-microphone"></i>
            </button>
            <div id="recording-timer" style="display: none; align-items: center; gap: 5px; color: #d9534f; font-weight: 600; margin: 0 10px;">
                <i class="fas fa-circle" style="font-size: 8px;"></i>
                <span>00:00</span>
            </div>
            <input type="text" id="messageInput" placeholder="Nhập tin nhắn..." autocomplete="off" />
            <button id="sendButton"><i class="fas fa-paper-plane"></i></button>
        </div>
    </div>

    <div id="conversation-info-sidebar" style="display: none;">
        <div class="info-sidebar-header">
            <h5>Thông tin hội thoại</h5>
            <button id="close-info-sidebar-btn" type="button" class="close" aria-label="Close">
                <span aria-hidden="true">&times;</span>
            </button>
        </div>

        <div class="info-sidebar-body">
            <!-- User info -->
            <div class="info-sidebar-user">
                <div id="info-sidebar-avatar-wrapper" class="position-relative">
                    <img id="info-sidebar-avatar" src="/Content/default-avatar.png" />
                    <button id="change-group-avatar-btn" class="btn btn-sm btn-light" style="display: none; position: absolute; bottom: 5px; right: 5px; border-radius: 50%;">
                        <i class="fas fa-camera"></i>
                    </button>
                </div>
                <h5 id="info-sidebar-displayname">Đang tải...</h5>
            </div>
            <input type="file" id="groupAvatarInput" accept="image/*" style="display: none;" />

            <div class="chat-settings-section">
                <h6>
                    <i class="fas fa-paint-brush"></i> Tùy chỉnh
                </h6>

                <!-- Đổi hình nền -->
                <div class="setting-item">
                    <div class="setting-label">
                        <i class="fas fa-image" style="color: #673ab7;"></i>
                        <span>Đổi hình nền</span>
                    </div>
                    <button class="btn btn-sm btn-outline-primary" id="change-background-btn">
                        <i class="fas fa-edit"></i>
                    </button>
                </div>
            </div>

            <!-- Biệt danh section - CHỈ HIỂN THỊ KHI CHAT PRIVATE -->
            <div class="chat-settings-section" id="nickname-section" style="display: none;">
                <h6>
                    <i class="fas fa-user-tag"></i> Biệt danh
                    <small style="font-weight: 400; color: #999; font-size: 0.75rem;">(Chỉ bạn nhìn thấy)</small>
                </h6>

                <!-- Biệt danh của mình -->
                <div class="nickname-input-group">
                    <label>
                        <span>Biệt danh của bạn</span>
                    </label>
                    <input type="text" id="my-nickname-input" placeholder="Nhập biệt danh của bạn..." />
                    <div class="nickname-preview" id="my-nickname-preview">
                        Để trống nếu muốn dùng tên thật
                    </div>
                </div>

                <!-- Biệt danh của đối phương -->
                <div class="nickname-input-group">
                    <label>
                        <i class="fas fa-user-friends"></i>
                        <span id="partner-nickname-label">Biệt danh của đối phương</span>
                    </label>
                    <input type="text" id="partner-nickname-input" placeholder="Nhập biệt danh cho đối phương..." />
                    <div class="nickname-preview" id="partner-nickname-preview">
                        Chỉ bạn nhìn thấy biệt danh này
                    </div>
                </div>

                <!-- Nút lưu -->
                <button class="btn-save-nicknames" id="save-nicknames-btn">
                    <i class="fas fa-check"></i> Lưu biệt danh
                </button>
            </div>

            <!-- Accordion -->
            <div class="accordion" id="infoAccordion">
                <!-- Images/Videos -->
                <div class="info-accordion-card">
                    <div class="card-header" id="headingImages">
                        <button class="btn btn-link btn-block text-left" type="button" data-bs-toggle="collapse" data-bs-target="#collapseImages">
                            Ảnh/Video
                            <i class="fas fa-chevron-down float-right"></i>
                        </button>
                    </div>
                    <div id="collapseImages" class="collapse show" data-parent="#infoAccordion">
                        <div class="card-body" id="info-sidebar-images-list">
                            <p class="text-muted text-center small p-3">Chưa có ảnh/video nào.</p>
                        </div>
                    </div>
                </div>

                <!-- Files -->
                <div class="info-accordion-card">
                    <div class="card-header" id="headingFiles">
                        <button class="btn btn-link btn-block text-left collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseFiles">
                            File
                            <i class="fas fa-chevron-down float-right"></i>
                        </button>
                    </div>
                    <div id="collapseFiles" class="collapse" data-parent="#infoAccordion">
                        <div class="card-body" id="info-sidebar-files-list">
                            <p class="text-muted text-center small p-3">Chưa có file nào.</p>
                        </div>
                    </div>
                </div>

                <!-- Security Settings -->
                <div class="info-accordion-card">
                    <div class="card-header" id="headingSecurity">
                        <button class="btn btn-link btn-block text-left collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseSecurity">
                            Thiết lập bảo mật
                            <i class="fas fa-chevron-down float-right"></i>
                        </button>
                    </div>
                    <div id="collapseSecurity" class="collapse" data-parent="#infoAccordion">
                        <div class="card-body list-group list-group-flush" style="padding: 0;">
                            <!-- ẨN TRÒ CHUYỆN -->
                            <div class="list-group-item d-flex justify-content-between align-items-center" style="border:none; background: #fff; padding: 14px 20px;">
                                <span>
                                    <i class="fas fa-eye-slash"></i> Ẩn trò chuyện
                                </span>
                                <label class="custom-toggle-switch">
                                    <input type="checkbox" id="info-action-hide-chat">
                                    <span class="slider round"></span>
                                </label>
                            </div>
                            <!-- BÁO XẤU -->
                            <a href="#" class="list-group-item list-group-item-action text-danger" id="info-action-report">
                                <i class="fas fa-exclamation-triangle"></i> Báo xấu
                            </a>
                            <!-- CHẶN -->
                            <a href="#" class="list-group-item list-group-item-action text-danger" id="info-action-block-user">
                                <i class="fas fa-ban"></i> Chặn người dùng
                            </a>
                            <!-- XÓA LỊCH SỬ -->
                            <a href="#" class="list-group-item list-group-item-action text-danger" id="info-action-clear-history">
                                <i class="fas fa-trash-alt"></i> Xóa lịch sử trò chuyện
                            </a>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Search Sidebar -->
    <div id="search-sidebar" style="display: none;">
        <div class="info-sidebar-header">
            <h5>Tìm kiếm tin nhắn</h5>
            <button id="close-search-sidebar-btn" type="button" class="close" aria-label="Close">
                <span aria-hidden="true">&times;</span>
            </button>
        </div>
        <div class="info-sidebar-body">
            <div class="input-group mb-3 p-3">
                <input type="text" id="search-message-input" class="form-control" placeholder="Nhập để tìm kiếm...">
                <div class="input-group-append">
                    <button id="execute-search-btn" class="btn btn-primary" type="button"><i class="fas fa-search"></i></button>
                </div>
            </div>
            <div id="search-results-container" class="p-3">
                <!-- Search results will be appended here -->
            </div>
        </div>
    </div>

    <div class="modal fade" id="createGroupModal" tabindex="-1" role="dialog">
        <div class="modal-dialog modal-dialog-centered modal-lg">
            <div class="modal-content" style="border-radius: 24px; overflow: hidden; border: none; box-shadow: 0 20px 60px rgba(0,0,0,0.3);">

                <!-- Header with gradient -->
                <div class="modal-header" style="background: linear-gradient(135deg, #43a047 0%, #66bb6a 100%); border: none; padding: 30px; position: relative; overflow: hidden;">
                    <div style="position: absolute; top: -50px; right: -50px; width: 200px; height: 200px; background: rgba(255,255,255,0.1); border-radius: 50%;"></div>
                    <div style="position: absolute; bottom: -30px; left: -30px; width: 150px; height: 150px; background: rgba(255,255,255,0.08); border-radius: 50%;"></div>

                    <div style="position: relative; z-index: 1; width: 100%;">
                        <h4 class="modal-title" style="color: white; font-weight: 700; margin: 0; display: flex; align-items: center; gap: 12px;">
                            <div style="width: 48px; height: 48px; background: rgba(255,255,255,0.2); border-radius: 50%; display: flex; align-items: center; justify-content: center; backdrop-filter: blur(10px);">
                                <i class="fas fa-users" style="font-size: 20px;"></i>
                            </div>
                            <span>Tạo nhóm mới</span>
                        </h4>
                        <p style="color: rgba(255,255,255,0.9); margin: 8px 0 0 60px; font-size: 14px;">Kết nối và trò chuyện cùng nhiều người</p>
                    </div>

                    <button type="button" class="close" data-dismiss="modal" style="position: absolute; right: 20px; top: 20px; color: white; opacity: 0.9; font-size: 28px; font-weight: 300; text-shadow: none; z-index: 2;">
                        <span>&times;</span>
                    </button>
                </div>

                <!-- Body -->
                <div class="modal-body" style="padding: 30px;">

                    <!-- Group Name Input -->
                    <div style="margin-bottom: 30px;">
                        <label style="font-weight: 600; color: #333; margin-bottom: 10px; display: flex; align-items: center; gap: 8px; font-size: 14px;">
                            <i class="fas fa-tag" style="color: #43a047;"></i>
                            Tên nhóm
                        </label>
                        <div style="position: relative;">
                            <input type="text"
                                   class="form-control"
                                   id="groupNameInput"
                                   placeholder="VD: Nhóm bạn thân, Dự án ABC..."
                                   maxlength="50"
                                   style="border: 2px solid #e0e0e0; border-radius: 16px; padding: 14px 20px; font-size: 15px; transition: all 0.3s; padding-right: 50px;">
                            <span id="groupNameCounter" style="position: absolute; right: 15px; top: 50%; transform: translateY(-50%); color: #999; font-size: 12px;">0/50</span>
                        </div>
                    </div>

                    <hr style="border: none; height: 1px; background: linear-gradient(90deg, transparent, #e0e0e0, transparent); margin: 30px 0;" />

                    <!-- Members Section -->
                    <div>
                        <label style="font-weight: 600; color: #333; margin-bottom: 12px; display: flex; align-items: center; justify-content: space-between; font-size: 14px;">
                            <span style="display: flex; align-items: center; gap: 8px;">
                                <i class="fas fa-user-friends" style="color: #43a047;"></i>
                                Thêm thành viên
                            </span>
                            <span id="selectedMemberCount" style="background: linear-gradient(135deg, #43a047, #66bb6a); color: white; padding: 4px 12px; border-radius: 20px; font-size: 12px; font-weight: 600;">0 người</span>
                        </label>

                        <!-- Search Box -->
                        <div style="position: relative; margin-bottom: 16px;">
                            <i class="fas fa-search" style="position: absolute; left: 18px; top: 50%; transform: translateY(-50%); color: #999; font-size: 14px;"></i>
                            <input type="text"
                                   class="form-control"
                                   id="groupMemberSearchInput"
                                   placeholder="Tìm kiếm bạn bè..."
                                   style="border: 2px solid #e0e0e0; border-radius: 16px; padding: 12px 20px 12px 45px; font-size: 14px; transition: all 0.3s;">
                        </div>

                        <!-- Members List -->
                        <div id="groupMembersList"
                             style="max-height: 320px; overflow-y: auto; border: 2px solid #f0f0f0; border-radius: 16px; background: #fafafa;">
                            <p class="text-center text-muted" style="padding: 40px 20px; margin: 0;">
                                <i class="fas fa-spinner fa-spin" style="font-size: 24px; color: #43a047; margin-bottom: 10px;"></i>
                                <br>Đang tải danh sách bạn bè...
                            </p>
                        </div>
                    </div>
                </div>

                <!-- Footer -->
                <div class="modal-footer" style="border-top: 1px solid #f0f0f0; padding: 20px 30px; background: #fafafa;">
                    <button type="button" class="btn btn-secondary btn-cancel-group" data-dismiss="modal">
                        <i class="fas fa-times"></i> Hủy
                    </button>
                    <button type="button" class="btn btn-primary" id="confirmCreateGroupBtn"
                            style="border-radius: 12px; padding: 10px 32px; font-weight: 600; border: none; background: linear-gradient(135deg, #43a047 0%, #66bb6a 100%); box-shadow: 0 4px 15px rgba(67, 160, 71, 0.4); transition: all 0.3s;">
                        <i class="fas fa-check-circle"></i> Tạo nhóm
                    </button>
                </div>
            </div>
        </div>
    </div>


    <!-- Image Preview Modal -->
    <div class="modal fade" id="imagePreviewModal" tabindex="-1" role="dialog">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Xem trước tệp</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body text-center" id="imagePreviewContainer" style="display: flex; flex-wrap: wrap; gap: 10px; justify-content: center;"></div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Hủy</button>
                    <button type="button" class="btn btn-primary" id="sendImageButton">Gửi</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Background Modal -->
    <div class="modal fade" id="backgroundModal" tabindex="-1" role="dialog">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content" style="border-radius: 16px;">
                <div class="modal-header" style="border-bottom: 1px solid #e8f5e9;">
                    <h5 class="modal-title" style="font-weight: 700; color: #2e7d32;">
                        <i class="fas fa-image"></i> Chọn hình nền
                    </h5>
                    <button type="button" class="close" data-dismiss="modal"><span>&times;</span></button>
                </div>
                <div class="modal-body" style="padding: 20px;">
                    <ul class="nav nav-tabs mb-3" style="border-bottom: 2px solid #e8f5e9;">
                        <li class="nav-item">
                            <a class="nav-link active" data-toggle="tab" href="#default-backgrounds">
                                <i class="fas fa-palette"></i> Mặc định
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" data-toggle="tab" href="#custom-backgrounds">
                                <i class="fas fa-upload"></i> Tùy chỉnh
                            </a>
                        </li>
                    </ul>

                    <div class="tab-content">
                        <div class="tab-pane fade show active" id="default-backgrounds">
                            <div class="background-themes" id="default-themes-grid"></div>
                        </div>
                        <div class="tab-pane fade" id="custom-backgrounds">
                            <div id="admin-upload-section" style="display: none;">
                                <div class="alert alert-info">
                                    <i class="fas fa-info-circle"></i> Chỉ admin mới có thể upload hình nền mới.
                                </div>
                                <div class="custom-file mb-3">
                                    <input type="file" class="custom-file-input" id="customBackgroundInput" accept="image/*">
                                    <label class="custom-file-label" for="customBackgroundInput">Chọn ảnh...</label>
                                </div>
                                <button class="btn btn-primary btn-block" id="uploadBackgroundBtn">
                                    <i class="fas fa-cloud-upload-alt"></i> Upload hình nền
                                </button>
                            </div>
                            <div id="user-upload-message" style="text-align: center; padding: 40px 20px; color: #999;">
                                <i class="fas fa-lock" style="font-size: 3rem; margin-bottom: 15px;"></i>
                                <p>Chỉ admin mới có thể thêm hình nền mới.</p>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer" style="border-top: 1px solid #e8f5e9;">
                    <button type="button" class="btn btn-secondary" data-dismiss="modal">Đóng</button>
                    <button type="button" class="btn btn-danger" id="removeBackgroundBtn">
                        <i class="fas fa-times"></i> Xóa hình nền
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Calling Modals (giữ nguyên như cũ) -->
    <div class="modal fade" id="incomingCallModal" tabindex="-1" data-backdrop="static" data-keyboard="false">
        <div class="modal-dialog modal-sm modal-dialog-centered">
            <div class="modal-content" style="border-radius: 12px;">
                <div class="modal-body text-center p-4">
                    <h5 class="mb-2">Cuộc gọi đến</h5>
                    <img id="incoming-call-avatar" src="/Content/default-avatar.png" style="width: 70px; height: 70px; border-radius: 50%; margin-bottom: 10px;" />
                    <h4 id="incoming-call-name" style="font-weight: 600;">...</h4>
                    <p id="incoming-call-type" class="text-muted small">Đang gọi...</p>
                    <div class="d-flex justify-content-around mt-4">
                        <button id="decline-call-btn" class="btn btn-danger btn-lg" style="border-radius: 50%; width: 60px; height: 60px;">
                            <i class="fas fa-times"></i>
                        </button>
                        <button id="accept-call-btn" class="btn btn-success btn-lg" style="border-radius: 50%; width: 60px; height: 60px;">
                            <i class="fas fa-check"></i>
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div id="call-view" style="display: none; position: fixed; inset: 0; background: #222; z-index: 2000; color: white;">
        <video id="remoteVideo" autoplay playsinline style="width: 100%; height: 100%; object-fit: cover;"></video>
        <video id="localVideo" autoplay playsinline muted style="position: absolute; top: 20px; right: 20px; width: 25%; max-width: 300px; border-radius: 10px; border: 2px solid white;"></video>

        <div id="call-info-overlay" style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); text-align: center;">
            <img id="call-view-avatar" src="/Content/default-avatar.png" style="width: 120px; height: 120px; border-radius: 50%; margin-bottom: 20px;" />
            <h2 id="call-view-name">Đang gọi...</h2>
            <p id="call-view-status">Đang kết nối...</p>
        </div>

        <div id="call-controls" style="position: absolute; bottom: 40px; left: 50%; transform: translateX(-50%); display: flex; gap: 20px;">
            <button id="toggle-video-btn" class="btn btn-light btn-lg" style="border-radius: 50%; width: 60px; height: 60px;">
                <i class="fas fa-video"></i>
            </button>
            <button id="toggle-mic-btn" class="btn btn-light btn-lg" style="border-radius: 50%; width: 60px; height: 60px;">
                <i class="fas fa-microphone"></i>
            </button>
            <button id="hang-up-btn" class="btn btn-danger btn-lg" style="border-radius: 50%; width: 60px; height: 60px;">
                <i class="fas fa-phone-slash"></i>
            </button>
        </div>
    </div>
    <!-- Partner Profile Modal -->
    <div class="modal fade" id="partnerProfileModal" tabindex="-1" role="dialog">
        <div class="modal-dialog modal-dialog-centered modal-lg">
            <div class="modal-content" style="border-radius: 16px; overflow: hidden;">
                <!-- Cover Photo -->
                <div id="partner-modal-cover" style="height: 150px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); background-size: cover; background-position: center;"></div>

                <!-- Avatar -->
                <div style="text-align: center; margin-top: -60px; position: relative;">
                    <img id="partner-modal-avatar" src="/Content/default-avatar.png" style="width: 120px; height: 120px; border-radius: 50%; border: 5px solid white; object-fit: cover; box-shadow: 0 4px 12px rgba(0,0,0,0.2);" />
                </div>

                <div class="modal-body text-center" style="padding: 20px;">
                    <!-- Name & Username -->
                    <h4 id="partner-modal-display-name" style="font-weight: 700; margin-bottom: 5px;">Đang tải...</h4>
                    <p id="partner-modal-username" style="color: #6c757d; font-size: 0.9rem; margin-bottom: 20px;">@@username</p>

                    <!-- Info Grid -->
                    <div style="text-align: left; margin: 0 auto; max-width: 400px;">
                        <div style="display: grid; grid-template-columns: 100px 1fr; gap: 12px; margin-bottom: 12px;">
                            <span style="font-weight: 600; color: #555;"><i class="fas fa-venus-mars"></i> Giới tính:</span>
                            <span id="partner-modal-gender">Chưa cập nhật</span>
                        </div>
                        <div style="display: grid; grid-template-columns: 100px 1fr; gap: 12px; margin-bottom: 12px;">
                            <span style="font-weight: 600; color: #555;"><i class="fas fa-birthday-cake"></i> Ngày sinh:</span>
                            <span id="partner-modal-dob">Chưa cập nhật</span>
                        </div>
                        <div style="display: grid; grid-template-columns: 100px 1fr; gap: 12px; margin-bottom: 12px;">
                            <span style="font-weight: 600; color: #555;"><i class="fas fa-phone"></i> SĐT:</span>
                            <span id="partner-modal-phone">Chưa cập nhật</span>
                        </div>
                        <div style="display: grid; grid-template-columns: 100px 1fr; gap: 12px; margin-bottom: 12px;">
                            <span style="font-weight: 600; color: #555;"><i class="fas fa-envelope"></i> Email:</span>
                            <span id="partner-modal-email">Chưa cập nhật</span>
                        </div>
                    </div>

                    <!-- Bio -->
                    <div style="margin-top: 20px; padding: 12px; background: #f8f9fa; border-radius: 8px; text-align: left;">
                        <p style="margin: 0; font-size: 0.9rem; color: #555;" id="partner-modal-bio">Không có tiểu sử.</p>
                    </div>

                    <!-- Unfriend Form -->
                    <form id="partner-unfriend-form" method="post" action="/Friend/Unfriend" style="display: none; margin-top: 20px;">
                        @Html.AntiForgeryToken()
                        <input type="hidden" name="friendshipId" id="partner-unfriend-id" value="" />
                        <button type="submit" class="btn btn-danger btn-block">
                            <i class="fas fa-user-times"></i> Xóa bạn bè
                        </button>
                    </form>

                    <!-- Action Buttons -->
                    <div style="margin-top: 15px; display: flex; gap: 10px; justify-content: center;">
                        <button class="btn btn-warning" id="partner-action-block">
                            <i class="fas fa-ban"></i> Chặn
                        </button>
                        <button class="btn btn-danger" id="partner-action-report">
                            <i class="fas fa-flag"></i> Báo xấu
                        </button>
                    </div>
                </div>

                <div class="modal-footer" style="border-top: 1px solid #e8f5e9; padding: 12px 20px;">
                    <button type="button" class="btn btn-secondary" data-dismiss="modal">Đóng</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Forward Message Modal -->
    <div class="modal fade" id="forwardMessageModal" tabindex="-1" role="dialog">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Chuyển tiếp đến...</h5>
                    <button type="button" class="close" data-dismiss="modal">&times;</button>
                </div>
                <div class="modal-body">
                    <div class="input-group mb-3">
                        <input type="text" id="forward-search-input" class="form-control" placeholder="Tìm kiếm cuộc trò chuyện...">
                    </div>
                    <div id="forward-conversations-list" style="max-height: 300px; overflow-y: auto;">
                        <!-- Conversation list will be populated here by JS -->
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-dismiss="modal">Hủy</button>
                    <button type="button" class="btn btn-primary" id="confirm-forward-btn">Chuyển tiếp</button>
                </div>
            </div>
        </div>
    </div>

</div>

@section scripts {
    @Html.AntiForgeryToken()
    <script src="~/Scripts/jquery.signalR-2.4.3.min.js"></script>
    <script src="~/signalr/hubs"></script>

    <script>
        window.chatConfig = {
            currentUsername: @Html.Raw(Json.Encode(User.Identity.Name)),
            selectedFriendUsername: @Html.Raw(Json.Encode(ViewBag.SelectedFriendUsername)),
            antiForgeryToken: $('input[name="__RequestVerificationToken"]').first().val(),
            urls: {
                getChatHistory: '@Url.Action("GetChatHistory", "Chat")',
                getConversations: '@Url.Action("GetConversations", "Chat")',
                getConversationInfo: '@Url.Action("GetConversationInfo", "Chat")',
                getFriends: '@Url.Action("GetFriends", "Friend")',
                clearHistory: '@Url.Action("ClearHistory", "Chat")',
                deleteConversation: '@Url.Action("DeleteConversation", "Chat")',
                pinConversation: '@Url.Action("PinConversation", "Chat")',
                reportConversation: '@Url.Action("ReportConversation", "Chat")',
                searchMessages: '@Url.Action("SearchMessages", "Chat")',
                getGroupChatHistory: '@Url.Action("GetGroupChatHistory", "Chat")',
                changeGroupAvatar: '@Url.Action("ChangeGroupAvatar", "Chat")',
                blockUser: '@Url.Action("BlockUser", "Settings")'
            }
        };

        console.log('✅ Config loaded:', window.chatConfig);
    </script>

    <script src="~/Scripts/chat-client.js?v=@DateTime.Now.Ticks"></script>
}