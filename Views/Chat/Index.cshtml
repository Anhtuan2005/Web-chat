@{
    ViewBag.Title = "Chat";
    Layout = "~/Views/Shared/_ChatLayout.cshtml";
}
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css" />
<style>
    .chat-view-wrapper {
        display: flex;
        flex-direction: row;
        width: 100%;
        height: 100%;
        overflow: hidden; 
    }
    .chat-main {
        flex-grow: 1;
        display: flex;
        flex-direction: column;
        background-color: #fff;
        height: 100%; /* Đảm bảo lấp đầy không gian trong layout */
        transition: width 0.3s ease;
    }

    .chat-header {
        padding: 10px 15px;
        border-bottom: 1px solid #ddd;
        font-weight: bold;
        min-height: 66px;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }

    .chat-header-avatar {
        width: 40px;
        height: 40px;
        border-radius: 50%;
        object-fit: cover;
        border: 1px solid #eee;
    }

    .chat-header-info {
        cursor: pointer;
    }

    .chat-header .btn-light {
        width: 38px;
        height: 38px;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        margin-left: 5px;
        color: #555;
        border-radius: 50%;
        font-size: 1.1rem;
    }

    #toggle-conversations-btn {
        color: #2e7d32;
    }

    .chat-header-status {
        font-size: 0.85rem;
        color: #6c757d; /* màu xám text-muted */
        font-weight: 400;
    }

    .message-area {
        flex-grow: 1;
        padding: 20px !important;
        overflow-y: auto;
    }
    .message-area::-webkit-scrollbar {
        width: 8px; /* Giữ nguyên độ rộng */
    }

    .message-area::-webkit-scrollbar-track {
        background: transparent; /* Rãnh trong suốt, chìm vào nền */
        border-radius: 10px;
        margin: 8px 0;
    }

    .message-area::-webkit-scrollbar-thumb {
        background: #d8d8d8; /* Màu xám nhạt, tinh tế */
        border-radius: 10px;
    }

    .message-area::-webkit-scrollbar-thumb:hover {
        background: #bbb; /* Đậm hơn một chút khi rê chuột */
    }
    #messagesList {
        flex: 1; /* Cho phép messagesList co giãn */
    }
    #conversation-info-sidebar {
        width: 320px; 
        height: 100%;
        flex-shrink: 0; 
        background: #fafffe; 
        border-left: 1px solid #e8f5e9; /* Viền xanh nhạt */
        display: flex;
        flex-direction: column;
        transition: all 0.3s ease;
        }

    .info-sidebar-header {
        padding: 0 15px;
        border-bottom: 1px solid #e8f5e9; /* Viền xanh nhạt */
        min-height: 66px;
        display: flex;
        justify-content: space-between;
        align-items: center;
        flex-shrink: 0;
    }
        .info-sidebar-header h5 {
        margin: 0;
        font-weight: 700; /* Đậm hơn */
        color: #2e7d32; /* Màu xanh đậm chủ đạo */
    }
    .info-sidebar-header .close {
        font-size: 1.5rem; 
        font-weight: 600; 
        color: #aaa; /* Xám nhạt */
        opacity: 1;
        text-shadow: none;
        background: #f1f8e9; /* Nền xanh lá nhạt */
        border-radius: 50%;
        width: 32px;
        height: 32px;
        line-height: 32px; /* Căn giữa 'x' */
        padding: 0;
        transition: all 0.2s;
    }
    .info-sidebar-header .close:hover {
        background-color: #e8f5e9;
        color: #333;
    }

    /* Body của Sidebar (cho phép cuộn) */
    .info-sidebar-body {
        flex-grow: 1;
        overflow-y: auto;
        overflow-x: hidden;
    }

    /* Tùy chỉnh thanh cuộn cho Sidebar */
    .info-sidebar-body::-webkit-scrollbar { width: 6px; }
    .info-sidebar-body::-webkit-scrollbar-track { background: #f1f1f1; }
    .info-sidebar-body::-webkit-scrollbar-thumb { background: #ccc; border-radius: 6px; }
    .info-sidebar-body::-webkit-scrollbar-thumb:hover { background: #aaa; }

    .info-sidebar-user {
    padding: 24px;
    text-align: center;
    border-bottom: 8px solid #f1f8e9; 
    }
    .info-sidebar-user img {
    width: 80px;
    height: 80px;
    border-radius: 50%;
    object-fit: cover;
    margin-bottom: 12px;
    border: 3px solid #fff;
    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }
    .info-sidebar-user h5 {
    font-weight: 700; /* Đậm hơn */
    font-size: 1.25rem;
    color: #388e3c; /* Màu xanh lá */
    margin-bottom: 0;
    }

       .info-accordion-card {
        border-bottom: 1px solid #e8f5e9; /* Viền xanh nhạt */
    }
    .info-accordion-card .card-header {
        background-color: transparent; /* Bỏ nền trắng */
        border-bottom: none;
        padding: 0;
    }
    .info-accordion-card .btn-link {
        width: 100%;
        text-align: left;
        padding: 16px 20px;
        font-weight: 600;
        color: #444; /* Đổi màu chữ (không dùng màu xanh dương) */
        text-decoration: none;
        transition: background-color 0.2s;
    }
    .info-accordion-card .btn-link:hover {
        background-color: #f1f8e9; /* Highlight khi hover */
    }
    .info-accordion-card .btn-link .fa-chevron-down {
        transition: transform 0.2s ease;
        color: #aaa;
    }
    .info-accordion-card .btn-link[aria-expanded="true"] .fa-chevron-down {
        transform: rotate(-180deg);
    }
    .info-accordion-card .card-body {
        padding: 0; /* Xóa padding cũ */
        max-height: 250px; 
        overflow-y: auto;
        background: #fff; 
    }
    .info-file-item {
        display: flex;
        align-items: center;
        padding: 12px 16px;
        border-bottom: 1px solid #f1f8e9;
        transition: background-color 0.2s;
        text-decoration: none !important;
        color: #333;
    }
    .
    .info-file-item:hover {
        background-color: #f8f9fa;
    }
    .info-file-item .file-icon {
        font-size: 1.5rem;
        color: #007bff; /* Màu Word */
        width: 30px;
        text-align: center;
        margin-right: 12px;
    }
    .info-file-item .file-info {
        overflow: hidden; /* Ngăn tên file dài phá vỡ layout */
    }
    .info-file-item .file-name {
        font-weight: 500;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis; /* Dấu ... nếu tên quá dài */
    }
    .info-file-item .file-meta {
        font-size: 0.8rem;
        color: #6c757d;
    }

    #info-sidebar-images-list {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(80px, 1fr)); /* Tăng cỡ ảnh */
        gap: 8px;
        padding: 16px; 
    }
    .info-image-item {
        width: 100%;
        padding-bottom: 100%; /* Tạo box vuông */
        position: relative;
        border-radius: 8px;
        overflow: hidden;
        background: #eee;
    }
    .info-image-item img {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        object-fit: cover;
        cursor: pointer;
    }
        .info-image-item img:hover {
        transform: scale(1.05);
    }
    #info-sidebar-files-list {
        padding: 8px 0; 
    }
        #collapseSecurity .list-group-item-action {
        color: #333; /* Màu chữ thường */
        font-weight: 500;
        padding: 14px 20px;
        border: 0;
        background: #fff; /* Nền trắng */
        border-bottom: 1px solid #f1f8e9;
    }
    #collapseSecurity .list-group-item-action:last-child {
        border-bottom: 0;
    }
    #collapseSecurity .list-group-item-action:hover {
        background-color: #f8f9fa;
    }
    #collapseSecurity .list-group-item-action i {
        width: 20px;
        text-align: center;
        margin-right: 12px;
        color: #666;
    }
    #collapseSecurity .list-group-item-action.text-danger {
        color: #dc3545 !important;
    }
    #collapseSecurity .list-group-item-action.text-danger i {
        color: #dc3545 !important;
    }
    .input-area {
        display: flex;
        padding: 10px;
        border-top: 1px solid #ddd;
        align-items: center;
    }

        .input-area #messageInput {
            flex-grow: 1;
            border-radius: 20px;
            border: 1px solid #ccc;
            padding: 5px 15px;
            outline: none;
        }

        .input-area #sendButton {
            margin-left: 10px;
            border: none;
            background: none;
            color: #007bff;
            font-size: 1.5rem;
        }

    .message {
        margin-bottom: 15px;
    }

        .message strong {
            display: block;
            color: #555;
        }

    .btn-light {
        background-color: transparent;
        border: none;
        font-size: 1.2rem;
        color: #555;
    }

    #toggle-conversations-btn {
        border: none;
        background: transparent;
        color: #2e7d32;
        font-size: 1.3rem;
        border-radius: 10px;
        transition: all 0.2s ease-in-out;
    }

        #toggle-conversations-btn:hover {
            background-color: #e8f5e9;
            color: #1b5e20;
        }

    .msg-img, .msg-video {
        border-radius: 10px;
        margin: 5px 0;
        display: block;
    }
    .chat-bubble .call-back-btn {
        background-color: #f0f2f5;
        border: none;
        font-weight: 600;
        color: #333;
        padding: 6px 12px;
    }

        .chat-bubble .call-back-btn:hover {
            background-color: #e4e6eb;
        }

    /* Nút gọi lại trong bubble của chính mình (self) */
    .chat-message.self .chat-bubble .call-back-btn {
        background-color: rgba(255, 255, 255, 0.2);
        color: white;
    }

        .chat-message.self .chat-bubble .call-back-btn:hover {
            background-color: rgba(255, 255, 255, 0.3);
        }

    /* Tinh chỉnh bubble call-log một chút */
    .chat-message.other .chat-bubble:has(.call-back-btn) {
        background: #f0f0f0 !important;
    }
    /* ========================================================
       PHẦN AI WELCOME & HEADER (Giữ nguyên)
    =========================================================== */
    #ai-welcome-screen {
        flex-grow: 1;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        background-color: #f8f9fa;
        color: #333;
        padding: 20px;
        overflow-y: auto; /* Cho phép cuộn nếu không đủ chỗ */
    }

    .ai-logo-circle {
        width: 80px;
        height: 80px;
        border-radius: 50%;
        background: linear-gradient(135deg, #007bff, #8a2be2);
        margin-bottom: 20px;
        animation: pulse-glow 2s infinite ease-in-out;
    }

    @@keyframes pulse-glow {
        0% {
            transform: scale(1);
            box-shadow: 0 0 10px rgba(0, 123, 255, 0.4);
        }

        50% {
            transform: scale(1.05);
            box-shadow: 0 0 20px rgba(138, 43, 226, 0.7);
        }

        100% {
            transform: scale(1);
            box-shadow: 0 0 10px rgba(0, 123, 255, 0.4);
        }
    }

    #ai-welcome-screen h3 {
        font-size: 1.5rem;
        font-weight: 600;
    }

    #ai-welcome-screen p {
        font-size: 1rem;
        color: #6c757d;
        margin-bottom: 25px;
    }

    .ai-prompt-suggestions {
        display: flex;
        flex-direction: column;
        gap: 10px;
        width: 100%;
        max-width: 400px;
    }

    .ai-prompt-btn {
        background-color: #fff;
        border: 1px solid #ddd;
        border-radius: 12px;
        padding: 12px 15px;
        text-align: left;
        font-size: 0.95rem;
        cursor: pointer;
        transition: background-color 0.2s;
    }

        .ai-prompt-btn:hover {
            background-color: #f1f1f1;
        }

    #ai-chat-header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        background: linear-gradient(90deg, #43A047 0%, #26C6DA 50%, #81C784 100%);
        color: white;
        border-bottom: 1px solid rgba(255,255,255,0.2);
        min-height: 60px;
        box-shadow: 0 2px 10px rgba(67, 160, 71, 0.3);
    }

        #ai-chat-header .ai-title {
            font-size: 1.1rem;
            flex-grow: 1;
            justify-content: center;
        }

        #ai-chat-header .btn-link {
            color: white !important;
            opacity: 0.8;
            transition: opacity 0.2s;
        }

            #ai-chat-header .btn-link:hover {
                opacity: 1;
                background: rgba(255,255,255,0.2);
                border-radius: 50%;
            }

    #chat-timestamp-bar {
        font-size: 0.8rem;
        color: #666;
        border-top: 1px solid #eee;
    }

    #ai-chat-header ~ .input-area #messageInput {
        background: #f0f2f5;
        border-radius: 20px;
        padding: 8px 16px;
        border: none;
    }

        #ai-chat-header ~ .input-area #messageInput::placeholder {
            color: #999;
            font-style: italic;
        }
    .chat-message {
        display: flex !important;
        align-items: flex-end !important; /* Căn avatar và bubble theo đáy */
        margin-bottom: 15px !important;
        width: 100% !important;
        position: relative;
        gap: 8px; /* Tạo khoảng cách chung cho 2 bên */
    }

        .chat-message.other,
        .chat-message.ai-message {
            justify-content: flex-start !important; /* Căn trái */
        }

            .chat-message.other .avatar,
            .chat-message.ai-message .avatar {
                flex-shrink: 0;
                /* margin-right: 8px; (Đã dùng gap) */
                order: 1; /* Avatar trước */
                background: #43a047;
                color: #fff;
                font-weight: 600;
                border-radius: 50%;
                width: 36px;
                height: 36px;
                display: flex;
                justify-content: center;
                align-items: center;
                font-size: 0.95rem;
                box-shadow: 0 2px 4px rgba(67, 160, 71, 0.3);
            }

            .chat-message.other .chat-bubble,
            .chat-message.ai-message .chat-bubble {
                margin-right: auto;
                order: 2; /* Bubble sau avatar */
            }

        .chat-message.self {
            justify-content: flex-end !important; /* Căn phải */
        }

            .chat-message.self .chat-bubble {
                order: 1; /* Bubble trước */
            }

            .chat-message.self .avatar {
                display: none !important; /* Ẩn avatar của mình */
            }

    .message-timestamp {
        display: none !important;
    }
        .custom-toggle-switch {
        position: relative;
        display: inline-block;
        width: 50px; 
        height: 28px; 
    }
    .custom-toggle-switch input { 
        opacity: 0; 
        width: 0; 
        height: 0; 
    }
    .slider {
        position: absolute;
        cursor: pointer;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background-color: #ccc;
        transition: .4s;
    }
    .slider:before {
        position: absolute;
        content: "";
        height: 20px; /* Kích thước chấm tròn */
        width: 20px;
        left: 4px;
        bottom: 4px;
        background-color: white;
        transition: .4s;
    }
    input:checked + .slider {
        background-color: #43a047; /* Màu xanh lá cây chủ đạo */
    }
    input:checked + .slider:before {
        /* Độ dịch chuyển = width - (2 * left) - width(chấm) = 50 - 8 - 20 = 22 */
        transform: translateX(22px); 
    }
    .slider.round {
        border-radius: 28px;
    }
    .slider.round:before {
        border-radius: 50%;
    }
    /* Icon cho các mục bảo mật */
    #collapseSecurity .list-group-item i {
        width: 20px;
        text-align: center;
        margin-right: 12px;
        color: #666;
    }
    #collapseSecurity .list-group-item.text-danger i {
         color: #dc3545 !important;
    }
    /* Gán order CỤ THỂ (thứ tự) */
    .chat-message.other .message-timestamp,
    .chat-message.ai-message .message-timestamp {
        color: rgba(26,35,126,0.5) !important;
    }

    .chat-message.self .message-timestamp {
        color: rgba(255,255,255,0.8) !important;
    }


    .chat-bubble {
        display: flex; /* xếp theo cột */
        flex-direction: column;
        gap: 6px; /* khoảng cách text ↔ time */
        padding: 10px 15px; /* Thêm đệm (padding) cho đẹp */
        border-radius: 18px; /* Bo góc chung cho tất cả bubble */
        max-width: 70%; /* Giới hạn độ rộng tối đa */
    }

    .bubble-time {
        align-self: flex-end; /* dồn về góc phải đáy bubble */
        font-size: .72rem;
        line-height: 1;
        opacity: .75;
        margin-top: 2px;
    }

    .chat-message.other .bubble-time,
    .chat-message.ai-message .bubble-time {
        color: rgba(0,0,0,.45);
    }

    .chat-message.self .bubble-time {
        color: rgba(255,255,255,.85);
    }

    .chat-bubble img, .chat-bubble video {
        margin-bottom: 2px;
    }
    .chat-message.other .chat-bubble {
        background: #e4e6eb !important;
        color: #333 !important;
        border-bottom-left-radius: 4px !important; /* Thêm !important */
    }

    /* Bubble của AI (đè lên bubble .other) */
    .chat-message.ai-message .chat-bubble.ai-bubble {
        background: linear-gradient(135deg, #e3f2fd 0%, #f3e5f5 100%) !important;
        color: #1a237e !important;
        border-radius: 18px 18px 18px 4px !important;
        padding: 12px 16px !important;
        max-width: 70% !important;
        box-shadow: 0 4px 12px rgba(138, 43, 226, 0.15) !important;
        margin-left: 0 !important;
    }

    .chat-message.self .chat-bubble {
        background: #007bff !important;
        color: white !important;
        border-bottom-right-radius: 4px !important; /* Thêm !important */
    }

    /* 7. MEDIA TRONG BUBBLE */
    .chat-bubble img,
    .chat-bubble video {
        border-radius: 12px;
        margin-top: 4px;
        max-width: 100%;
        transition: transform 0.2s ease;
    }

        .chat-bubble img:hover {
            transform: scale(1.02);
        }

    .chat-bubble .timestamp {
        display: none !important;
    }
    #search-sidebar {
        width: 320px;
        height: 100%;
        flex-shrink: 0;
        background: #fafffe;
        border-left: 1px solid #e8f5e9;
        display: flex;
        flex-direction: column;
        transition: all 0.3s ease;
    }

    /* Header của Sidebar */
    .search-sidebar-header {
        padding: 0 15px;
        border-bottom: 1px solid #e8f5e9;
        min-height: 66px;
        display: flex;
        justify-content: space-between;
        align-items: center;
        flex-shrink: 0;
    }

        .search-sidebar-header h5 {
            margin: 0;
            font-weight: 700;
            color: #2e7d32;
        }

        .search-sidebar-header .close {
            font-size: 1.5rem;
            font-weight: 600;
            color: #aaa;
            opacity: 1;
            text-shadow: none;
            background: #f1f8e9;
            border-radius: 50%;
            width: 32px;
            height: 32px;
            line-height: 32px;
            padding: 0;
            transition: all 0.2s;
        }

            .search-sidebar-header .close:hover {
                background-color: #e8f5e9;
                color: #333;
            }

    /* Body của Sidebar */
    .search-sidebar-body {
        flex-grow: 1;
        overflow-y: auto;
        overflow-x: hidden;
    }

        .search-sidebar-body::-webkit-scrollbar {
            width: 6px;
        }

        .search-sidebar-body::-webkit-scrollbar-track {
            background: #f1f1f1;
        }

        .search-sidebar-body::-webkit-scrollbar-thumb {
            background: #ccc;
            border-radius: 6px;
        }

    /* Ô tìm kiếm */
    .search-input-wrapper {
        position: relative;
        padding: 15px;
        border-bottom: 8px solid #f1f8e9;
    }

        .search-input-wrapper .search-icon {
            position: absolute;
            left: 28px;
            top: 50%;
            transform: translateY(-50%);
            color: #999;
        }

    #search-input {
        width: 100%;
        padding: 10px 15px 10px 40px; /* Thêm padding trái cho icon */
        border-radius: 20px;
        border: 2px solid #e8f5e9;
        background: #fff;
        outline: none;
    }

        #search-input:focus {
            border-color: #43a047;
            box-shadow: 0 0 0 3px rgba(67, 160, 71, 0.2);
        }

    /* Màn hình chào */
    #search-welcome {
        padding: 40px 20px;
        text-align: center;
        color: #6c757d;
    }

    .search-welcome-icon {
        font-size: 4rem;
        color: #e0e0e0;
        margin-bottom: 20px;
    }

    /* Danh sách kết quả */
    #search-results-list {
        padding: 8px 0;
    }

    .search-result-item {
        padding: 12px 16px;
        display: flex;
        align-items: flex-start;
        border-bottom: 1px solid #f1f8e9;
        cursor: pointer;
        transition: background-color 0.2s;
    }

        .search-result-item:hover {
            background-color: #f1f8e9;
        }

    .search-result-avatar {
        width: 32px;
        height: 32px;
        border-radius: 50%;
        object-fit: cover;
        margin-right: 12px;
        flex-shrink: 0;
    }

    .search-result-content {
        overflow: hidden;
    }

    .search-result-sender {
        font-weight: 600;
        color: #333;
        font-size: 0.9rem;
    }

    .search-result-time {
        font-size: 0.75rem;
        color: #999;
        margin-left: 8px;
    }

    .search-result-text {
        font-size: 0.9rem;
        color: #555;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
    }
        .search-result-text .highlight {
            background-color: #fffb8f;
            font-weight: 600;
        }
    #call-controls .btn-light {
        background-color: rgba(255, 255, 255, 0.2);
        color: white;
        border: none;
        backdrop-filter: blur(10px);
        transition: background-color 0.2s;
    }

        #call-controls .btn-light:hover {
            background-color: rgba(255, 255, 255, 0.4);
        }

    #call-controls .btn-danger {
        transition: transform 0.2s;
    }

        #call-controls .btn-danger:hover {
            transform: scale(1.1);
        }

    #remoteVideo[srcObject] ~ #call-info-overlay {
        display: none;
    }
</style>
<div class="chat-view-wrapper">
    <div class="chat-main">
        <!-- Header Container - FIX: Đặt ở đầu để luôn top -->
        <div id="chat-header-container">
            <!-- Private Header (giữ nguyên) -->
            <div id="private-chat-header" class="chat-header" style="display: none;">
                <div id="user-chat-header" class="chat-header-info d-flex align-items-center">
                    <img id="chat-header-avatar" src="" alt="Avatar" class="chat-header-avatar me-2" />
                    <div>
                        <div id="chat-header-displayname" class="fw-bold"></div>
                        <div id="chat-header-status" class="text-muted">Đang hoạt động</div>
                    </div>
                </div>
                <div class="d-flex align-items-center">
                    <div id="user-chat-buttons" style="display: none;">
                        <button class="btn btn-light" title="Thêm vào nhóm (làm sau)">
                            <i class="fas fa-user-plus"></i>
                        </button>
                        <button id="start-voice-call-btn" class="btn btn-light" title="Gọi thoại">
                            <i class="fas fa-phone-alt"></i>
                        </button>
                        <button id="start-video-call-btn" class="btn btn-light" title="Gọi video">
                            <i class="fas fa-video"></i>
                        </button>
                        <button id="toggle-search-sidebar-btn" class="btn btn-light" title="Tìm kiếm">
                            <i class="fas fa-search"></i>
                        </button>
                        <button id="toggle-info-sidebar-btn" class="btn btn-light" title="Thông tin hội thoại">
                            <i class="fas fa-info-circle"></i>
                        </button>
                    </div>
                    <button id="toggle-conversations-btn" class="btn btn-light" title="Ẩn/Hiện danh sách bạn bè">
                        <i class="fas fa-list-ul"></i>
                    </button>
                </div>
            </div>
            <div id="ai-chat-header" class="ai-header px-3 py-2" style="display: none;">
                <!-- Icon quay lại -->
                <button id="ai-back-btn" class="btn btn-link text-white p-1" title="Quay lại danh sách">
                    <i class="fas fa-chevron-left fs-4"></i>
                </button>
                <!-- Tên AI -->
                <div class="ai-title text-white fw-bold d-flex align-items-center gap-1">
                    <span>Chat AI</span>
                    <i class="fas fa-check-circle text-success" title="Verified"></i>
                </div>
                <!-- Icon info -->
                <button id="ai-info-btn" class="btn btn-link text-white p-1" title="Thông tin AI">
                    <i class="fas fa-info-circle fs-5"></i>
                </button>
            </div>
        </div>
        <!-- AI Welcome Screen - FIX: Sau header để header luôn top -->
        <div id="ai-welcome-screen" style="display: none;">
            <div class="ai-logo-circle"></div>
            <h3>Bắt đầu chat với AI</h3>
            <p>Hỏi tôi bất cứ điều gì bạn muốn</p>
            <div class="ai-prompt-suggestions">
                <button class="ai-prompt-btn" data-prompt="AI có sở trường gì?">AI có sở trường gì?</button>
                <button class="ai-prompt-btn" data-prompt="Nghĩ ra một ý tưởng sản phẩm thú vị">Nghĩ ra một ý tưởng sản phẩm thú vị</button>
                <button class="ai-prompt-btn" data-prompt="Giúp tôi khám phá ngôn ngữ tình yêu">Giúp tôi khám phá ngôn ngữ tình yêu</button>
            </div>
        </div>
        <!-- Message Area -->
        <div class="message-area" id="messagesList"></div>
        <!-- File Inputs (giữ nguyên) -->
        <input type="file" id="imageUploadInput" accept="image/*" multiple style="display: none;" />
        <input type="file" id="fileUploadInput" multiple style="display: none;" />
        <!-- Input Area -->
        <div class="input-area">
            <button id="emoji-button" class="btn btn-light" type="button" title="Biểu cảm">
                <i class="fas fa-smile"></i>
            </button>
            <button id="quick-image-btn" class="btn btn-light" type="button" title="Gửi ảnh nhanh">
                <i class="fas fa-image"></i>
            </button>
            <button id="toggle-attach-menu" class="btn btn-light" type="button" title="Đính kèm khác">
                <i class="fas fa-paperclip"></i>
            </button>
            <input type="text" id="messageInput" placeholder="Nhập tin nhắn..." autocomplete="off" />
            <button id="sendButton"><i class="fas fa-paper-plane"></i></button>
        </div>
    </div>
    <!-- Modal Preview (giữ nguyên) -->
    <div class="modal fade" id="imagePreviewModal" tabindex="-1" role="dialog" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Xem trước ảnh</h5>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
                </div>
                <div class="modal-body text-center" id="imagePreviewContainer"
                     style="display: flex; flex-wrap: wrap; gap: 10px; justify-content: center;">
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-dismiss="modal">Hủy</button>
                    <button type="button" class="btn btn-primary" id="sendImageButton">Gửi</button>
                </div>
            </div>
        </div>
    </div>
    <div class="modal fade" id="partnerProfileModal" tabindex="-1" role="dialog" aria-labelledby="partnerProfileModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered" role="document" style="max-width: 420px;">
            <div class="modal-content" style="border-radius: 20px; overflow: hidden; background: #fff; border: none; box-shadow: 0 8px 32px rgba(0,0,0,0.12);">

                <div id="partner-modal-cover" style="height: 160px; background-size: cover; background-position: center; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); position: relative;">
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close"
                            style="position: absolute; top: 15px; right: 15px; color: #fff; background: rgba(0,0,0,0.3); backdrop-filter: blur(10px); border-radius: 50%; width: 36px; height: 36px; border: none; font-size: 1.3rem; opacity: 1; text-shadow: none; display: flex; align-items: center; justify-content: center; transition: all 0.2s; cursor: pointer;">
                        <span aria-hidden="true" style="line-height: 1;">&times;</span>
                    </button>
                </div>

                <div style="text-align: center; margin-top: -50px; position: relative; z-index: 10;">
                    <img id="partner-modal-avatar" src="/Content/default-avatar.png"
                         style="width: 100px; height: 100px; border-radius: 50%; border: 5px solid #fff; background-color: #fff; object-fit: cover; box-shadow: 0 4px 12px rgba(0,0,0,0.15);" />
                </div>

                <div class="modal-body" style="padding: 20px 30px 30px; text-align: center;">
                    <h3 id="partner-modal-display-name" style="font-weight: 700; color: #1a1a1a; margin-bottom: 5px; font-size: 1.5rem;">Đang tải...</h3>
                    <p id="partner-modal-username" style="color: #8e8e93; font-size: 0.95rem; margin-bottom: 24px;"></p>

                    <div style="text-align: left; background: #f8f9fa; padding: 20px; border-radius: 12px; margin-bottom: 24px;">
                        <h5 style="font-weight: 600; margin-bottom: 16px; color: #1a1a1a; font-size: 1rem;">
                            <i class="fas fa-user-circle" style="color: #667eea; margin-right: 8px;"></i>
                            Thông tin cá nhân
                        </h5>

                        <div style="display: flex; align-items: center; margin-bottom: 12px; padding: 10px; background: white; border-radius: 8px;">
                            <div style="width: 40px; height: 40px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border-radius: 10px; display: flex; align-items: center; justify-content: center; margin-right: 12px; flex-shrink: 0;">
                                <i class="fas fa-venus-mars" style="color: white; font-size: 1.1rem;"></i>
                            </div>
                            <div style="flex: 1;">
                                <div style="font-size: 0.8rem; color: #8e8e93; margin-bottom: 2px;">Giới tính</div>
                                <strong id="partner-modal-gender" style="color: #1a1a1a; font-size: 0.95rem;"></strong>
                            </div>
                        </div>

                        <div style="display: flex; align-items: center; margin-bottom: 12px; padding: 10px; background: white; border-radius: 8px;">
                            <div style="width: 40px; height: 40px; background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); border-radius: 10px; display: flex; align-items: center; justify-content: center; margin-right: 12px; flex-shrink: 0;">
                                <i class="fas fa-birthday-cake" style="color: white; font-size: 1.1rem;"></i>
                            </div>
                            <div style="flex: 1;">
                                <div style="font-size: 0.8rem; color: #8e8e93; margin-bottom: 2px;">Ngày sinh</div>
                                <strong id="partner-modal-dob" style="color: #1a1a1a; font-size: 0.95rem;"></strong>
                            </div>
                        </div>

                        <div style="display: flex; align-items: center; margin-bottom: 12px; padding: 10px; background: white; border-radius: 8px;">
                            <div style="width: 40px; height: 40px; background: linear-gradient(135deg, #28a745 0%, #218838 100%); border-radius: 10px; display: flex; align-items: center; justify-content: center; margin-right: 12px; flex-shrink: 0;">
                                <i class="fas fa-phone-alt" style="color: white; font-size: 1.1rem;"></i>
                            </div>
                            <div style="flex: 1;">
                                <div style="font-size: 0.8rem; color: #8e8e93; margin-bottom: 2px;">Điện thoại</div>
                                <strong id="partner-modal-phone" style="color: #1a1a1a; font-size: 0.95rem;"></strong>
                            </div>
                        </div>

                        <div style="display: flex; align-items: center; padding: 10px; background: white; border-radius: 8px;">
                            <div style="width: 40px; height: 40px; background: linear-gradient(135deg, #007bff 0%, #0056b3 100%); border-radius: 10px; display: flex; align-items: center; justify-content: center; margin-right: 12px; flex-shrink: 0;">
                                <i class="fas fa-envelope" style="color: white; font-size: 1.1rem;"></i>
                            </div>
                            <div style="flex: 1;">
                                <div style="font-size: 0.8rem; color: #8e8e93; margin-bottom: 2px;">Email</div>
                                <strong id="partner-modal-email" style="color: #1a1a1a; font-size: 0.95rem;"></strong>
                            </div>
                        </div>
                    </div>

                    <div style="text-align: left; background: #f8f9fa; padding: 20px; border-radius: 12px; margin-bottom: 24px;">
                        <h5 style="font-weight: 600; margin-bottom: 12px; color: #1a1a1a; font-size: 1rem;">
                            <i class="fas fa-book-open" style="color: #fd7e14; margin-right: 8px;"></i>
                            Tiểu sử
                        </h5>
                        <p id="partner-modal-bio" style="color: #333; font-size: 0.95rem; white-space: pre-wrap; word-wrap: break-word;"></p>
                    </div>

                    <div id="partner-action-list" class="list-group" style="text-align: left;">
                        <a href="#" id="partner-action-block" class="list-group-item list-group-item-action" style="color: #6c757d; font-weight: 500; border: none; background: transparent; padding-left: 0;">
                            <i class="fas fa-ban" style="margin-right: 10px; width: 20px;"></i> Chặn tin nhắn và cuộc gọi
                        </a>
                        <a href="#" id="partner-action-report" class="list-group-item list-group-item-action" style="color: #dc3545; font-weight: 500; border: none; background: transparent; padding-left: 0;">
                            <i class="fas fa-exclamation-triangle" style="margin-right: 10px; width: 20px;"></i> Báo xấu
                        </a>

                        <form id="partner-unfriend-form" method="post" action="@Url.Action("DeclineOrRemoveFriend", "Friend")" style="margin:0; display: none;">
                            @Html.AntiForgeryToken()
                            <input type="hidden" name="friendshipId" id="partner-unfriend-id" />
                            <button type="submit" id="partner-action-unfriend" class="list-group-item list-group-item-action" style="color: #dc3545; font-weight: 500; border: none; background: transparent; padding-left: 0; width: 100%; text-align: left;">
                                <i class="fas fa-trash-alt" style="margin-right: 10px; width: 20px;"></i> Xóa khỏi danh sách bạn bè
                            </button>
                        </form>
                    </div>

                </div>
            </div>
        </div>
    </div>
    <div id="conversation-info-sidebar" style="display: none;">
        <div class="info-sidebar-header">
            <h5>Thông tin hội thoại</h5>
            <button id="close-info-sidebar-btn" type="button" class="close" aria-label="Close">
                <span aria-hidden="true">&times;</span>
            </button>
        </div>

        <div class="info-sidebar-body">

            <div class="info-sidebar-user">
                <img id="info-sidebar-avatar" src="/Content/default-avatar.png" />
                <h5 id="info-sidebar-displayname">Đang tải...</h5>
            </div>

            <div class="accordion" id="infoAccordion">

                <div class="info-accordion-card">
                    <div class="card-header" id="headingImages">
                        <button class="btn btn-link btn-block text-left" type="button" data-toggle="collapse" data-target="#collapseSecurity" aria-expanded="true" aria-controls="collapseSecurity">
                            Ảnh/Video
                            <i class="fas fa-chevron-down float-right"></i>
                        </button>
                    </div>
                    <div id="collapseImages" class="collapse show" aria-labelledby="headingImages" data-parent="#infoAccordion">
                        <div class="card-body" id="info-sidebar-images-list">
                            <p class="text-muted text-center small p-3">Chưa có ảnh/video nào.</p>
                        </div>
                    </div>
                </div>

                <div class="info-accordion-card">
                    <div class="card-header" id="headingFiles">
                        <button class="btn btn-link btn-block text-left collapsed" type="button" data-toggle="collapse" data-target="#collapseFiles" aria-expanded="false" aria-controls="collapseFiles">
                            File
                            <i class="fas fa-chevron-down float-right"></i>
                        </button>
                    </div>
                    <div id="collapseFiles" class="collapse" aria-labelledby="headingFiles" data-parent="#infoAccordion">
                        <div class="card-body" id="info-sidebar-files-list">
                            <p class="text-muted text-center small p-3">Chưa có file nào.</p>
                        </div>
                    </div>
                </div>

                <div class="info-accordion-card">
                    <div class="card-header" id="headingLinks">
                        <button class="btn btn-link btn-block text-left collapsed" type="button" data-toggle="collapse" data-target="#collapseLinks" aria-expanded="false" aria-controls="collapseLinks">
                            Link
                            <i class="fas fa-chevron-down float-right"></i>
                        </button>
                    </div>
                    <div id="collapseLinks" class="collapse" aria-labelledby="headingLinks" data-parent="#infoAccordion">
                        <div class="card-body">
                            <p class="text-muted text-center small p-3">Chưa có link nào.</p>
                        </div>
                    </div>
                </div>

                <div class="info-accordion-card">
                    <div class="card-header" id="headingSecurity">
                        <button class="btn btn-link btn-block text-left collapsed" type="button" data-toggle="collapse" data-target="#collapseSecurity" aria-expanded="false" aria-controls="collapseSecurity">
                            Thiết lập bảo mật
                            <i class="fas fa-chevron-down float-right"></i>
                        </button>
                    </div>
                    <div id="collapseSecurity" class="collapse show" aria-labelledby="headingSecurity" data-parent="#infoAccordion">

                        <div class="card-body list-group list-group-flush" style="padding: 0;">

                            <div class="list-group-item d-flex justify-content-between align-items-center" style="border:none; background: #fff; padding: 14px 20px;">
                                <span>
                                    <i class="fas fa-eye-slash"></i> Ẩn trò chuyện
                                </span>
                                <label class="custom-toggle-switch">
                                    <input type="checkbox" id="info-action-hide-chat">
                                    <span class="slider round"></span>
                                </label>
                            </div>

                            <a href="#" class="list-group-item list-group-item-action text-danger" id="info-action-report">
                                <i class="fas fa-exclamation-triangle"></i> Báo xấu
                            </a>

                            <a href="#" class="list-group-item list-group-item-action text-danger" id="info-action-clear-history">
                                <i class="fas fa-trash-alt"></i> Xóa lịch sử trò chuyện
                            </a>

                        </div>
                    </div>
                </div>

            </div>
        </div>
    </div>
    <div id="search-sidebar" style="display: none;">
        <div class="search-sidebar-header">
            <h5>Tìm kiếm trong trò chuyện</h5>
            <button id="close-search-sidebar-btn" type="button" class="close" aria-label="Close">
                <span aria-hidden="true">&times;</span>
            </button>
        </div>

        <div class="search-sidebar-body">

            <div class="search-input-wrapper">
                <i class="fas fa-search search-icon"></i>
                <input type="text" id="search-input" placeholder="Nhập từ khóa để tìm kiếm" autocomplete="off" />
            </div>

            <div id="search-welcome">
                <div class="search-welcome-icon">
                    <i class="fas fa-search"></i>
                </div>
                <p>Hãy nhập từ khóa để bắt đầu tìm kiếm tin nhắn trong hội thoại này.</p>
            </div>

            <div id="search-results-list" style="display: none;">
            </div>

        </div>
    </div>
    <div class="modal fade" id="incomingCallModal" tabindex="-1" role="dialog" data-backdrop="static" data-keyboard="false">
        <div class="modal-dialog modal-sm modal-dialog-centered" role="document">
            <div class="modal-content" style="border-radius: 12px; box-shadow: 0 5px 20px rgba(0,0,0,0.2);">
                <div class="modal-body text-center p-4">
                    <h5 class="mb-2">Cuộc gọi đến</h5>
                    <img id="incoming-call-avatar" src="/Content/default-avatar.png"
                         style="width: 70px; height: 70px; border-radius: 50%; object-fit: cover; margin-bottom: 10px;" />
                    <h4 id="incoming-call-name" style="font-weight: 600;">...</h4>
                    <p id="incoming-call-type" class="text-muted small">Đang gọi video...</p>
                    <div class="d-flex justify-content-around mt-4">
                        <button id="decline-call-btn" type="button" class="btn btn-danger btn-lg"
                                style="border-radius: 50%; width: 60px; height: 60px; font-size: 1.5rem;">
                            <i class="fas fa-times"></i>
                        </button>
                        <button id="accept-call-btn" type="button" class="btn btn-success btn-lg"
                                style="border-radius: 50%; width: 60px; height: 60px; font-size: 1.5rem;">
                            <i class="fas fa-check"></i>
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div id="call-view" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: #222; z-index: 2000; color: white;">

        <video id="remoteVideo" autoplay playsinline style="width: 100%; height: 100%; object-fit: cover;"></video>

        <video id="localVideo" autoplay playsinline muted style="position: absolute; top: 20px; right: 20px; width: 25%; max-width: 300px; border-radius: 10px; border: 2px solid white;"></video>

        <div id="call-info-overlay" class="text-center" style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);">
            <img id="call-view-avatar" src="/Content/default-avatar.png" style="width: 120px; height: 120px; border-radius: 50%; object-fit: cover; margin-bottom: 20px;" />
            <h2 id="call-view-name">Đang gọi...</h2>
            <p id="call-view-status" class="text-muted">Đang kết nối...</p>
            <p class_small" style="opacity: 0.7;"><i class="fas fa-lock"></i> Được mã hóa đầu cuối</p>
        </div>

        <div id="call-controls" style="position: absolute; bottom: 40px; left: 50%; transform: translateX(-50%); display: flex; gap: 20px;">
            <button id="toggle-video-btn" class="btn btn-light btn-lg" style="border-radius: 50%; width: 60px; height: 60px; font-size: 1.5rem;"><i class="fas fa-video"></i></button>
            <button id="toggle-mic-btn" class="btn btn-light btn-lg" style="border-radius: 50%; width: 60px; height: 60px; font-size: 1.5rem;"><i class="fas fa-microphone"></i></button>
            <button id="hang-up-btn" class="btn btn-danger btn-lg" style="border-radius: 50%; width: 60px; height: 60px; font-size: 1.5rem;"><i class="fas fa-phone-slash"></i></button>
        </div>
    </div>
</div>
    @section scripts {
        <script>
    $(function () {
        window.chatHub = $.connection.chatHub;
        window.currentChat = { mode: 'ai', partnerUsername: null };
        const chatHub = window.chatHub;
        const currentUsername = @Html.Raw(Json.Encode(User.Identity.Name));
        const antiForgeryToken = $('#logoutForm input[name="__RequestVerificationToken"]').val();
        let currentChat = window.currentChat;
        let aiChatHistory = [];
        if ('@User.Identity.IsAuthenticated' !== 'True') {
            return;
        }
        // Upload Configuration (giữ nguyên)
        const uploadUrl = '@Url.Action("UploadFiles", "Chat")';
        const $menu = $('#attachment-menu');
        const $toggleBtn = $('#toggle-attach-menu');
        // Attachment Menu Toggle (giữ nguyên)
        $toggleBtn.on('click', function (e) {
            e.stopPropagation();
            const btnRect = $toggleBtn[0].getBoundingClientRect();
            $menu.css({
                display: 'block',
                bottom: (window.innerHeight - btnRect.top) + 'px',
                left: (btnRect.left) + 'px'
            });
        });
        $(window).on('click', function () {
            $menu.css('display', 'none');
        });
        $('#send-image-btn').on('click', function (e) {
            e.preventDefault();
            $menu.css('display', 'none');
            $('#imageUploadInput').click();
        });
        $('#send-file-btn').on('click', function (e) {
            e.preventDefault();
            $menu.css('display', 'none');
            $('#fileUploadInput').click();
        });
        // File Upload Preview (giữ nguyên)
        $('#imageUploadInput, #fileUploadInput').on("change", function () {
            const files = this.files;
            const container = $("#imagePreviewContainer");
            container.empty();
            if (files.length > 0) {
                Array.from(files).forEach(file => {
                    const reader = new FileReader();
                    reader.onload = function (e) {
                        let preview;
                        if (file.type.startsWith("image/")) {
                            preview = `<img src="${e.target.result}" class="img-fluid rounded" style="width:120px;height:120px;object-fit:cover;">`;
                        } else if (file.type.startsWith("video/")) {
                            preview = `<video src="${e.target.result}" controls style="width:120px;height:120px;"></video>`;
                        } else {
                            preview = `<div style="width:120px;height:120px;border:1px solid #ccc;display:flex;align-items:center;justify-content:center;">📄 ${file.name}</div>`;
                        }
                        container.append(preview);
                    };
                    reader.readAsDataURL(file);
                });
                $("#imagePreviewModal").modal("show");
            }
            $(this).val(null);
        });
        // Send Files (giữ nguyên)
        $("#sendImageButton").click(function () {
            const imageFiles = $("#imageUploadInput")[0].files;
            const otherFiles = $("#fileUploadInput")[0].files;
            let filesToUpload = (imageFiles.length > 0) ? imageFiles : otherFiles;
            if (filesToUpload.length === 0) return;
            const formData = new FormData();
            for (let i = 0; i < filesToUpload.length; i++) {
                formData.append("file" + i, filesToUpload[i]);
            }
            $.ajax({
                url: uploadUrl,
                type: "POST",
                data: formData,
                processData: false,
                contentType: false,
                success: function (res) {
                    if (res.success) {
                        res.urls.forEach(url => {
                            const ext = url.split(".").pop().toLowerCase();
                            let type = "file";
                            if (["jpg", "jpeg", "png", "gif"].includes(ext)) type = "image";
                            else if (["mp4", "mov", "webm"].includes(ext)) type = "video";
                            const msgJson = JSON.stringify({ type, content: url });
                            if (window.currentChat.mode === "private") {
                                window.chatHub.server.sendPrivateMessage(window.currentChat.partnerUsername, msgJson);
                            } else if (window.currentChat.mode === "ai") {
                                window.chatHub.server.sendMessageToAI(`[${type}] ${url}`);
                            }
                        });
                    } else {
                        alert("Lỗi upload: " + res.message);
                    }
                },
                complete: function () {
                    $("#imagePreviewModal").modal("hide");
                    $("#imageUploadInput").val(null);
                    $("#fileUploadInput").val(null);
                }
            });
        });
        $('body').on('click', '#user-chat-header', function () {
            // Chỉ thực thi nếu đang chat private và có username
            if (window.currentChat.mode === 'private' && window.currentChat.partnerUsername) {

                const partnerUsername = window.currentChat.partnerUsername;

                // Hiển thị trạng thái "Đang tải..."
                $('#partner-modal-display-name').text('Đang tải...');
                $('#partner-modal-username').text('');
                $('#partner-modal-avatar').attr('src', '/Content/default-avatar.png');
                $('#partner-modal-cover').css('background-image', 'url()');
                $('#partner-modal-cover').css('background-color', '#e0e0e0');

                // Set text "Đang tải..." cho các trường mới
                $('#partner-modal-gender').text('Đang tải...');
                $('#partner-modal-dob').text('Đang tải...');
                $('#partner-modal-phone').text('Đang tải...');
                $('#partner-modal-email').text('Đang tải...');
                $('#partner-modal-bio').text('Đang tải...');

                // Ẩn nút xóa bạn
                $('#partner-unfriend-form').hide();

                $('#partnerProfileModal').modal('show');

                // Gọi AJAX để lấy thông tin
                $.getJSON(`/Profile/GetUserPublicProfile?username=${partnerUsername}`, function (response) {
                    if (response.success && response.user) {
                        const user = response.user;

                        // Cập nhật thông tin lên modal
                        $('#partner-modal-display-name').text(user.DisplayName || 'Không có tên');
                        $('#partner-modal-username').text(`@@${user.Username}`);

                        const avatarUrl = user.AvatarUrl ? user.AvatarUrl : '/Content/default-avatar.png';
                        $('#partner-modal-avatar').attr('src', avatarUrl);

                        if (user.CoverUrl) {
                            $('#partner-modal-cover').css('background-image', `url(${user.CoverUrl})`);
                        }

                        $('#partner-modal-gender').text(user.Gender || 'Chưa cập nhật');
                        $('#partner-modal-phone').text(user.PhoneNumber || 'Chưa cập nhật'); // Đã mask từ C#
                        $('#partner-modal-email').text(user.Email || 'Chưa cập nhật'); // Đã mask từ C#
                        $('#partner-modal-bio').text(user.Bio || 'Không có tiểu sử.');

                        // Format ngày sinh (chỉ hiển thị nếu có)
                        if (user.DateOfBirth) {
                            try {
                                const dob = new Date(user.DateOfBirth); // Parse chuỗi ISO
                                const day = dob.getDate();
                                const month = dob.getMonth() + 1; // JS month 0-11
                                const year = dob.getFullYear();

                                $('#partner-modal-dob').text(`${day} tháng ${month < 10 ? '0' + month : month}, ${year}`);
                            } catch (e) {
                                $('#partner-modal-dob').text('Chưa cập nhật');
                            }
                        } else {
                            $('#partner-modal-dob').text('Chưa cập nhật');
                        }

                        if (user.FriendshipId) {
                            $('#partner-unfriend-id').val(user.FriendshipId);
                            $('#partner-unfriend-form').show();
                        } else {
                            $('#partner-unfriend-form').hide();
                        }

                    } else {
                        // Xử lý lỗi
                        $('#partner-modal-display-name').text(response.message || 'Không tìm thấy người dùng');
                        setTimeout(function () {
                            $('#partnerProfileModal').modal('hide');
                        }, 2000);
                    }
                }).fail(function () {
                    // Xử lý lỗi AJAX
                    $('#partner-modal-display-name').text('Lỗi kết nối máy chủ');
                    setTimeout(function () {
                        $('#partnerProfileModal').modal('hide');
                    }, 2000);
                });
            }
        });
        // ========================================================
        // JS CHO SIDEBAR THÔNG TIN HỘI THOẠI
        // ========================================================

        $('body').on('click', '#toggle-info-sidebar-btn', function() {
            var $sidebar = $('#conversation-info-sidebar');
            var $button = $(this);

            // Toggle (đóng/mở)
            $sidebar.toggle();
            $button.toggleClass('active');

            if ($sidebar.is(':visible') && window.currentChat.mode === 'private') {
                loadConversationInfo(window.currentChat.partnerUsername);
            }
        });

        $('body').on('click', '#close-info-sidebar-btn', function() {
            $('#conversation-info-sidebar').hide();
            $('#toggle-info-sidebar-btn').removeClass('active');
        });

        function loadConversationInfo(partnerUsername) {
            // Cập nhật tên và avatar (lấy từ header có sẵn)
            var avatarSrc = $('#chat-header-avatar').attr('src');
            var displayName = $('#chat-header-displayname').text();
            $('#info-sidebar-avatar').attr('src', avatarSrc);
            $('#info-sidebar-displayname').text(displayName);

            var $filesList = $('#info-sidebar-files-list');
            var $imagesList = $('#info-sidebar-images-list');
            $filesList.html('<p class="text-muted text-center small p-3">Đang tải file...</p>');
            $imagesList.html('<p class="text-muted text-center small p-3">Đang tải ảnh...</p>');

            $.getJSON('@Url.Action("GetConversationInfo", "Chat")', { partnerUsername: partnerUsername }, function(data) {
                if (data.success) {

                    // Xử lý Ảnh/Video
                    if (data.images && data.images.length > 0) {
                        $imagesList.empty(); // Xóa "Đang tải..."
                        data.images.forEach(function(img) {
                            var imgHtml = `
                                <a href="${img.Url}" target="_blank" class="info-image-item">
                                    <img src="${img.Url}" alt="Ảnh" />
                                </a>`;
                            $imagesList.append(imgHtml);
                        });
                    } else {
                        $imagesList.html('<p class="text-muted text-center small p-3">Chưa có ảnh/video nào.</p>');
                    }

                    // Xử lý File
                    if (data.files && data.files.length > 0) {
                        $filesList.empty(); // Xóa "Đang tải..."
                        data.files.forEach(function(file) {
                            var fileHtml = `
                                <a href="${file.Url}" target="_blank" class="info-file-item">
                                    <i class="fas fa-file-word file-icon"></i>
                                    <div class="file-info">
                                        <div class="file-name" title="${file.FileName}">${file.FileName}</div>
                                        <div class="file-meta">${file.Timestamp}</div>
                                    </div>
                                </a>`;
                            $filesList.append(fileHtml);
                        });
                    } else {
                        $filesList.html('<p class="text-muted text-center small p-3">Chưa có file nào.</p>');
                    }
                }
            });
        }

        function getHiddenChats() {
            var hidden = localStorage.getItem('hiddenChats');
            return hidden ? JSON.parse(hidden) : [];
        }

        function setHiddenChats(chatsArray) {
            localStorage.setItem('hiddenChats', JSON.stringify(chatsArray));
        }

        function hideConversationInList(username, shouldHide) {
            var $friendItem = $('.conversation-list .friend-item[data-username="' + username + '"]');
            if (shouldHide) {
                $friendItem.hide();
            } else {
                $friendItem.show();
            }
        }
        $('body').on('submit', '#partner-unfriend-form', function (e) {
            const partnerName = $('#partner-modal-display-name').text();
            if (!confirm(`Bạn có chắc muốn xóa '${partnerName}' khỏi danh sách bạn bè? Thao tác này không thể hoàn tác.`)) {
                e.preventDefault();
            }
        });

        $('body').on('click', '#partner-action-block', function (e) {
            e.preventDefault();
            const partnerName = $('#partner-modal-display-name').text();
            alert(`Chức năng Chặn '${partnerName}' (Đang phát triển)`);
        });

        $('body').on('click', '#partner-action-report', function (e) {
            e.preventDefault();
            const partnerName = $('#partner-modal-display-name').text();
            alert(`Chức năng Báo xấu '${partnerName}' (Đang phát triển)`);
        });
        // Function update timestamp bar
        function updateTimestampBar() {
            const now = new Date();
            const vietTime = now.toLocaleDateString('vi-VN', {
                weekday: 'short',
                hour: '2-digit',
                minute: '2-digit'
            }).replace(' ', ' lúc ');
            $('#current-timestamp').text(vietTime);
        }
        function sendTextMessage(e) {
            if (e) e.preventDefault();
            const messageContent = $('#messageInput').val().trim();
            if (messageContent === '') return;

            // FIX TIMESTAMP: Format chuẩn
            const now = new Date();
            const vietTime = now.toLocaleTimeString('vi-VN', { hour: '2-digit', minute: '2-digit' });

            // FIX: Đưa vietTime VÀO TRONG bubble, dùng class 'bubble-time'
            const escapedContent = $('<div/>').text(messageContent).html();
            let selfMessageHtml = `
                <div class="chat-message self" data-timestamp="${now.toISOString()}">
                    <div class="chat-bubble">
                        <span>${escapedContent}</span>
                        <span class="bubble-time">${vietTime}</span>
                    </div>
                </div>`;

            const messagesList = $('#messagesList');
            messagesList.append(selfMessageHtml);
            messagesList.scrollTop(messagesList[0].scrollHeight);

            // Ẩn welcome & show area (giữ nguyên, nhưng force cho private)
            $('#ai-welcome-screen').hide();
            $('.message-area').show();
            if (currentChat.mode === 'ai') {
                $('.chat-header').hide();
                $('#user-chat-header').hide();
                $('#user-chat-buttons').hide();
            } else {
                $('#private-chat-header').show();  // FORCE HEADER PRIVATE NẾU MODE PRIVATE
            }

            // Gửi đến server
            if (currentChat.mode === 'ai') {
                console.log('Sending to AI:', messageContent);
                chatHub.server.sendMessageToAI(messageContent);
            } else if (currentChat.mode === 'private') {
                const msgJson = JSON.stringify({ type: "text", content: messageContent });
                chatHub.server.sendPrivateMessage(currentChat.partnerUsername, msgJson);
            }
            if (currentChat.mode === 'private') {
                localStorage.setItem('lastChatPartner', currentChat.partnerUsername);
            }
            $('#messageInput').val('').focus();
            // Update bar
            updateTimestampBar();
        }
        function switchChat(target) {
            $('#messagesList').empty();
            currentChat.mode = $(target).data('chat-mode');
            $('.conversation-list .list-group-item-action').removeClass('active');
            $(target).addClass('active');

            if (currentChat.mode === 'ai') {
                $('#ai-chat-header').show();
                $('#private-chat-header').hide();
                $('#chat-timestamp-bar').show();
                $('#messageInput').attr('placeholder', 'Hỏi tôi bất cứ điều gì...?');
                updateTimestampBar();
                $('#ai-welcome-screen').show();
                $('.message-area').hide();
                $('#info-action-hide-chat').prop('checked', false).prop('disabled', true);
                currentChat.partnerUsername = null;
            } else {  // Private mode
                $('#private-chat-header').show();  // HIỆN HEADER PRIVATE
                $('#ai-chat-header').hide();
                $('#chat-timestamp-bar').show();
                $('#messageInput').attr('placeholder', 'Nhập tin nhắn...');
                $('#user-chat-header').show();
                $('#user-chat-buttons').show();

                // Lấy partnerUsername TỪ target (quan trọng)
                currentChat.partnerUsername = $(target).data('username');

                const hiddenChats = getHiddenChats();
                if (hiddenChats.includes(currentChat.partnerUsername)) {
                    $('#info-action-hide-chat').prop('checked', true);
                } else {
                    $('#info-action-hide-chat').prop('checked', false);
                }
                $('#info-action-hide-chat').prop('disabled', false);

                // FORCE ẨN AI WELCOME & HIỆN MESSAGES
                $('#ai-welcome-screen').hide();
                $('.message-area').show();

                const displayName = $(target).find('strong').text().trim();
                const avatarSrc = $(target).data('avatar-url') || '/Content/default-avatar.png';
                $('#chat-header-displayname').text(displayName);  // TÊN USER KIA
                $('#chat-header-avatar').attr('src', avatarSrc);  // AVATAR USER KIA
                $('#chat-header-status').text('Đang hoạt động');

                // Join & load history
                if (chatHub.server.joinPrivateGroup) {
                    chatHub.server.joinPrivateGroup(currentChat.partnerUsername);
                }
                $.getJSON(`/Chat/GetChatHistory?partnerUsername=${currentChat.partnerUsername}`, function (response) {
                    if (response.success) {
                        $('#messagesList').empty();
                        response.messages.forEach(msg => {
                            const isSelf = msg.SenderUsername === currentUsername;
                            let firstLetter = isSelf ? '' : msg.SenderUsername.charAt(0).toUpperCase();

                            let vietTime;
                            try {
                                const msgDate = new Date(msg.Timestamp);
                                if (isNaN(msgDate.getTime())) {
                                    vietTime = 'Vừa xong';
                                } else {
                                    vietTime = msgDate.toLocaleTimeString('vi-VN', { hour: '2-digit', minute: '2-digit' });
                                }
                            } catch (e) {
                                vietTime = 'Lỗi thời gian';
                            }

                            // ==================================================
                            // ===== SỬA LỖI CODE '...' CỦA TÔI (switchChat) =====
                            // ==================================================
                            let messageContent = "";
                            let bubbleContentHtml = "";

                            try {
                                const contentObj = JSON.parse(msg.Content);
                                messageContent = contentObj.content;

                                if (contentObj.type === "image") {
                                    // VIẾT ĐẦY ĐỦ HTML (Không còn '...')
                                    bubbleContentHtml = `<img src="${messageContent}" class="img-fluid rounded" style="max-width: 250px; cursor: pointer;" onclick="window.open(this.src, '_blank');" />`;
                                } else if (contentObj.type === "video") {
                                    bubbleContentHtml = `<video controls src="${messageContent}" style="max-width: 300px; border-radius: 10px;"></video>`;
                                } else if (contentObj.type === "file") {
                                    bubbleContentHtml = `<a href="${messageContent}" target="_blank" style="color:#007bff; text-decoration:none;">📄 Tải file</a>`;

                                } else if (contentObj.type === "call_log") {
                                    bubbleContentHtml = createCallLogHtml(contentObj);

                                } else {
                                    const escapedContent = $('<div/>').text(messageContent).html();
                                    bubbleContentHtml = `<span>${escapedContent}</span>`;
                                }

                            } catch (e) {
                                const escapedContent = $('<div/>').text(msg.Content).html();
                                bubbleContentHtml = `<span>${escapedContent}</span>`;
                            }

                            const messageBodyHtml = `
                                <div class="chat-bubble">
                                    ${bubbleContentHtml}
                                    <span class="bubble-time">${vietTime}</span>
                                </div>`;

                            const messageHtml = `
                                <div class="chat-message ${isSelf ? 'self' : 'other'}" data-timestamp="${msg.Timestamp}">
                                    ${!isSelf ? `<div class="avatar" title="${msg.SenderUsername}">${firstLetter}</div>` : ''}
                                    ${messageBodyHtml}
                                </div>`;
                            $('#messagesList').append(messageHtml);
                        });
                        $('#messagesList').scrollTop($('#messagesList')[0].scrollHeight);
                    }
                });
            }
            if ($(window).width() < 768) {
                $('.conversation-list').hide();
            }
        }
        // Load Friends List (giữ nguyên)
        function loadFriendsList() {
            const container = $('#conversation-list-ul');
            container.find('.friend-item').remove();
            const hiddenChats = getHiddenChats();
            $.getJSON("@Url.Action("GetFriendsList", "Friend")", function (friends) {
                friends.forEach(function (friend) {
                    if (friend.Username === currentUsername) {
                        return;
                    }
                    const friendHtml = `
                    <a href="#" class="list-group-item list-group-item-action friend-item"
                       data-chat-mode="private"
                       data-username="${friend.Username}"
                       data-userid="${friend.Id}"
                       data-avatar-url="${friend.AvatarUrl || ''}">
                        <strong><i class="fas fa-user"></i> ${friend.DisplayName}</strong>
                    </a>`;
                    if (hiddenChats.includes(friend.Username)) {
                        hideConversationInList(friend.Username, true);
                    }
                    container.append(friendHtml);
                });
                const urlParams = new URLSearchParams(window.location.search);
                const friendUsername = urlParams.get('friendUsername');
                const lastPartner = localStorage.getItem('lastChatPartner');
                const targetUsername = friendUsername || lastPartner;
                let target;
                if (targetUsername) {
                    target = container.find(`.list-group-item-action[data-username='${targetUsername}']`);
                }
                if (!target || target.length === 0) {
                    target = $('#ai-chat-btn');
                }
                switchChat(target);
            });
        }
        if (chatHub && chatHub.client) {
            chatHub.client.receiveMessage = function (senderUsername, senderAvatar, messageJson, timestamp) {

                if (senderUsername === currentUsername) {
                    return;
                }

                if (senderUsername === 'AI Assistant') {
                    if (currentChat.mode === 'ai') {
                        $('#ai-welcome-screen').hide();
                        $('.message-area').show();

                        let msgObj;
                        try {
                            msgObj = JSON.parse(messageJson);
                        } catch (e) {
                            msgObj = { type: "text", content: messageJson };
                        }

                        const msgDate = timestamp ? new Date(timestamp) : new Date();
                        const vietTime = msgDate.toLocaleTimeString('vi-VN', { hour: '2-digit', minute: '2-digit' });

                        let bubbleHtml = "";
                        if (msgObj.type === "image") {
                            bubbleHtml = `<img src="${msgObj.content}" class="img-fluid rounded" style="max-width: 250px;" onclick="window.open(this.src, '_blank');" />`;
                        } else if (msgObj.type === "video") {
                            bubbleHtml = `<video controls src="${msgObj.content}" style="max-width: 300px; border-radius: 10px;"></video>`;
                        } else if (msgObj.type === "file") {
                            bubbleHtml = `
                            <a href="${msgObj.content}" target="_blank" style="display:flex; align-items:center; padding:8px 12px; background:#f0f0f0; border-radius:8px; text-decoration:none; color:#333;">
                                <i class="fas fa-file-alt" style="font-size:1.5rem; margin-right:10px; color:#007bff;"></i>
                                <div>
                                    <div style="font-weight:600; font-size:0.9rem;">${msgObj.fileName || 'File'}</div>
                                    <div style="font-size:0.75rem; color:#666;">${msgObj.fileSize || ''}</div>
                                </div>
                            </a>`;
                        }
                        else if (msgObj.type === "call_log") {
                            bubbleHtml = createCallLogHtml(msgObj);
                        }
                        else {
                            const escaped = $('<div/>').text(msgObj.content).html();
                            bubbleHtml = `<span>${escaped}</span>`;
                        }

                        const aiMessageHtml = `
                <div class="chat-message other ai-message" data-timestamp="${msgDate.toISOString()}">
                    <div class="avatar" title="AI Assistant">🤖</div>
                    <div class="chat-bubble ai-bubble">
                        ${bubbleHtml}
                        <span class="bubble-time">${vietTime}</span>
                    </div>
                </div>`;

                        $('#messagesList').append(aiMessageHtml);
                        $('#messagesList').scrollTop($('#messagesList')[0].scrollHeight);
                    }
                    return;
                }

                // ====== XỬ LÝ TIN NHẮN PRIVATE ======
                if (currentChat.mode !== 'private' || currentChat.partnerUsername !== senderUsername) {
                    console.log(`Received from ${senderUsername}, but not in that chat window.`);
                    return;
                }

                // Parse JSON message
                let msgObj;
                try {
                    msgObj = JSON.parse(messageJson);
                } catch (e) {
                    msgObj = { type: "text", content: messageJson };
                }

                const msgDate = timestamp ? new Date(timestamp) : new Date();
                const vietTime = msgDate.toLocaleTimeString('vi-VN', { hour: '2-digit', minute: '2-digit' });

                // Tạo HTML theo type
                let bubbleHtml = "";
                if (msgObj.type === "image") {
                    bubbleHtml = `<img src="${msgObj.content}" class="img-fluid rounded" style="max-width: 250px; cursor: pointer;" onclick="window.open(this.src, '_blank');" />`;
                } else if (msgObj.type === "video") {
                    bubbleHtml = `<video controls src="${msgObj.content}" style="max-width: 300px; border-radius: 10px;"></video>`;
                } else if (msgObj.type === "file") {
                    bubbleHtml = `
                    <a href="${msgObj.content}" target="_blank" style="display:flex; align-items:center; padding:8px 12px; background:#f0f0f0; border-radius:8px; text-decoration:none; color:#333;">
                        <i class="fas fa-file-alt" style="font-size:1.5rem; margin-right:10px; color:#007bff;"></i>
                        <div>
                            <div style="font-weight:600; font-size:0.9rem;">${msgObj.fileName || 'File'}</div>
                            <div style="font-size:0.75rem; color:#666;">${msgObj.fileSize || ''}</div>
                        </div>
                    </a>`;
                } else {
                    const escaped = $('<div/>').text(msgObj.content).html();
                    bubbleHtml = `<span>${escaped}</span>`;
                }

                const firstLetter = senderUsername.charAt(0).toUpperCase();
                const messageHtml = `
                <div class="chat-message other" data-timestamp="${msgDate.toISOString()}">
                    <div class="avatar" title="${senderUsername}">${firstLetter}</div>
                    <div class="chat-bubble">
                        ${bubbleHtml}
                        <span class="bubble-time">${vietTime}</span>
                    </div>
                </div>`;

                $('#messagesList').append(messageHtml);
                $('#messagesList').scrollTop($('#messagesList')[0].scrollHeight);
                updateTimestampBar();
            };
        }
        // ========================================================
        // TÌM KIẾM
        // ========================================================

        $('body').on('click', '#toggle-search-sidebar-btn', function () {
            // Đóng sidebar thông tin (nếu đang mở)
            $('#conversation-info-sidebar').hide();
            $('#toggle-info-sidebar-btn').removeClass('active');

            // Mở sidebar tìm kiếm
            $('#search-sidebar').show();
            $(this).addClass('active');
            $('#search-input').focus();
        });

        // 2. Nút đóng Sidebar (bên trong sidebar)
        $('body').on('click', '#close-search-sidebar-btn', function () {
            $('#search-sidebar').hide();
            $('#toggle-search-sidebar-btn').removeClass('active');

            // Khi đóng, xóa highlight và hiện lại tất cả tin nhắn
            $('#messagesList .chat-message').show();
            clearHighlights();
        });

        // 3. Hàm tìm kiếm khi gõ phím
        $('#search-input').on('keyup', function () {
            var searchTerm = $(this).val().toLowerCase().trim();
            var $resultsList = $('#search-results-list');
            var $welcomeScreen = $('#search-welcome');

            clearHighlights(); // Xóa highlight cũ
            $resultsList.empty(); // Xóa kết quả cũ

            if (searchTerm === "") {
                // Nếu không có từ khóa
                $welcomeScreen.show();
                $resultsList.hide();
                $('#messagesList .chat-message').show(); // Hiện lại tất cả
                return;
            }

            // Nếu có từ khóa
            $welcomeScreen.hide();
            $resultsList.show();

            var resultCount = 0;
            var partnerName = $('#chat-header-displayname').text();
            var partnerAvatar = $('#chat-header-avatar').attr('src');
            // Lấy avatar của user (từ _ChatLayout)
            var selfAvatar = $('#layout-user-avatar-img').attr('src') || '/Content/default-avatar.png';

            // Lặp qua tất cả tin nhắn trong cửa sổ chat
            $('#messagesList .chat-message').each(function () {
                var $message = $(this);
                var $bubble = $message.find('.chat-bubble span').first(); // Chỉ lấy span chứa text
                if ($bubble.length === 0) return; // Bỏ qua nếu là ảnh/video

                var messageText = $bubble.text().toLowerCase();

                if (messageText.includes(searchTerm)) {
                    // TÌM THẤY
                    resultCount++;
                    $message.show(); // Hiển thị tin nhắn

                    // Highlight từ khóa
                    var originalText = $bubble.text();
                    var highlightedText = originalText.replace(new RegExp(searchTerm, 'gi'), '<span class="highlight">$&</span>');
                    $bubble.html(highlightedText);

                    // Lấy thông tin để tạo kết quả
                    var senderName = $message.hasClass('self') ? "Bạn" : partnerName;
                    var senderAvatar = $message.hasClass('self') ? selfAvatar : partnerAvatar;
                    var timestamp = $message.data('timestamp'); // Lấy timestamp ta đã thêm
                    var timeText = $message.find('.bubble-time').text(); // Lấy "12:00"

                    // Tạo HTML cho kết quả
                    var resultHtml = `
                        <a href="#" class="search-result-item" data-scroll-to="${timestamp}">
                            <img src="${senderAvatar}" class="search-result-avatar" />
                            <div class="search-result-content">
                                <div>
                                    <span class="search-result-sender">${senderName}</span>
                                    <span class="search-result-time">${timeText}</span>
                                </div>
                                <div class="search-result-text">${$bubble.html()}</div>
                            </div>
                        </a>`;
                    $resultsList.append(resultHtml);

                } else {
                    // KHÔNG TÌM THẤY
                    $message.hide(); // Ẩn tin nhắn
                }
            });

            if (resultCount === 0) {
                $resultsList.html('<p class="text-muted text-center small p-3">Không tìm thấy kết quả nào.</p>');
            }
        });

        // 4. Hàm xóa highlight
        function clearHighlights() {
            $('#messagesList .chat-message').find('.highlight').each(function () {
                var $parent = $(this).parent();
                $parent.html($parent.text()); // Chuyển HTML (có span) về text
            });
        }

        $('#search-results-list').on('click', '.search-result-item', function (e) {
            e.preventDefault();
            var targetTimestamp = $(this).data('scroll-to');
            var $targetMessage = $(`#messagesList .chat-message[data-timestamp="${targetTimestamp}"]`);

            if ($targetMessage.length > 0) {
                // Cuộn đến tin nhắn và highlight nó
                $('#messagesList').scrollTop($('#messagesList').scrollTop() + $targetMessage.position().top - 50); // Cuộn

                // Nhấp nháy highlight
                $targetMessage.css('transition', 'background-color 0.2s');
                $targetMessage.css('background-color', '#fffb8f');
                setTimeout(function () {
                    $targetMessage.css('background-color', '');
                }, 1000);
            }
        });
        // Event Handlers
        $('.conversation-list').on('click', '.list-group-item-action', function (e) {
            e.preventDefault();
            switchChat(this);
        });
        $('body').off('click', '#sendButton').on('click', '#sendButton', function (e) {
            e.preventDefault();
            sendTextMessage(e);
        });
        $('body').off('keypress', '#messageInput').on('keypress', '#messageInput', function (e) {
            if (e.which === 13 && !e.shiftKey) {
                e.preventDefault();
                sendTextMessage(e);
            }
        });
        $('body').on('click', '#toggle-conversations-btn', function (e) {
            e.preventDefault();
            $('.conversation-list').toggle();
        });
        $('#quick-image-btn').on('click', function (e) {
            e.preventDefault();
            $('#imageUploadInput').click();
        });
        $('body').on('click', '.ai-prompt-btn', function () {
            const promptText = $(this).data('prompt');
            $('#messageInput').val(promptText);
            sendTextMessage(null);
        });
        // AI Back & Info
        $('#ai-back-btn').on('click', function() {
            $('.conversation-list').toggle();
        });
        $('#ai-info-btn').on('click', function() {
            alert('Info về Meta AI: Powered by Llama 4!');
        });
        $('body').on('change', '#info-action-hide-chat', function() {
            if (window.currentChat.mode !== 'private' || $(this).is(':disabled')) return;

            var isChecked = $(this).is(':checked');
            var partnerUsername = window.currentChat.partnerUsername;
            var hiddenChats = getHiddenChats();

            if (isChecked) {
                if (!hiddenChats.includes(partnerUsername)) {
                    hiddenChats.push(partnerUsername);
                }
                hideConversationInList(partnerUsername, true);
            } else {
                hiddenChats = hiddenChats.filter(u => u !== partnerUsername);
                hideConversationInList(partnerUsername, false);
            }
            setHiddenChats(hiddenChats);
        });

        $('body').on('click', '#info-action-report', function(e) {
            e.preventDefault();
            const partnerName = $('#info-sidebar-displayname').text();
            alert(`Chức năng Báo xấu '${partnerName}' (Đang phát triển)`);
        });

        $('body').on('click', '#info-action-clear-history', function(e) {
            e.preventDefault();
            if (window.currentChat.mode !== 'private') return;

            const partnerUsername = window.currentChat.partnerUsername;
            const partnerName = $('#info-sidebar-displayname').text();

            if (confirm(`Bạn có chắc muốn xóa TOÀN BỘ lịch sử trò chuyện với '${partnerName}'? Thao tác này không thể hoàn tác.`)) {

                $.ajax({
                    url: '@Url.Action("ClearHistory", "Chat")',
                    type: 'POST',
                    data: {
                        __RequestVerificationToken: antiForgeryToken,
                        partnerUsername: partnerUsername
                    },
                    success: function(response) {
                        if (response.success) {
                            $('#messagesList').empty();

                            if ($('#conversation-info-sidebar').is(':visible')) {
                                loadConversationInfo(partnerUsername);
                            }
                            alert('Đã xóa lịch sử trò chuyện.');
                        } else {
                            alert('Lỗi: ' + response.message);
                        }
                    },
                    error: function() {
                        alert('Lỗi kết nối máy chủ. Không thể xóa.');
                    }
                });
            }
        });
        // ========================================================
        // BIẾN TOÀN CỤC CHO WEB-RTC
        // ========================================================
        let localStream;
        let remoteStream;
        let peerConnection;
        let isCallInProgress = false;
        let currentCallPartner = null;
        let currentCallType = 'voice'; // 'voice' or 'video'
        let isMicOn = true;
        let isVideoOn = true;
        let callStartTime = null;

        // Cấu hình STUN Server (dùng của Google, miễn phí)
        const configuration = {
            'iceServers': [
                { 'urls': 'stun:stun.l.google.com:19302' }
            ]
        };

        // ========================================================
        // HÀM HELPER CHO WEB-RTC
        // ========================================================

        // 1. Hàm khởi tạo PeerConnection
        function createPeerConnection() {
            if (peerConnection) {
                peerConnection.close();
            }
            peerConnection = new RTCPeerConnection(configuration);

            // Thêm local stream vào connection
            if (localStream) {
                localStream.getTracks().forEach(track => {
                    peerConnection.addTrack(track, localStream);
                });
            }

            // A. Khi nhận được ICE candidate
            peerConnection.onicecandidate = (event) => {
                if (event.candidate && currentCallPartner) {
                    console.log('Sending ICE candidate to ' + currentCallPartner);
                    window.chatHub.server.sendIceCandidate(currentCallPartner, JSON.stringify(event.candidate));
                }
            };

            // B. Khi nhận được track (stream) từ người kia
            peerConnection.ontrack = (event) => {
                console.log('Received remote track');
                if (!remoteStream) {
                    remoteStream = new MediaStream();
                }

                event.streams[0].getTracks().forEach(track => {
                    remoteStream.addTrack(track);
                });

                $('#remoteVideo').get(0).srcObject = remoteStream;
                $('#call-info-overlay').hide(); // Ẩn avatar/tên
            };
        }

        // 2. Hàm lấy Camera/Mic
        async function startMedia(callType) {
            try {
                currentCallType = callType;
                const constraints = {
                    audio: true,
                    video: callType === 'video'
                };
                localStream = await navigator.mediaDevices.getUserMedia(constraints);
                $('#localVideo').get(0).srcObject = localStream;
                isVideoOn = callType === 'video';
                isMicOn = true;
            } catch (e) {
                console.error('Error getting user media!', e);
                alert('Không thể truy cập camera hoặc mic. Vui lòng cấp quyền.');
                throw e; // Dừng tiến trình gọi
            }
        }

        // 3. Hàm hiển thị giao diện gọi
        function showCallView(partnerUsername, callType) {
            isCallInProgress = true;
            currentCallPartner = partnerUsername;
            currentCallType = callType;

            // Cập nhật thông tin trên modal gọi
            const avatar = $(`.friend-item[data-username="${partnerUsername}"]`).data('avatar-url') || '/Content/default-avatar.png';
            const displayName = $(`.friend-item[data-username="${partnerUsername}"]`).find('strong').text().trim();

            $('#call-view-avatar').attr('src', avatar);
            $('#call-view-name').text(displayName);
            $('#call-view-status').text(callType === 'video' ? 'Cuộc gọi video' : 'Cuộc gọi thoại');

            $('#call-info-overlay').show();
            $('#remoteVideo').get(0).srcObject = null; // Reset video
            $('#localVideo').get(0).srcObject = localStream;

            // Ẩn/hiện nút video
            $('#toggle-video-btn').toggle(callType === 'video');
            $('body').on('click', '.call-back-btn', function () {
                if (window.currentChat.mode !== 'private' || !window.currentChat.partnerUsername) {
                    alert('Không thể gọi lại từ cửa sổ này.');
                    return;
                }
                const callType = $(this).data('call-type'); // 'voice' or 'video'
                startCall(callType);
            });

            // Reset icon nút
            $('#toggle-mic-btn').html('<i class="fas fa-microphone"></i>');
            $('#toggle-video-btn').html('<i class="fas fa-video"></i>');

            $('#call-view').show();
        }

        // 4. Hàm kết thúc cuộc gọi (dọn dẹp)
        function hangUp(isInitiator = false) {
  
            if (isInitiator && window.currentChat.mode === 'private' && currentCallPartner) {
                let status = 'missed'; // Mặc định là lỡ
                let durationSeconds = 0;

                if (callStartTime) { // Nếu cuộc gọi đã thực sự bắt đầu
                    const durationMs = new Date() - callStartTime;
                    durationSeconds = Math.round(durationMs / 1000);
                    status = 'completed'; // Đã hoàn thành
                }
                const logMessage = {
                    type: "call_log",
                    status: status,
                    duration: durationSeconds,
                    callType: currentCallType // 'voice' or 'video'
                };
                window.chatHub.server.sendPrivateMessage(currentCallPartner, JSON.stringify(logMessage));
            }

            if (peerConnection) {
                peerConnection.close();
                peerConnection = null;
            }
            if (localStream) {
                localStream.getTracks().forEach(track => track.stop());
                localStream = null;
            }
            if (remoteStream) {
                remoteStream.getTracks().forEach(track => track.stop());
                remoteStream = null;
            }

            $('#call-view').hide();
            $('#incomingCallModal').modal('hide');

            callStartTime = null;

            if (isCallInProgress && currentCallPartner && isInitiator) {
                window.chatHub.server.endCall(currentCallPartner);
            }

            isCallInProgress = false;
            currentCallPartner = null;
            console.log('Call ended.');
        }


        // ========================================================
        // LOGIC: BẮT ĐẦU CUỘC GỌI (CALLER)
        // ========================================================
        async function startCall(callType) {
            const partnerUsername = window.currentChat.partnerUsername;
            if (!partnerUsername) return alert('Lỗi: Không tìm thấy người nhận.');
            if (isCallInProgress) return alert('Đang trong một cuộc gọi khác.');

            console.log(`Starting ${callType} call with ${partnerUsername}`);
            currentCallPartner = partnerUsername;

            try {
                // 1. Lấy media
                await startMedia(callType);

                // 2. Hiển thị UI
                showCallView(partnerUsername, callType);
                $('#call-view-status').text('Đang gọi...');

                // 3. Tạo Peer Connection
                createPeerConnection();

                // 4. Tạo Offer
                const offer = await peerConnection.createOffer();
                await peerConnection.setLocalDescription(offer);

                // 5. Gửi Offer qua SignalR
                console.log('Sending call offer...');
                window.chatHub.server.sendCallOffer(partnerUsername, JSON.stringify(offer), callType);

            } catch (e) {
                console.error('Failed to start call', e);
                hangUp(); // Dọn dẹp nếu có lỗi
            }
        }

        // Gắn sự kiện vào nút bấm
        $('body').on('click', '#start-voice-call-btn', function () {
            startCall('voice');
        });
        $('body').on('click', '#start-video-call-btn', function () {
            startCall('video');
        });


        // ========================================================
        // LOGIC: NHẬN CUỘC GỌI (CALLEE) - TỪ SIGNALR
        // ========================================================
        $(function () {
            // ... (code chatHub.client của bạn) ...
            // Thêm các client receivers NÀY vào

            let pendingOffer = null;
            let pendingCaller = null;

            // 1. Nhận được Offer
            window.chatHub.client.receiveCallOffer = function (callerUsername, offerSdp, callType) {
                if (isCallInProgress) {
                    // Đang bận, tự động từ chối (hoặc báo bận)
                    // Tạm thời bỏ qua
                    console.log('Busy, ignoring incoming call from ' + callerUsername);
                    return;
                }

                console.log(`Incoming ${callType} call from ${callerUsername}`);
                pendingOffer = JSON.parse(offerSdp);
                pendingCaller = callerUsername;

                // Hiển thị modal
                const avatar = $(`.friend-item[data-username="${callerUsername}"]`).data('avatar-url') || '/Content/default-avatar.png';
                const displayName = $(`.friend-item[data-username="${callerUsername}"]`).find('strong').text().trim();

                $('#incoming-call-avatar').attr('src', avatar);
                $('#incoming-call-name').text(displayName);
                $('#incoming-call-type').text(callType === 'video' ? 'Đang gọi video...' : 'Đang gọi thoại...');

                $('#incomingCallModal').modal('show');
            };

            // 2. Nhận được Answer
            window.chatHub.client.receiveCallAnswer = async function (calleeUsername, answerSdp) {
                if (!peerConnection || !isCallInProgress) return;

                console.log('Received call answer from ' + calleeUsername);
                try {
                    const answer = JSON.parse(answerSdp);
                    await peerConnection.setRemoteDescription(new RTCSessionDescription(answer));

                    callStartTime = new Date(); // <-- THÊM DÒNG NÀY
                    $('#call-view-status').text('Đã kết nối');

                } catch (e) {
                    console.error('Error setting remote description', e);
                }
            };

            // 3. Nhận được ICE Candidate
            window.chatHub.client.receiveIceCandidate = async function (senderUsername, candidate) {
                if (!peerConnection) return;

                try {
                    const iceCandidate = JSON.parse(candidate);
                    await peerConnection.addIceCandidate(new RTCIceCandidate(iceCandidate));
                } catch (e) {
                    console.error('Error adding received ICE candidate', e);
                }
            };

            window.chatHub.client.callEnded = function (senderUsername) {
                console.log('Call ended by ' + senderUsername);
                hangUp(false); 
            };
            // ========================================================
            // HÀM RENDER TIN NHẮN CALL LOG
            // ========================================================
            function createCallLogHtml(contentObj) {
                let icon = '';
                let text = '';

                // Icon và chữ dựa trên trạng thái
                if (contentObj.status === 'completed') {
                    icon = contentObj.callType === 'video' ? 'fa-video' : 'fa-phone-alt';
                    let durationText = '0 giây';
                    if (contentObj.duration > 0) {
                        const minutes = Math.floor(contentObj.duration / 60);
                        const seconds = contentObj.duration % 60;
                        if (minutes > 0) {
                            durationText = `${minutes} phút ${seconds} giây`;
                        } else {
                            durationText = `${seconds} giây`;
                        }
                    }
                    text = `Cuộc gọi ${contentObj.callType === 'video' ? 'video' : 'thoại'} <br> <span style="font-size: 0.85rem; color: #6c757d;">${durationText}</span>`;

                } else { // missed, declined, etc.
                    icon = contentObj.callType === 'video' ? 'fa-video-slash' : 'fa-phone-slash';
                    text = `Đã bỏ lỡ cuộc gọi ${contentObj.callType === 'video' ? 'video' : 'thoại'}`;
                }

                // Nút gọi lại
                let callBackButton = `
                <button class="btn btn-light btn-sm mt-2 w-100 call-back-btn" 
                        data-call-type="${contentObj.callType}">
                    Gọi lại
                </button>`;

                        // Kết hợp HTML
                        return `
                <div style="display: flex; align-items: center; gap: 10px;">
                    <i class="fas ${icon}" style="font-size: 1.2rem; color: #555;"></i>
                    <div style="font-weight: 500;">
                        ${text}
                    </div>
                </div>
                ${callBackButton}
            `;
            }
            // ========================================================
            // LOGIC: CÁC NÚT BẤM TRONG MODAL
            // ========================================================

            // A. Chấp nhận cuộc gọi
            $('#accept-call-btn').on('click', async function () {
                if (!pendingOffer || !pendingCaller) return;

                console.log('Accepting call from ' + pendingCaller);
                $('#incomingCallModal').modal('hide');
                currentCallPartner = pendingCaller;

                try {
                    // 1. Lấy media
                    const callType = $('#incoming-call-type').text().includes('video') ? 'video' : 'voice';
                    await startMedia(callType);

                    // 2. Hiển thị UI
                    showCallView(pendingCaller, callType);
                    $('#call-view-status').text('Đang kết nối...');

                    callStartTime = new Date();

                    // 3. Tạo Peer Connection
                    createPeerConnection();

                    // 4. Set Remote Offer (từ người gọi)
                    await peerConnection.setRemoteDescription(new RTCSessionDescription(pendingOffer));

                    // 5. Tạo Answer
                    const answer = await peerConnection.createAnswer();
                    await peerConnection.setLocalDescription(answer);

                    // 6. Gửi Answer qua SignalR
                    console.log('Sending call answer to ' + pendingCaller);
                    window.chatHub.server.sendCallAnswer(pendingCaller, JSON.stringify(answer));

                    pendingOffer = null;
                    pendingCaller = null;

                } catch (e) {
                    console.error('Failed to accept call', e);
                    hangUp();
                }
            });

            // B. Từ chối cuộc gọi
            $('#decline-call-btn').on('click', function () {
                console.log('Declining call from ' + pendingCaller);
                if (pendingCaller) {
                    currentCallPartner = pendingCaller;
                    currentCallType = $('#incoming-call-type').text().includes('video') ? 'video' : 'voice';
                    hangUp(true);
                }
                $('#incomingCallModal').modal('hide');
                pendingOffer = null;
                pendingCaller = null;
            });

            // C. Dập máy
            $('#hang-up-btn').on('click', function () {
                hangUp(true);
            });

            // D. Tắt/Mở Mic
            $('#toggle-mic-btn').on('click', function () {
                if (!localStream) return;
                isMicOn = !isMicOn;
                localStream.getAudioTracks().forEach(track => {
                    track.enabled = isMicOn;
                });
                $(this).html(isMicOn ? '<i class="fas fa-microphone"></i>' : '<i class="fas fa-microphone-slash text-danger"></i>');
            });

            $('#toggle-video-btn').on('click', function () {
                if (!localStream || currentCallType !== 'video') return;
                isVideoOn = !isVideoOn;
                localStream.getVideoTracks().forEach(track => {
                    track.enabled = isVideoOn;
                });
                $(this).html(isVideoOn ? '<i class="fas fa-video"></i>' : '<i class="fas fa-video-slash text-danger"></i>');
            });

        }); 
        // ========================================================
        // CHỨC NĂNG UPLOAD ẢNH, VIDEO, FILE
        // ========================================================

        // ✅ 1. Xử lý khi chọn ảnh
        $('#imageUploadInput').off('change').on('change', function() {
            const files = this.files;
            if (files.length === 0) return;

            const container = $('#imagePreviewContainer');
            container.empty();

            Array.from(files).forEach(file => {
                const reader = new FileReader();
                reader.onload = function(e) {
                    const preview = `
                        <div style="position: relative; display: inline-block;">
                            <img src="${e.target.result}" class="img-fluid rounded" style="width:120px; height:120px; object-fit:cover;" />
                            <div style="position: absolute; bottom: 5px; right: 5px; background: rgba(0,0,0,0.6); color: white; padding: 2px 6px; border-radius: 4px; font-size: 0.75rem;">
                                ${(file.size / (1024 * 1024)).toFixed(1)} MB
                            </div>
                        </div>`;
                    container.append(preview);
                };
                reader.readAsDataURL(file);
            });

            $('#imagePreviewModal').modal('show');
        });

        // ✅ 2. Xử lý khi chọn file
        $('#fileUploadInput').off('change').on('change', function() {
            const files = this.files;
            if (files.length === 0) return;

            const container = $('#imagePreviewContainer');
            container.empty();

            Array.from(files).forEach(file => {
                const ext = file.name.split('.').pop().toLowerCase();
                let icon = '📄';
                if (['pdf'].includes(ext)) icon = '📕';
                else if (['doc', 'docx'].includes(ext)) icon = '📘';
                else if (['xls', 'xlsx'].includes(ext)) icon = '📗';
                else if (['zip', 'rar', '7z'].includes(ext)) icon = '📦';

                const preview = `
                    <div style="width:120px; height:120px; border:2px dashed #ccc; display:flex; flex-direction:column; align-items:center; justify-content:center; border-radius:8px; padding:10px; text-align:center;">
                        <div style="font-size: 2rem; margin-bottom: 8px;">${icon}</div>
                        <div style="font-size: 0.75rem; font-weight: 600; overflow: hidden; text-overflow: ellipsis; width: 100%;">${file.name}</div>
                        <div style="font-size: 0.7rem; color: #999; margin-top: 4px;">${(file.size / (1024 * 1024)).toFixed(1)} MB</div>
                    </div>`;
                container.append(preview);
            });

            $('#imagePreviewModal').modal('show');
        });

        $('#sendImageButton').off('click').on('click', function() {
        const imageFiles = $('#imageUploadInput')[0].files;
        const otherFiles = $('#fileUploadInput')[0].files;

        let filesToUpload = imageFiles.length > 0 ? imageFiles : otherFiles;
        if (filesToUpload.length === 0) {
            alert('Vui lòng chọn file để gửi.');
            return;
        }

        const formData = new FormData();
        for (let i = 0; i < filesToUpload.length; i++) {
            formData.append('file' + i, filesToUpload[i]);
        }

        $('#sendImageButton').prop('disabled', true).text('Đang gửi...');

        $.ajax({
            url: '@Url.Action("Multiple", "Upload")',
            type: 'POST',
            data: formData,
            processData: false,
            contentType: false,
            success: function(response) {
                if (response.success && response.files) {
                    response.files.forEach(fileData => {
                        const now = new Date();
                        const vietTime = now.toLocaleTimeString('vi-VN', { hour: '2-digit', minute: '2-digit' });

                        let bubbleContentHtml = "";

                        // Tạo HTML preview dựa vào type
                        if (fileData.type === "image") {
                            bubbleContentHtml = `<img src="${fileData.filePath}" class="img-fluid rounded" style="max-width: 250px; cursor: pointer;" onclick="window.open(this.src, '_blank');" />`;
                        } else if (fileData.type === "video") {
                            bubbleContentHtml = `<video controls src="${fileData.filePath}" style="max-width: 300px; border-radius: 10px;"></video>`;
                        } else if (fileData.type === "file") {
                            bubbleContentHtml = `
                                <a href="${fileData.filePath}" target="_blank" style="display:flex; align-items:center; padding:8px 12px; background:#f0f0f0; border-radius:8px; text-decoration:none; color:#333;">
                                    <i class="fas fa-file-alt" style="font-size:1.5rem; margin-right:10px; color:#007bff;"></i>
                                    <div>
                                        <div style="font-weight:600; font-size:0.9rem;">${fileData.fileName}</div>
                                        <div style="font-size:0.75rem; color:#666;">${fileData.fileSize}</div>
                                    </div>
                                </a>`;
                        }

                        // Hiển thị tin nhắn của mình ngay lập tức
                        const selfMessageHtml = `
                            <div class="chat-message self" data-timestamp="${now.toISOString()}">
                                <div class="chat-bubble">
                                    ${bubbleContentHtml}
                                    <span class="bubble-time">${vietTime}</span>
                                </div>
                            </div>`;

                        const messagesList = $('#messagesList');
                        messagesList.append(selfMessageHtml);
                        messagesList.scrollTop(messagesList[0].scrollHeight);

                        // Tạo tin nhắn JSON để gửi qua SignalR
                        const msgJson = JSON.stringify({
                            type: fileData.type,
                            content: fileData.filePath,
                            fileName: fileData.fileName || '',
                            fileSize: fileData.fileSize || ''
                        });

                        // Gửi tin nhắn qua SignalR
                        if (window.currentChat.mode === 'private') {
                            window.chatHub.server.sendPrivateMessage(window.currentChat.partnerUsername, msgJson);
                        } else if (window.currentChat.mode === 'ai') {
                            window.chatHub.server.sendMessageToAI(`[${fileData.type}] ${fileData.filePath}`);
                        }
                    });

                    // Đóng modal
                    $('#imagePreviewModal').modal('hide');
                    $('#imageUploadInput').val('');
                    $('#fileUploadInput').val('');

                    // ✅ Ẩn AI welcome nếu đang chat AI
                    if (window.currentChat.mode === 'ai') {
                        $('#ai-welcome-screen').hide();
                        $('.message-area').show();
                    }
                } else {
                    alert('Lỗi upload: ' + (response.message || 'Không rõ nguyên nhân'));
                }
            },
            error: function(xhr, status, error) {
                alert('Lỗi kết nối: ' + error);
            },
            complete: function() {
                $('#sendImageButton').prop('disabled', false).text('Gửi');
            }
        });
    });

        // ✅ 4. Nút gửi ảnh nhanh
        $('#quick-image-btn').off('click').on('click', function() {
            $('#imageUploadInput').click();
        });

        // ✅ 5. Menu đính kèm
        $('#toggle-attach-menu').off('click').on('click', function(e) {
            e.stopPropagation();

            // Tạo menu nếu chưa có
            if ($('#attachment-menu').length === 0) {
                const menuHtml = `
                    <div id="attachment-menu" style="display:none; position:fixed; background:white; border:1px solid #ddd; border-radius:8px; box-shadow:0 4px 12px rgba(0,0,0,0.15); padding:8px 0; z-index:1000; min-width:180px;">
                        <a href="#" id="send-image-btn" style="display:block; padding:10px 16px; color:#333; text-decoration:none; transition:background 0.2s;">
                            <i class="fas fa-image" style="width:20px; margin-right:8px; color:#007bff;"></i> Gửi ảnh
                        </a>
                        <a href="#" id="send-video-btn" style="display:block; padding:10px 16px; color:#333; text-decoration:none; transition:background 0.2s;">
                            <i class="fas fa-video" style="width:20px; margin-right:8px; color:#dc3545;"></i> Gửi video
                        </a>
                        <a href="#" id="send-file-btn" style="display:block; padding:10px 16px; color:#333; text-decoration:none; transition:background 0.2s;">
                            <i class="fas fa-file-alt" style="width:20px; margin-right:8px; color:#28a745;"></i> Gửi file
                        </a>
                    </div>`;
                $('body').append(menuHtml);

                // Style hover
                $('#attachment-menu a').hover(
                    function() { $(this).css('background', '#f8f9fa'); },
                    function() { $(this).css('background', 'transparent'); }
                );
            }

            // Hiển thị menu
            const btnRect = $(this)[0].getBoundingClientRect();
            $('#attachment-menu').css({
                display: 'block',
                bottom: (window.innerHeight - btnRect.top) + 'px',
                left: (btnRect.left) + 'px'
            });
        });

        // Đóng menu khi click ngoài
        $(document).off('click.attachMenu').on('click.attachMenu', function(e) {
            if (!$(e.target).closest('#toggle-attach-menu, #attachment-menu').length) {
                $('#attachment-menu').hide();
            }
        });

        // ✅ 6. Click vào các mục trong menu
        $('body').off('click', '#send-image-btn').on('click', '#send-image-btn', function(e) {
            e.preventDefault();
            $('#attachment-menu').hide();
            $('#imageUploadInput').attr('accept', 'image/*').click();
        });

        $('body').off('click', '#send-video-btn').on('click', '#send-video-btn', function(e) {
            e.preventDefault();
            $('#attachment-menu').hide();
            $('#imageUploadInput').attr('accept', 'video/*').click();
        });

        $('body').off('click', '#send-file-btn').on('click', '#send-file-btn', function(e) {
            e.preventDefault();
            $('#attachment-menu').hide();
            $('#fileUploadInput').attr('accept', '.pdf,.doc,.docx,.xls,.xlsx,.zip,.rar,.txt').click();
        });

        // ========================================================
        // EMOJI PICKER
        // ========================================================
        (function() {
            const $emojiBtn = $('#emoji-button');
            const $messageInput = $('#messageInput');

            if ($emojiBtn.length && $messageInput.length) {
                // Kiểm tra xem đã có emoji picker chưa
                if (typeof EmojiButton !== 'undefined') {
                    try {
                        const picker = new EmojiButton({
                            position: 'top-start',
                            autoHide: true,
                            theme: 'auto'
                        });

                        picker.on('emoji', selection => {
                            $messageInput.val($messageInput.val() + selection.emoji);
                            $messageInput.focus();
                        });

                        $emojiBtn.off('click.emoji').on('click.emoji', function(e) {
                            e.stopPropagation();
                            picker.togglePicker($emojiBtn[0]);
                        });
                    } catch (err) {
                        console.warn('Emoji Button library error:', err);
                        initSimpleEmojiPicker();
                    }
                } else {
                    // Fallback: Emoji picker đơn giản
                    initSimpleEmojiPicker();
                }
            }

            function initSimpleEmojiPicker() {
                $emojiBtn.off('click.emoji').on('click.emoji', function(e) {
                    e.stopPropagation();

                    if ($('#simple-emoji-picker').length === 0) {
                        const emojis = ['😀','😃','😄','😁','😆','😅','🤣','😂','😊','😇','🙂','🙃','😉','😌','😍','🥰','😘','😗','😙','😚','❤️','💕','💖','💗','👍','👎','👏','🙏','💪','🎉','🎊','🎁','🔥','⭐','✨','💯','✅','❌'];

                        const pickerHtml = `
                            <div id="simple-emoji-picker" style="display:none; position:fixed; background:white; border:1px solid #ddd; border-radius:12px; box-shadow:0 4px 16px rgba(0,0,0,0.2); padding:12px; z-index:1000; max-width:300px;">
                                <div style="display:grid; grid-template-columns:repeat(8, 1fr); gap:8px;">
                                    ${emojis.map(emoji => `<button class="emoji-btn" style="border:none; background:transparent; font-size:1.5rem; cursor:pointer; padding:4px; border-radius:4px; transition:background 0.2s;">${emoji}</button>`).join('')}
                                </div>
                            </div>`;
                        $('body').append(pickerHtml);

                        // Hover effect
                        $(document).on('mouseenter', '.emoji-btn', function() {
                            $(this).css('background', '#f0f0f0');
                        }).on('mouseleave', '.emoji-btn', function() {
                            $(this).css('background', 'transparent');
                        });

                        // Click emoji
                        $(document).on('click', '.emoji-btn', function() {
                            $messageInput.val($messageInput.val() + $(this).text());
                            $('#simple-emoji-picker').hide();
                            $messageInput.focus();
                        });
                    }

                    const btnRect = $emojiBtn[0].getBoundingClientRect();
                    $('#simple-emoji-picker').css({
                        bottom: (window.innerHeight - btnRect.top + 10) + 'px',
                        left: (btnRect.left) + 'px'
                    }).toggle();
                });

                // Đóng picker khi click ngoài
                $(document).off('click.emojiPicker').on('click.emojiPicker', function(e) {
                    if (!$(e.target).closest('#emoji-button, #simple-emoji-picker').length) {
                        $('#simple-emoji-picker').hide();
                    }
                });
            }
        })();

        // SignalR Start
        $.connection.hub.url = window.location.origin + "/signalr";
        $.connection.hub.qs = { "noCache": new Date().getTime() };
        $.connection.hub.transportConnectTimeout = 10000;
        $.connection.hub.keepAlive = 15000;
        $.connection.hub.reconnectDelay = 5000;
        $.connection.hub.start({ transport: ['webSockets', 'serverSentEvents', 'longPolling'] })
            .done(function () {
                console.log("✅ SignalR connected successfully");
                loadFriendsList();
            })
            .fail(function (err) {
                console.error("❌ SignalR connection failed:", err);
            });
    });
        </script>
    }
