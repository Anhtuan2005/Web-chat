
@model List<Online_chat.Models.Post>

@{
    ViewBag.Title = "B·∫£ng tin";
    Layout = "~/Views/Shared/_ChatLayout.cshtml";
    var currentUserId = ViewBag.CurrentUserId as int?;
    var currentUserAvatar = ViewBag.CurrentUserAvatar as string;
}

@section styles {
    <style>
        :root {
            --primary-color: #4CAF50;
            --primary-color-dark: #388E3C;
            --primary-color-light: #C8E6C9;
            --background-color: #f7f9f7;
            --surface-color: #ffffff;
            --text-color-primary: #1c1e21;
            --text-color-secondary: #65676b;
            --border-color: #e4e6eb;
            --border-radius-large: 16px;
            --border-radius-medium: 12px;
            --shadow-light: 0 2px 8px rgba(0, 0, 0, 0.07);
            --shadow-medium: 0 4px 16px rgba(0, 0, 0, 0.1);
        }

        body {
            background-color: var(--background-color) !important;
            font-family: 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
            color: var(--text-color-primary);
        }

        .feed-container {
            max-width: 680px;
            margin: 0 auto;
            padding: 20px 15px;
        }

        /*--- Header ---*/
        .feed-header {
            background: linear-gradient(135deg, var(--primary-color), var(--primary-color-dark));
            border-radius: var(--border-radius-large);
            padding: 24px;
            margin-bottom: 24px;
            box-shadow: var(--shadow-medium);
            text-align: center;
            color: white;
            position: relative;
        }

            .feed-header h2 {
                margin: 0;
                font-weight: 700;
                font-size: 26px;
                text-shadow: 0 1px 3px rgba(0,0,0,0.2);
            }

        /*--- Story ---*/
        .stories-container {
            background: var(--surface-color);
            border-radius: var(--border-radius-large);
            padding: 16px;
            margin-bottom: 24px;
            box-shadow: var(--shadow-light);
        }

        .stories-wrapper {
            display: flex;
            gap: 12px;
            overflow-x: auto;
            padding-bottom: 10px;
        }

            .stories-wrapper::-webkit-scrollbar {
                height: 5px;
            }

            .stories-wrapper::-webkit-scrollbar-track {
                background: #f1f1f1;
            }

            .stories-wrapper::-webkit-scrollbar-thumb {
                background: var(--primary-color-light);
                border-radius: 5px;
            }

                .stories-wrapper::-webkit-scrollbar-thumb:hover {
                    background: var(--primary-color);
                }

        .story-item {
            flex: 0 0 90px;
            text-align: center;
            cursor: pointer;
        }

            .story-item .story-avatar-wrapper {
                width: 70px;
                height: 70px;
                border-radius: 50%;
                padding: 3px;
                border: 2px solid var(--primary-color);
                margin: 0 auto 8px;
                transition: transform 0.2s ease;
                position: relative;
            }

            .story-item:hover .story-avatar-wrapper {
                transform: scale(1.05);
            }

            .story-item .story-avatar {
                width: 100%;
                height: 100%;
                border-radius: 50%;
                object-fit: cover;
                border: 2px solid var(--surface-color);
            }

            .story-item .story-name {
                font-size: 13px;
                font-weight: 500;
                color: var(--text-color-primary);
                white-space: nowrap;
                overflow: hidden;
                text-overflow: ellipsis;
            }

            .story-item.create-story .story-create-avatar {
                border: 2px solid var(--border-color);
            }

            .story-item.create-story .story-avatar {
                opacity: 1;
            }

            .story-item.create-story .story-plus-icon {
                position: absolute;
                bottom: -2px;
                right: -2px;
                width: 28px;
                height: 28px;
                background: var(--primary-color);
                border-radius: 50%;
                display: flex;
                align-items: center;
                justify-content: center;
                border: 3px solid var(--surface-color);
                color: white;
                font-size: 14px;
                box-shadow: 0 2px 4px rgba(0,0,0,0.2);
            }

            .story-item.create-story .story-name {
                color: var(--text-color-primary);
                font-weight: 600;
            }

        /*--- Create Post ---*/
        .create-post-card {
            background: var(--surface-color);
            border-radius: var(--border-radius-large);
            padding: 16px;
            margin-bottom: 24px;
            box-shadow: var(--shadow-light);
        }

        .create-post-top {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .create-post-avatar {
            width: 44px;
            height: 44px;
            border-radius: 50%;
            object-fit: cover;
        }

        .create-post-input {
            flex-grow: 1;
            background-color: var(--background-color);
            border: 1px solid var(--border-color);
            border-radius: 22px;
            padding: 10px 18px;
            color: var(--text-color-secondary);
            cursor: pointer;
            text-decoration: none;
            transition: background-color 0.2s ease;
        }

            .create-post-input:hover {
                background-color: #e9ebee;
                text-decoration: none;
            }

        .create-post-actions {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 8px;
            padding-top: 12px;
            border-top: 1px solid var(--border-color);
            margin-top: 12px;
        }

        .create-action-btn {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            padding: 8px;
            border-radius: var(--border-radius-medium);
            font-weight: 600;
            color: var(--text-color-secondary);
            transition: background-color 0.2s ease;
            text-decoration: none;
        }

            .create-action-btn:hover {
                background-color: var(--background-color);
                text-decoration: none;
            }

            .create-action-btn i {
                font-size: 20px;
            }

            .create-action-btn .event {
                color: #f7b928;
            }

            .create-action-btn .photo {
                color: #45bd62;
            }

            .create-action-btn .feeling {
                color: #f8c848;
            }

        /*--- Post Card ---*/
        .post-card {
            background: var(--surface-color);
            border-radius: var(--border-radius-large);
            box-shadow: var(--shadow-light);
            margin-bottom: 24px;
        }

        .post-header {
            display: flex;
            align-items: center;
            padding: 12px 16px;
            gap: 10px;
        }

        .post-avatar {
            width: 44px;
            height: 44px;
            border-radius: 50%;
            object-fit: cover;
        }

        .post-user-info {
            flex-grow: 1;
        }

            .post-user-info strong {
                font-size: 15px;
                font-weight: 600;
                color: var(--text-color-primary);
            }

            .post-user-info small {
                font-size: 13px;
                color: var(--text-color-secondary);
            }

        .post-menu .dropdown-toggle {
            background: transparent;
            border: none;
            color: var(--text-color-secondary);
            padding: 5px;
        }

            .post-menu .dropdown-toggle::after {
                display: none;
            }

        .post-menu .dropdown-menu {
            border-radius: var(--border-radius-medium);
            box-shadow: var(--shadow-medium);
            border: 1px solid var(--border-color);
            padding: 8px 0;
        }

        .post-menu .dropdown-item {
            font-size: 14px;
            padding: 8px 16px;
            color: var(--text-color-primary);
        }

            .post-menu .dropdown-item:hover {
                background-color: var(--background-color);
            }




        .post-body {
            padding: 0 16px 12px 16px;
        }

        .post-content-text {
            color: var(--text-color-primary);
            line-height: 1.6;
            margin-bottom: 12px;
            word-wrap: break-word;
        }

        .post-media {
            border-radius: var(--border-radius-medium);
            max-width: 100%;
            display: block;
            margin-top: 12px;
        }

        .post-stats {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 16px;
            color: var(--text-color-secondary);
            font-size: 14px;
        }

            .post-stats .likes-count i {
                color: #e74c3c;
                margin-right: 4px;
            }

        .post-actions {
            display: flex;
            justify-content: space-around;
            padding: 4px 8px;
            border-top: 1px solid var(--border-color);
        }

            .post-actions .btn {
                flex: 1;
                gap: 6px;
                font-weight: 600;
                color: var(--text-color-secondary);
                border-radius: var(--border-radius-medium);
                display: flex;
                align-items: center;
                justify-content: center;
            }

                .post-actions .btn:hover {
                    background-color: var(--background-color);
                }

                .post-actions .btn.liked {
                    color: #e74c3c;
                }

        /*--- Comments ---*/
        .post-comments {
            padding: 8px 16px 16px;
            background-color: #f7f9f7;
            border-bottom-left-radius: var(--border-radius-large);
            border-bottom-right-radius: var(--border-radius-large);
            display: none;
        }

            .post-comments.active {
                display: block;
            }

        .comment-list {
            margin-bottom: 12px;
        }

        .comment-item {
            display: flex;
            gap: 10px;
            margin-top: 12px;
            position: relative;
        }

        .comment-avatar {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            object-fit: cover;
        }

        .comment-content {
            background: #e9ebee;
            border-radius: 18px;
            padding: 8px 12px;
            font-size: 14px;
            flex-grow: 1;
        }

            .comment-content strong {
                font-size: 13px;
                font-weight: 600;
                display: block;
            }

        .delete-comment-btn {
            display: none;
            position: absolute;
            right: 0;
            top: 50%;
            transform: translateY(-50%);
            background: #f0f2f5;
            border-radius: 50%;
            border: none;
            width: 28px;
            height: 28px;
            color: var(--text-color-secondary);
            cursor: pointer;
        }

        .comment-item:hover .delete-comment-btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
        }

        .comment-add-form {
            display: flex;
            gap: 10px;
            align-items: center;
            padding-top: 12px;
            border-top: 1px solid var(--border-color);
        }

            .comment-add-form .comment-avatar {
                width: 32px;
                height: 32px;
            }

            .comment-add-form .form-control {
                flex-grow: 1;
                border: 1px solid #ced4da;
                border-radius: 18px;
                height: 36px;
            }

                .comment-add-form .form-control:focus {
                    border-color: var(--primary-color);
                    box-shadow: 0 0 0 3px rgba(76, 175, 80, 0.2);
                }

        /*--- General/Utility ---*/
        .alert-info {
            background-color: var(--surface-color);
            border-radius: var(--border-radius-large);
            padding: 24px;
            text-align: center;
            color: var(--text-color-secondary);
            border: 1px dashed var(--border-color);
        }

        #loading-more {
            text-align: center;
            padding: 16px;
            color: var(--primary-color);
        }

            #loading-more i {
                animation: spin 1s linear infinite;
            }

        @@keyframes spin {
            to {
                transform: rotate(360deg);
            }
        }

        .gallery-modal {
            display: none;
            position: fixed;
            z-index: 9999; /* Lu√¥n n·∫±m tr√™n c√πng */
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: hidden;
            background-color: rgba(0, 0, 0, 0.92); /* M√†u ƒëen th·∫´m nh∆∞ FB */
            align-items: center;
            justify-content: center;
            flex-direction: column;
        }
        /* ·∫¢nh trong Lightbox */
        .gallery-content {
            margin: auto;
            display: block;
            max-width: 90%;
            max-height: 90vh;
            border-radius: 4px;
            transition: opacity 0.2s;
            object-fit: contain;
            box-shadow: 0 0 20px rgba(0,0,0,0.5);
        }

        /* N√∫t Close (X) */
        .close-gallery {
            position: absolute;
            top: 15px;
            right: 35px;
            color: #f1f1f1;
            font-size: 40px;
            font-weight: bold;
            transition: 0.3s;
            cursor: pointer;
            z-index: 10001;
        }

            .close-gallery:hover {
                color: #bbb;
            }

        /* N√∫t Next/Prev */
        .prev-btn, .next-btn {
            cursor: pointer;
            position: absolute;
            top: 50%;
            width: auto;
            padding: 16px;
            margin-top: -50px;
            color: white;
            font-weight: bold;
            font-size: 30px;
            transition: 0.3s;
            border-radius: 0 3px 3px 0;
            user-select: none;
            background-color: rgba(255, 255, 255, 0.1); /* N·ªÅn m·ªù nh·∫π */
            z-index: 10000;
        }

        /* V·ªã tr√≠ n√∫t */
        .next-btn {
            right: 0;
            border-radius: 3px 0 0 3px;
        }

        .prev-btn {
            left: 0;
            border-radius: 3px 0 0 3px;
        }

            .prev-btn:hover, .next-btn:hover {
                background-color: rgba(255, 255, 255, 0.3);
            }

        /* Caption (S·ªë th·ª© t·ª±) */
        #galleryCaption {
            margin-top: 10px;
            color: #ccc;
            font-size: 14px;
            font-family: sans-serif;
        }

        /* Animation zoom nh·∫π khi m·ªü */
        .gallery-content {
            animation-name: zoom;
            animation-duration: 0.3s;
        }

        @@keyframes zoom {
            from {
                transform: scale(0.8);
                opacity: 0
            }

            to {
                transform: scale(1);
                opacity: 1
            }
        }

        .photo-grid {
            display: grid;
            gap: 2px;
            width: 100%;
            margin-top: 12px;
            border-radius: 12px;
            overflow: hidden;
            cursor: pointer;
            background: #f0f2f5;
            background: #000000;
        }

        .grid-1 {
            display: block;
            max-height: 500px;
            width: 100%;
            overflow: hidden;
        }

            .grid-1 .grid-item {
                width: 100%;
                height: 100%;
            }

            .grid-1 img {
                width: 100%;
                height: 100%;
                max-height: 500px;
                object-fit: cover;
            }

        .grid-2 {
            display: grid;
            grid-template-columns: 1fr 1fr;
            height: 350px;
        }

        .grid-3 {
            display: grid;
            grid-template-columns: 1.5fr 1fr;
            grid-template-rows: 1fr 1fr;
            height: 400px;
        }

            .grid-3 .grid-item:first-child {
                grid-row: 1 / 3;
            }

        .grid-4 {
            display: grid;
            grid-template-columns: 1.5fr 1fr;
            grid-template-rows: 1fr 1fr 1fr;
            height: 400px;
        }

            .grid-4 .grid-item:first-child {
                grid-row: 1 / 4;
            }

        .grid-item {
            position: relative;
            width: 100%;
            height: 100%;
            overflow: hidden;
        }

            .grid-item img {
                width: 100%;
                height: 100%;
                object-fit: cover;
                display: block;
                transition: transform 0.3s ease;
            }

            .grid-item:hover img {
                transform: scale(1.05);
            }

        .more-photos-overlay {
            position: absolute;
            inset: 0;
            background-color: rgba(0, 0, 0, 0.4);
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 28px;
            font-weight: bold;
            backdrop-filter: blur(2px);
        }
        #reportPostModal .modal-content {
            border-radius: 12px;
            border: none;
            box-shadow: 0 4px 20px rgba(0,0,0,0.15);
        }

        #reportPostModal .list-group-item {
            border: none;
            padding-left: 0;
            padding-right: 0;
            font-weight: 600;
            color: #050505;
            font-size: 15px;
        }

            #reportPostModal .list-group-item:hover {
                background-color: #f0f2f5;
                border-radius: 8px;
                padding-left: 10px;
                padding-right: 10px;
            }
    </style>
}

<div class="feed-container">
    @Html.AntiForgeryToken()

    <!-- Feed Header -->
    <div class="feed-header">
        <h2>üåø B·∫£ng tin</h2>
    </div>

    <!-- Stories -->
    <div class="stories-container">
        <div class="stories-wrapper" id="stories-wrapper">
            <div class="story-item create-story" onclick="window.location.href='@Url.Action("CreateStory", "Feed")'">
                <div class="story-avatar-wrapper story-create-avatar">
                    <img src="@(string.IsNullOrEmpty(currentUserAvatar) ? "/Content/default-avatar.png" : currentUserAvatar)" alt="Avatar" class="story-avatar">
                    <span class="story-plus-icon"><i class="fas fa-plus"></i></span>
                </div>
                <div class="story-name">T·∫°o tin</div>
            </div>
            <!-- Stories will be loaded here by AJAX -->
        </div>
    </div>

    <!-- Create Post -->
    <div class="create-post-card">
        <div class="create-post-top">
            <img src="@(string.IsNullOrEmpty(currentUserAvatar) ? "/Content/default-avatar.png" : currentUserAvatar)" alt="Avatar" class="create-post-avatar user-avatar-trigger" data-userid="@currentUserId">
            <a href="@Url.Action("Create", "Feed")" class="create-post-input">
                B·∫°n ƒëang nghƒ© g√¨?
            </a>
        </div>
        <div class="create-post-actions">
            <a href="@Url.Action("Create", "Feed", new { type = "post" })" class="create-action-btn">
                <i class="fas fa-images photo"></i>
                <span>·∫¢nh/Video</span>
            </a>
            <a href="@Url.Action("Create", "Feed", new { type = "event" })" class="create-action-btn">
                <i class="fas fa-calendar-alt event"></i>
                <span>S·ª± ki·ªán</span>
            </a>
            <a href="@Url.Action("Create", "Feed", new { type = "status" })" class="create-action-btn">
                <i class="fas fa-smile status"></i>
                <span>Tr·∫°ng th√°i</span>
            </a>
        </div>
    </div>



    <!-- Posts List -->
    @if (Model != null && Model.Any())
    {
        <div id="post-list-container">
            @Html.Partial("_PostListDisplayPartial", Model)
        </div>
        <div id="loading-more" style="display: none;">
            <i class="fas fa-spinner"></i> ƒêang t·∫£i th√™m...
        </div>
    }
    else
    {
        <div class="alert alert-info">
            <i class="fas fa-leaf"></i>
            Ch∆∞a c√≥ b√†i ƒëƒÉng n√†o. H√£y l√† ng∆∞·ªùi ƒë·∫ßu ti√™n chia s·∫ª!
        </div>
    }
</div>

<div id="galleryModal" class="gallery-modal">
    <span class="close-gallery" onclick="closeGallery()">&times;</span>
    <a class="prev-btn" onclick="changeImage(-1)">&#10094;</a>
    <a class="next-btn" onclick="changeImage(1)">&#10095;</a>
    <img class="gallery-content" id="galleryImage">
    <div id="galleryCaption"></div>
</div>
<div class="modal fade" id="reportPostModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header border-bottom-0 pb-0">
                <h5 class="modal-title fw-bold">Ch·ªçn v·∫•n ƒë·ªÅ ƒë·ªÉ b√°o c√°o</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body pt-2">
                <p class="text-muted small mb-3">N·∫øu b·∫°n nh·∫≠n th·∫•y ai ƒë√≥ ƒëang g·∫∑p nguy hi·ªÉm, ƒë·ª´ng ch·∫ßn ch·ª´ m√† h√£y t√¨m ngay s·ª± gi√∫p ƒë·ª° tr∆∞·ªõc khi b√°o c√°o v·ªõi Online Chat.</p>
                <input type="hidden" id="reportPostIdVal" value="" />

                <div class="list-group list-group-flush report-options">
                    <button class="list-group-item list-group-item-action d-flex justify-content-between align-items-center py-3 report-reason-item" data-reason="Qu·∫•y r·ªëi">
                        Qu·∫•y r·ªëi <i class="fas fa-chevron-right text-muted small"></i>
                    </button>
                    <button class="list-group-item list-group-item-action d-flex justify-content-between align-items-center py-3 report-reason-item" data-reason="T·ª± t·ª≠ ho·∫∑c t·ª± g√¢y th∆∞∆°ng t√≠ch">
                        T·ª± t·ª≠ ho·∫∑c t·ª± g√¢y th∆∞∆°ng t√≠ch <i class="fas fa-chevron-right text-muted small"></i>
                    </button>
                    <button class="list-group-item list-group-item-action d-flex justify-content-between align-items-center py-3 report-reason-item" data-reason="Gi·∫£ m·∫°o ng∆∞·ªùi kh√°c">
                        Gi·∫£ m·∫°o ng∆∞·ªùi kh√°c <i class="fas fa-chevron-right text-muted small"></i>
                    </button>
                    <button class="list-group-item list-group-item-action d-flex justify-content-between align-items-center py-3 report-reason-item" data-reason="Chia s·∫ª n·ªôi dung kh√¥ng ph√π h·ª£p">
                        Chia s·∫ª n·ªôi dung kh√¥ng ph√π h·ª£p <i class="fas fa-chevron-right text-muted small"></i>
                    </button>
                    <button class="list-group-item list-group-item-action d-flex justify-content-between align-items-center py-3 report-reason-item" data-reason="Hate speech">
                        Ng√¥n t·ª´ g√¢y th√π gh√©t <i class="fas fa-chevron-right text-muted small"></i>
                    </button>
                    <button class="list-group-item list-group-item-action d-flex justify-content-between align-items-center py-3 report-reason-item" data-reason="B√°n h√†ng tr√°i ph√©p">
                        B√°n h√†ng tr√°i ph√©p <i class="fas fa-chevron-right text-muted small"></i>
                    </button>
                    <button class="list-group-item list-group-item-action d-flex justify-content-between align-items-center py-3 report-reason-item" data-reason="Vi ph·∫°m kh√°c">
                        V·∫•n ƒë·ªÅ kh√°c <i class="fas fa-chevron-right text-muted small"></i>
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

@section scripts {
    @Html.Partial("~/Views/Shared/_SharePostModal.cshtml")

    <script src="~/Scripts/jquery.signalR-2.4.3.min.js"></script>
    <script src="~/signalr/hubs"></script>

    <script>
    $(document).ready(function() {
        var chatHub = null;

        if ($.connection) {
            chatHub = $.connection.chatHub;
            $.connection.hub.start().done(function() {}).fail(function() {});
        }

        window.getAntiForgeryToken = function() {
            return $('input[name="__RequestVerificationToken"]').val();
        };

        $(document).on('click', '.like-btn', function () {
            var button = $(this);
            var postId = button.data('post-id');

            if (!postId) return;

            $.ajax({
                url: '@Url.Action("ToggleLike", "Feed")',
                type: 'POST',
                data: {
                    "__RequestVerificationToken": getAntiForgeryToken(),
                    postId: postId
                },
                success: function (response) {
                    if (response.success) {
                        var postCard = $('.post-card[data-post-id="' + postId + '"]');
                        var statsContainer = postCard.find('.post-stats');
                        var likeCountSpan = statsContainer.find('.likes-count .like-count');

                        if(response.likeCount > 0) {
                            if (statsContainer.length === 0) {
                                 postCard.find('.post-body').after('<div class="post-stats"><div class="likes-count"><i class="fas fa-heart"></i> <span class="like-count">' + response.likeCount + '</span></div></div>');
                            } else if (likeCountSpan.length > 0) {
                                likeCountSpan.text(response.likeCount);
                            } else {
                                statsContainer.prepend('<div class="likes-count"><i class="fas fa-heart"></i> <span class="like-count">' + response.likeCount + '</span></div>');
                            }
                        } else {
                            statsContainer.find('.likes-count').remove();
                            if(statsContainer.children().length === 0) statsContainer.remove();
                        }

                        if (response.userHasLiked) {
                            button.addClass('liked');
                            button.find('.fa-heart').removeClass('far').addClass('fas');
                        } else {
                            button.removeClass('liked');
                            button.find('.fa-heart').removeClass('fas').addClass('far');
                        }
                    }
                }
            });
        });

        $(document).on('click', '.comment-btn', function() {
            var postCard = $(this).closest('.post-card');
            var commentsSection = postCard.find('.post-comments');
            commentsSection.toggleClass('active');

            if(commentsSection.hasClass('active')) {
                setTimeout(function() {
                    commentsSection.find('.comment-input').focus();
                }, 100);
            }
        });

        $(document).on('click', '.privacy-toggle-btn', function (e) {
            e.preventDefault();
            var link = $(this);
            var postId = link.data('post-id');
            var currentPrivacyText = link.text();
            var newPrivacy = currentPrivacyText.includes("C√¥ng khai") ? "Public" : "Private";

            $.ajax({
                url: '@Url.Action("SetPostPrivacy", "Feed")',
                type: 'POST',
                data: {
                    "__RequestVerificationToken": getAntiForgeryToken(),
                    postId: postId,
                    privacy: newPrivacy
                },
                success: function (response) {
                    if (response.success) {
                        var newText = response.newPrivacy === "Public" ? "Chuy·ªÉn sang Ri√™ng t∆∞" : "Chuy·ªÉn sang C√¥ng khai";
                        link.html('<i class="fas fa-lock"></i> ' + newText);
                        var postCard = link.closest('.post-card');
                        postCard.find('.privacy-indicator').remove();
                        if (response.newPrivacy === "Private") {
                            postCard.find('.post-user-info div').first().append(' <i class="fas fa-lock privacy-indicator" title="Ri√™ng t∆∞" style="color: #65676b; font-size: 12px; margin-left: 4px;"></i>');
                        }
                    } else {
                        alert(response.message || "Kh√¥ng th·ªÉ thay ƒë·ªïi quy·ªÅn ri√™ng t∆∞.");
                    }
                }
            });
        });

        $(document).on('click', '.delete-post-btn', function (e) {
            e.preventDefault();
            if (!confirm("B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën x√≥a b√†i vi·∫øt n√†y kh√¥ng?")) return;

            var link = $(this);
            var postCard = link.closest('.post-card');
            var postId = postCard.data('post-id');

            $.ajax({
                url: '@Url.Action("DeletePost", "Feed")',
                type: 'POST',
                data: {
                    "__RequestVerificationToken": getAntiForgeryToken(),
                    postId: postId
                },
                success: function (response) {
                    if (response.success) {
                        postCard.fadeOut(400, function() {
                            $(this).remove();
                        });
                    } else {
                        alert(response.message || "Kh√¥ng th·ªÉ x√≥a b√†i vi·∫øt.");
                    }
                }
            });
        });

        $(document).on('click', '.hide-post-btn', function (e) {
            e.preventDefault();
            $(this).closest('.post-card').fadeOut(400);
        });

        $(document).on('click', '.report-post-btn', function (e) {
            e.preventDefault();
            var link = $(this);
            var postCard = link.closest('.post-card');
            var postId = postCard.data('post-id');

            var reason = prompt("Vui l√≤ng cho bi·∫øt l√Ω do b·∫°n b√°o c√°o b√†i vi·∫øt n√†y:");

            if (reason && reason.trim() !== "") {
                $.ajax({
                    url: '@Url.Action("ReportPost", "Feed")',
                    type: 'POST',
                    data: {
                        "__RequestVerificationToken": getAntiForgeryToken(),
                        postId: postId,
                        reason: reason
                    },
                    success: function (response) {
                        if (response.success) {
                            alert("C·∫£m ∆°n b·∫°n ƒë√£ b√°o c√°o. Ch√∫ng t√¥i s·∫Ω xem x√©t tr∆∞·ªùng h·ª£p n√†y.");
                        } else {
                            alert(response.message || "Kh√¥ng th·ªÉ g·ª≠i b√°o c√°o.");
                        }
                    }
                });
            }
        });

        $(document).on('click', '.share-btn', function(e) {
            e.preventDefault();
            var postCard = $(this).closest('.post-card');
            var postId = postCard.data('post-id');
            var postUrl = postCard.data('post-url');

            window.currentPostToShare = {
                id: postId,
                url: postUrl,
                author: postCard.find('.post-user-info strong').text(),
                content: postCard.find('.post-content-text').text(),
                mediaUrl: postCard.find('.post-media').attr('src') || ''
            };

            loadChatUsers();
            $('#shareModal').fadeIn(300);
        });

        $('.share-modal-close, .share-modal').click(function(e) {
            if (e.target === this) {
                $('#shareModal').fadeOut(300);
            }
        });

        function loadChatUsers() {
            $.ajax({
                url: '@Url.Action("GetFriendsToShare", "Feed")',
                type: 'GET',
                success: function(data) {
                    if (data && data.length > 0) {
                        var html = '';
                        data.forEach(function(user) {
                            html += '<div class="chat-user-item" data-username="' + user.Username + '">';
                            html += '<img src="' + (user.AvatarUrl || '/Content/default-avatar.png') + '" alt="' + user.Username + '">';
                            html += '<div class="chat-user-info">';
                            html += '<div class="chat-user-name">' + user.Username + '</div>';
                            html += '<div class="chat-user-status">Nh·∫•n ƒë·ªÉ chia s·∫ª</div>';
                            html += '</div></div>';
                        });
                        $('#chatUserList').html(html);
                    } else {
                        $('#chatUserList').html('<div style="text-align: center; padding: 20px; color: #65676b;">Kh√¥ng c√≥ ng∆∞·ªùi d√πng n√†o ƒë·ªÉ chia s·∫ª</div>');
                    }
                },
                error: function() {
                    $('#chatUserList').html('<div style="text-align: center; padding: 20px; color: #f44336;">L·ªói khi t·∫£i danh s√°ch</div>');
                }
            });
        }

        $(document).on('click', '.chat-user-item', function() {
            var targetUsername = $(this).data('username');

            if (!window.currentPostToShare) return;

            var shareData = {
                type: 'shared_post',
                postId: window.currentPostToShare.id,
                content: "ƒê√£ chia s·∫ª m·ªôt b√†i vi·∫øt c·ªßa " + window.currentPostToShare.author
            };
            var msgJson = JSON.stringify(shareData);
            var tempId = 'temp_' + Date.now();

            if (chatHub && $.connection.hub.state === $.signalR.connectionState.connected) {
                chatHub.server.sendPrivateMessage(targetUsername, msgJson, tempId, null)
                    .done(function() {
                        alert('ƒê√£ chia s·∫ª b√†i vi·∫øt ƒë·∫øn ' + targetUsername);
                        $('#shareModal').fadeOut(300);
                    })
                    .fail(function(e) {
                        alert('Kh√¥ng th·ªÉ g·ª≠i tin nh·∫Øn qua SignalR');
                    });
            } else {
                alert("L·ªói k·∫øt n·ªëi chat server. Vui l√≤ng t·∫£i l·∫°i trang.");
            }
        });

        $(document).on('submit', '.comment-add-form', function (e) {
            e.preventDefault();
            var form = $(this);
            var input = form.find('.comment-input');
            var postId = form.data('post-id');
            var commentText = input.val();

            if (commentText.trim() === "") return;

            $.ajax({
                url: '@Url.Action("AddComment", "Feed")',
                type: 'POST',
                data: {
                    "__RequestVerificationToken": getAntiForgeryToken(),
                    postId: postId,
                    content: commentText
                },
                success: function (data) {
                    var commentsSection = form.closest('.post-comments');
                    var commentList = commentsSection.find('.comment-list');
                    commentList.append(data);
                    input.val('');
                }
            });
        });

        $(document).on('click', '.delete-comment-btn', function () {
            var button = $(this);
            var commentId = button.data('comment-id');

            if (!confirm("B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën x√≥a b√¨nh lu·∫≠n n√†y kh√¥ng?")) return;

            $.ajax({
                url: '@Url.Action("DeleteComment", "Feed")',
                type: 'POST',
                data: {
                    "__RequestVerificationToken": getAntiForgeryToken(),
                    commentId: commentId
                },
                success: function (response) {
                    if (response.success) {
                        button.closest('.comment-item').fadeOut(400, function() {
                            $(this).remove();
                        });
                    } else {
                        alert(response.message || "Kh√¥ng th·ªÉ x√≥a b√¨nh lu·∫≠n.");
                    }
                }
            });
        });

        $(document).on('click', '.privacy-option', function (e) {
            e.preventDefault();
            var postId = $(this).data('post-id');
            var privacy = $(this).data('privacy');
            updatePostPrivacy(postId, privacy);
        });

        // ============================================
        // LOAD STORIES - ƒê√öNG C√ö PH√ÅP
        // ============================================
        loadStories();
    }); // End $(document).ready

    // ============================================
    // FUNCTION B√äN NGO√ÄI document.ready
    // ============================================
    function updatePostPrivacy(postId, privacyType) {
        var token = $('input[name="__RequestVerificationToken"]').val();

        $.ajax({
            url: '/Feed/SetPostPrivacy',
            type: 'POST',
            data: {
                __RequestVerificationToken: token,
                postId: postId,
                privacy: privacyType
            },
            success: function (response) {
                if (response.success) {
                    var iconClass = "fa-globe-americas";
                    var titleText = "C√¥ng khai";

                    if (privacyType === "Private") {
                        iconClass = "fa-lock";
                        titleText = "Ch·ªâ m√¨nh t√¥i";
                    } else if (privacyType === "Friends") {
                        iconClass = "fa-user-friends";
                        titleText = "B·∫°n b√®";
                    }

                    var iconElement = $("#privacy-icon-" + postId);
                    iconElement.removeClass("fa-globe-americas fa-lock fa-user-friends");
                    iconElement.addClass(iconClass);
                    iconElement.closest('.privacy-indicator').attr('title', titleText);
                    $('body').trigger('click');

                    console.log("ƒê√£ ƒë·ªïi quy·ªÅn ri√™ng t∆∞ th√†nh: " + privacyType);
                } else {
                    alert(response.message || "C√≥ l·ªói x·∫£y ra khi c·∫≠p nh·∫≠t.");
                }
            },
            error: function () {
                alert("Kh√¥ng th·ªÉ k·∫øt n·ªëi ƒë·∫øn server.");
            }
        });
    }

    // ============================================
    // FUNCTION LOAD STORIES - ƒê√öNG V·ªä TR√ç
    // ============================================
    function loadStories() {
        console.log('[Index] Loading stories...');

        $.ajax({
            url: '@Url.Action("GetStories", "Feed")',
            type: 'GET',
            success: function (data) {
                console.log('[Index] Stories loaded successfully');
                console.log('[Index] Response length:', data.length);

                var storiesWrapper = $('#stories-wrapper');

                storiesWrapper.find('.story-item:not(.create-story)').remove();

                $('#storyViewerModal').remove();

                if (data && data.trim() !== '') {
                    storiesWrapper.append(data);
                    console.log('[Index] Stories appended to DOM');
                } else {
                    console.log('[Index] No stories returned from server');
                }
            },
            error: function(xhr, status, error) {
                console.error('[Index] Error loading stories:', error);
                console.error('[Index] Status:', status);
                console.error('[Index] Response:', xhr.responseText);
            }
        });
        }

        $(document).on('click', '.hide-post-btn', function (e) {
            e.preventDefault();
            if(confirm("B·∫°n c√≥ mu·ªën ·∫©n b√†i vi·∫øt n√†y kh√¥ng?")) {
                $(this).closest('.post-card').fadeOut(300, function() {
                    $(this).remove(); // X√≥a kh·ªèi giao di·ªán
                });
            }
        });

        // 2. X·ª≠ l√Ω n√∫t M·ªû MODAL B√ÅO C√ÅO
        $(document).on('click', '.trigger-report-modal', function (e) {
            e.preventDefault();
            var postId = $(this).data('post-id');
            // L∆∞u PostId v√†o th·∫ª input ·∫©n trong modal ƒë·ªÉ l√°t n·ªØa g·ª≠i ƒëi
            $('#reportPostIdVal').val(postId);
            // Hi·ªán modal
            $('#reportPostModal').modal('show');
        });

        // 3. X·ª≠ l√Ω khi ch·ªçn L√ù DO B√ÅO C√ÅO
        $(document).on('click', '.report-reason-item', function () {
            var reason = $(this).data('reason');
            var postId = $('#reportPostIdVal').val();
            var $item = $(this); // L∆∞u l·∫°i element ƒëang click ƒë·ªÉ l√†m hi·ªáu ·ª©ng loading

            // Hi·ªáu ·ª©ng loading
            $item.css('opacity', '0.5');

            $.ajax({
                url: '@Url.Action("ReportPost", "Feed")',
                type: 'POST',
                data: {
                    "__RequestVerificationToken": $('input[name="__RequestVerificationToken"]').val(),
                    postId: postId,
                    reason: reason
                },
                success: function (response) {
                    $('#reportPostModal').modal('hide');
                    $item.css('opacity', '1');

                    if (response.success) {
                        alert("C·∫£m ∆°n b·∫°n ƒë√£ b√°o c√°o. Ch√∫ng t√¥i s·∫Ω xem x√©t tr∆∞·ªùng h·ª£p n√†y.");
                        // ·∫®n b√†i vi·∫øt lu√¥n cho ƒë·ª° ng·ª©a m·∫Øt
                        $('.post-card[data-post-id="' + postId + '"]').fadeOut();
                    } else {
                        alert(response.message || "Kh√¥ng th·ªÉ g·ª≠i b√°o c√°o.");
                    }
                },
                error: function() {
                    alert("L·ªói k·∫øt n·ªëi server.");
                    $item.css('opacity', '1');
                }
            });
        });

    setInterval(loadStories, 30000);

    $(document).on('click', '.dropdown-submenu a.dropdown-toggle', function(e){
        $(this).next('ul').toggle();
        e.stopPropagation();
        e.preventDefault();
    });
    </script>
}