@model IEnumerable<Online_chat.Models.SearchResultViewModel>
@using Online_chat.Models // Needed for FriendshipStatus enum

@{
    ViewBag.Title = "Kết quả tìm kiếm";
    Layout = "~/Views/Shared/_ChatLayout.cshtml";
}

<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css" />

<style>
    /* (Toàn bộ CSS của bạn giữ nguyên, không cần thay đổi) */
    .search-content-area {
        padding: 30px;
        height: 100%;
        overflow-y: auto;
        background-color: #fafffe;
    }

        .search-content-area::-webkit-scrollbar {
            width: 8px;
        }

        .search-content-area::-webkit-scrollbar-track {
            background: #f1f8e9;
        }

        .search-content-area::-webkit-scrollbar-thumb {
            background: linear-gradient(180deg, #81c784, #66bb6a);
            border-radius: 10px;
        }

    .page-title {
        font-weight: 700;
        color: #2e7d32;
    }

    .back-link {
        color: #43a047;
        text-decoration: none;
        font-weight: 500;
    }

        .back-link:hover {
            color: #1b5e20;
            text-decoration: underline;
        }

    .search-results-list .list-group-item {
        background: linear-gradient(135deg, #f9fdf9 0%, #ffffff 100%);
        border: 1px solid #e8f5e9;
        border-radius: 18px;
        margin-bottom: 10px;
        padding: 15px 20px;
        transition: all 0.3s ease;
        box-shadow: 0 4px 12px rgba(0,0,0,0.05);
        cursor: pointer; /* Indicate clickable */
    }

        .search-results-list .list-group-item:hover {
            transform: none;
            box-shadow: 0 4px 12px rgba(0,0,0,0.05);
        }


    .search-results-list .user-info-clickable:hover {
        background-color: rgba(232, 245, 233, 0.5);
        border-radius: 10px;
    }

    .list-friend-action:hover {
        filter: brightness(95%);
    }

    .list-action-area {
    }

    .result-avatar {
        width: 45px;
        height: 45px;
        border-radius: 50%;
        object-fit: cover;
        margin-right: 15px;
        border: 2px solid #fff;
        box-shadow: 0 2px 5px rgba(0,0,0,0.1);
    }

    .result-info strong {
        font-weight: 600;
        color: #1b5e20;
    }

    .result-info span {
        color: #6c757d;
        font-size: 0.9em;
    }

    .btn-action-search {
        font-size: 0.8rem;
        padding: 5px 12px;
        border-radius: 8px;
        font-weight: 500;
    }

    .btn-add {
        background-color: #d1ecf1;
        color: #0c5460;
        border: 1px solid #bee5eb;
    }

        .btn-add:hover {
            background-color: #bee5eb;
        }

    .btn-cancel {
        background-color: #e2e3e5;
        color: #383d41;
        border: 1px solid #d6d8db;
    }

        .btn-cancel:hover {
            background-color: #d6d8db;
        }

    .btn-friends {
        background-color: #d4edda;
        color: #155724;
        border: 1px solid #c3e6cb;
    }

    .modal-content {
        border-radius: 20px;
        overflow: hidden;
        background: #f1f8e9;
        border: none;
    }

    #profilePreviewModal .modal-header {
        padding: 0;
        border-bottom: none;
        height: 150px;
    }

    #modal-preview-cover {
        width: 100%;
        height: 100%;
        background-size: cover;
        background-position: center;
        background-color: #c8e6c9;
    }

    #modal-preview-avatar {
        width: 100px;
        height: 100px;
        border-radius: 50%;
        border: 4px solid #fff;
        position: absolute;
        top: 100px;
        left: 50%;
        transform: translateX(-50%);
        background-color: #fff;
        object-fit: cover;
    }

    #profilePreviewModal .modal-body {
        padding-top: 65px;
        text-align: center;
    }

    #modal-preview-display-name {
        font-weight: 700;
        color: #2e7d32;
        margin-bottom: 2px;
    }

    #modal-preview-username {
        color: #6c757d;
        font-size: 0.95em;
        margin-bottom: 15px;
    }

    #modal-preview-usercode {
        font-size: 0.9em;
        color: #555;
    }

    #profilePreviewModal .modal-footer {
        background-color: #e8f5e9;
        border-top: 1px solid #c8e6c9;
    }

    #modal-action-button { /* Use styles from list buttons */
    }

    #modal-message {
        font-weight: 500;
        color: #155724;
    }
    /* Message like "Already friends" */

</style>

<div class="modal fade" id="profilePreviewModal" tabindex="-1" role="dialog" aria-labelledby="profilePreviewModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered" role="document" style="max-width: 420px;">
        <div class="modal-content" style="border-radius: 20px; overflow: hidden; background: #fff; border: none; box-shadow: 0 8px 32px rgba(0,0,0,0.12);">

            <div id="modal-preview-cover" style="height: 160px; background-size: cover; background-position: center; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); position: relative;">
                <button type="button" class="close" data-bs-dismiss="modal" aria-label="Close"
                        style="position: absolute; top: 15px; right: 15px; color: #fff; background: rgba(0,0,0,0.3); backdrop-filter: blur(10px); border-radius: 50%; width: 36px; height: 36px; border: none; font-size: 1.3rem; opacity: 1; text-shadow: none; display: flex; align-items: center; justify-content: center; transition: all 0.2s; cursor: pointer;">
                    <span aria-hidden="true" style="line-height: 1;">&times;</span>
                </button>
            </div>

            <div style="text-align: center; margin-top: -50px; position: relative; z-index: 10;">
                <img id="modal-preview-avatar" src="/Content/default-avatar.png"
                     style="width: 100px; height: 100px; border-radius: 50%; border: 5px solid #fff; background-color: #fff; object-fit: cover; box-shadow: 0 4px 12px rgba(0,0,0,0.15);" />
            </div>

            <div class="modal-body" style="padding: 20px 30px 30px; text-align: center;">
                <h3 id="modal-preview-display-name" style="font-weight: 700; color: #1a1a1a; margin-bottom: 5px; font-size: 1.5rem;">Đang tải...</h3>
                <p id="modal-preview-username" style="color: #8e8e93; font-size: 0.95rem; margin-bottom: 24px;"></p>

                <div style="text-align: left; background: #f8f9fa; padding: 20px; border-radius: 12px; margin-bottom: 24px;">
                    <h5 style="font-weight: 600; margin-bottom: 16px; color: #1a1a1a; font-size: 1rem;">
                        <i class="fas fa-user-circle" style="color: #667eea; margin-right: 8px;"></i>
                        Thông tin cá nhân
                    </h5>

                    <div style="display: flex; align-items: center; margin-bottom: 12px; padding: 10px; background: white; border-radius: 8px;">
                        <div style="width: 40px; height: 40px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border-radius: 10px; display: flex; align-items: center; justify-content: center; margin-right: 12px; flex-shrink: 0;">
                            <i class="fas fa-venus-mars" style="color: white; font-size: 1.1rem;"></i>
                        </div>
                        <div style="flex: 1;">
                            <div style="font-size: 0.8rem; color: #8e8e93; margin-bottom: 2px;">Giới tính</div>
                            <strong id="modal-preview-gender" style="color: #1a1a1a; font-size: 0.95rem;"></strong>
                        </div>
                    </div>
                    <div style="display: flex; align-items: center; margin-bottom: 12px; padding: 10px; background: white; border-radius: 8px;">
                        <div style="width: 40px; height: 40px; background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); border-radius: 10px; display: flex; align-items: center; justify-content: center; margin-right: 12px; flex-shrink: 0;">
                            <i class="fas fa-birthday-cake" style="color: white; font-size: 1.1rem;"></i>
                        </div>
                        <div style="flex: 1;">
                            <div style="font-size: 0.8rem; color: #8e8e93; margin-bottom: 2px;">Ngày sinh</div>
                            <strong id="modal-preview-dob" style="color: #1a1a1a; font-size: 0.95rem;"></strong>
                        </div>
                    </div>
                    <div style="display: flex; align-items: center; margin-bottom: 12px; padding: 10px; background: white; border-radius: 8px;">
                        <div style="width: 40px; height: 40px; background: linear-gradient(135deg, #28a745 0%, #218838 100%); border-radius: 10px; display: flex; align-items: center; justify-content: center; margin-right: 12px; flex-shrink: 0;">
                            <i class="fas fa-phone-alt" style="color: white; font-size: 1.1rem;"></i>
                        </div>
                        <div style="flex: 1;">
                            <div style="font-size: 0.8rem; color: #8e8e93; margin-bottom: 2px;">Điện thoại</div>
                            <strong id="modal-preview-phone" style="color: #1a1a1a; font-size: 0.95rem;"></strong>
                        </div>
                    </div>
                    <div style="display: flex; align-items: center; padding: 10px; background: white; border-radius: 8px;">
                        <div style="width: 40px; height: 40px; background: linear-gradient(135deg, #007bff 0%, #0056b3 100%); border-radius: 10px; display: flex; align-items: center; justify-content: center; margin-right: 12px; flex-shrink: 0;">
                            <i class="fas fa-envelope" style="color: white; font-size: 1.1rem;"></i>
                        </div>
                        <div style="flex: 1;">
                            <div style="font-size: 0.8rem; color: #8e8e93; margin-bottom: 2px;">Email</div>
                            <strong id="modal-preview-email" style="color: #1a1a1a; font-size: 0.95rem;"></strong>
                        </div>
                    </div>
                </div>

                <div style="text-align: left; background: #f8f9fa; padding: 20px; border-radius: 12px; margin-bottom: 24px;">
                    <h5 style="font-weight: 600; margin-bottom: 12px; color: #1a1a1a; font-size: 1rem;">
                        <i class="fas fa-book-open" style="color: #fd7e14; margin-right: 8px;"></i>
                        Tiểu sử
                    </h5>
                    <p id="modal-preview-bio" style="color: #333; font-size: 0.95rem; white-space: pre-wrap; word-wrap: break-word;"></p>
                </div>

                <div class="list-group" style="text-align: left;">
                    <a href="#" id="modal-preview-block" class="list-group-item list-group-item-action" style="color: #dc3545; font-weight: 500; border: none; background: transparent; padding-left: 0;">
                        <i class="fas fa-ban" style="margin-right: 10px; width: 20px;"></i> Chặn tin nhắn và cuộc gọi
                    </a>
                </div>

                <div id="modal-action-area" class="text-center mt-4" style="min-height: 38px;">
                </div>
            </div>
        </div>
    </div>
</div>

<div class="search-content-area">
    <h2 class="page-title mb-2">@ViewBag.Title</h2>
    <p><a href="@Url.Action("Index", "Friend")" class="back-link">&laquo; Quay lại trang Bạn bè</a></p>
    <hr class="mb-4" />

    @if (!Model.Any())
    {
        <div class="alert alert-warning" style="background-color: #fff3cd; border-color: #ffeeba; color: #856404; border-radius: 12px;">
            <i class="fas fa-exclamation-triangle me-2"></i> Không tìm thấy người dùng nào phù hợp.
        </div>
    }
    else
    {
        <ul class="list-group search-results-list" id="search-results">
            @foreach (var user in Model)
            {
                <li class="list-group-item d-flex justify-content-between align-items-center"
                    data-bs-toggle="modal" data-bs-target="#profilePreviewModal"
                    data-user-id="@user.UserId"
                    data-display-name="@user.DisplayName"
                    data-username="@user.Username"
                    data-avatar-url="@Url.Content(user.AvatarUrl ?? "/Content/default-avatar.png")"
                    data-cover-url="@Url.Content(user.CoverPhotoUrl ?? "/Content/default-cover.jpg")"
                    data-user-code="@user.UserCode"
                    data-friendship-status="@(user.FriendshipStatus.ToString() ?? "")"
                    data-gender="@user.Gender"
                    data-dob="@(user.DateOfBirth != null ? user.DateOfBirth.Value.ToString("dd/MM/yyyy") : "")"
                    data-bio="@user.Bio"
                    data-phone="@user.PhoneNumber"
                    data-email="@user.Email"
                    style="cursor: pointer;">

                    <div class="user-info-clickable d-flex align-items-center flex-grow-1 me-3"
                         data-bs-toggle="modal" data-bs-target="#profilePreviewModal"
                         style="cursor: pointer; min-width: 0;">

                        <img src="@Url.Content(user.AvatarUrl ?? "/Content/default-avatar.png")" class="result-avatar" />

                        <div class="result-info" style="overflow: hidden;">
                            <strong style="display: block; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">
                                @user.DisplayName
                            </strong>
                            <span>@@@user.Username</span>
                        </div>
                    </div>

                    <div class="list-action-area flex-shrink-0">
                        @if (user.FriendshipStatus == null)
                        {
                            <button class="btn btn-sm btn-action-search btn-add list-friend-action" data-action="send" data-receiver-id="@user.UserId">
                                <i class="fas fa-user-plus me-1"></i> Kết bạn
                            </button>
                        }
                        else if (user.FriendshipStatus == FriendshipStatus.Pending)
                        {
                            <button class="btn btn-sm btn-action-search btn-cancel list-friend-action" data-action="cancel" data-receiver-id="@user.UserId">
                                <i class="fas fa-times me-1"></i> Hủy lời mời
                            </button>
                        }
                        else if (user.FriendshipStatus == FriendshipStatus.Accepted)
                        {
                            <button class="btn btn-sm btn-action-search btn-friends" disabled>
                                <i class="fas fa-check me-1"></i> Bạn bè
                            </button>
                        }
                    </div>
                </li>
            }
        </ul>
    }
</div>

@section scripts {
    <script>
    $(function () {
        const token = $('input[name="__RequestVerificationToken"]').val();

        // =================================================================
        // FIX 2B: XỬ LÝ CLICK NÚT TRÊN DANH SÁCH (NGOÀI MODAL)
        // =================================================================
        $('#search-results').on('click', '.list-action-area', function (event) {
            // Ngăn sự kiện click "nổi bọt" lên <li> (ngăn mở modal)
            event.stopPropagation();

            const button = $(this).find('button.list-friend-action');
            if (button.length === 0 || button.is(':disabled')) return;

            const listItem = button.closest('.list-group-item');
            const receiverId = button.data('receiver-id');
            const action = button.data('action');
            const originalHtml = button.html();

            let url = '';
            let newStatus = '';
            let newAction = '';

            if (action === 'send') {
                url = '@Url.Action("SendRequest", "Friend")';
                newStatus = '@FriendshipStatus.Pending.ToString()';
                newAction = 'cancel';
            } else if (action === 'cancel') {
                url = '@Url.Action("CancelRequest", "Friend")';
                newStatus = ''; // Trở về null/empty
                newAction = 'send';
            } else {
                return;
            }

            button.prop('disabled', true).html('<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span>');

            $.ajax({
                url: url,
                type: 'POST',
                data: {
                    __RequestVerificationToken: token,
                    receiverId: receiverId
                },
                success: function (response) {
                    if (response.success) {
                        // 1. Cập nhật data-status trên <li>
                        listItem.data('friendship-status', newStatus);

                        // 2. Cập nhật chính nút vừa click
                        button.data('action', newAction);
                        if (action === 'send') {
                            button.removeClass('btn-add').addClass('btn-cancel')
                                .html('<i class="fas fa-times me-1"></i> Hủy lời mời');
                        } else if (action === 'cancel') {
                            button.removeClass('btn-cancel').addClass('btn-add')
                                .html('<i class="fas fa-user-plus me-1"></i> Kết bạn');
                        }
                    } else {
                        alert(response.message || "Có lỗi xảy ra.");
                        button.html(originalHtml); // Trả lại text nút cũ nếu lỗi
                    }
                },
                error: function () {
                    alert("Lỗi kết nối. Vui lòng thử lại.");
                    button.html(originalHtml); // Trả lại text nút cũ nếu lỗi
                },
                complete: function() {
                    button.prop('disabled', false);
                }
            });
        });

        // =================================================================
        // XỬ LÝ MỞ MODAL KHI CLICK VÀO <li> (PHẦN THÔNG TIN USER)
        // =================================================================
        $('#search-results').on('click', '.list-group-item', function (event) {
            // Sự kiện này sẽ không chạy nếu bạn click vào nút (do đã bị stopPropagation)

            const item = $(this);
            const userId = item.data('user-id');
            const displayName = item.data('display-name');
            const username = item.data('username');
            const avatarUrl = item.data('avatar-url');
            const coverUrl = item.data('cover-url');

            // Lấy status MỚI NHẤT từ data attribute (đã được AJAX ở trên cập nhật)
            const status = item.data('friendship-status');

            const gender = item.data('gender');
            const dob = item.data('dob');
            const bio = item.data('bio');
            const phone = item.data('phone');
            const email = item.data('email');

            // Đổ dữ liệu vào modal
            $('#modal-preview-cover').css('background-image', `url(${coverUrl})`);
            $('#modal-preview-avatar').attr('src', avatarUrl);
            $('#modal-preview-display-name').text(displayName);
            $('#modal-preview-username').text(`@@${username}`);

            $('#modal-preview-gender').text(gender || 'Chưa cập nhật');
            $('#modal-preview-phone').text(phone || 'Chưa cập nhật');
            $('#modal-preview-bio').text(bio || 'Không có tiểu sử.');
            $('#modal-preview-email').text(email || 'Chưa cập nhật');

            if (dob) {
                try {
                    const date = new Date(dob);
                    const day = date.getDate();
                    const month = date.getMonth() + 1;
                    const year = date.getFullYear();
                    $('#modal-preview-dob').text(`${day} tháng ${month < 10 ? '0' + month : month}, ${year}`);
                } catch(e) {
                    $('#modal-preview-dob').text('Chưa cập nhật');
                }
            } else {
                $('#modal-preview-dob').text('Chưa cập nhật');
            }

            // TẠO NÚT ACTION TRONG MODAL (dựa trên data-status)
            const actionArea = $('#modal-action-area');
            actionArea.empty();

            if (!status || status === '') { // Đã sửa điều kiện
                actionArea.html(`<button class="btn btn-sm btn-action-search btn-add modal-friend-action" data-action="send" data-receiver-id="${userId}"><i class="fas fa-user-plus me-1"></i> Gửi lời mời</button>`);
            } else if (status === '@FriendshipStatus.Pending.ToString()') {
                actionArea.html(`<button class="btn btn-sm btn-action-search btn-cancel modal-friend-action" data-action="cancel" data-receiver-id="${userId}"><i class="fas fa-times me-1"></i> Hủy lời mời</button>`);
            } else if (status === '@FriendshipStatus.Accepted.ToString()') {
                actionArea.html(`<span class="modal-message"><i class="fas fa-check-circle me-1"></i> Các bạn đã là bạn bè</span>`);
            }
        });

        // =================================================================
        // XỬ LÝ CLICK NÚT CHẶN (TRONG MODAL)
        // =================================================================
        $('body').on('click', '#modal-preview-block', function(e) {
            e.preventDefault();
            const partnerName = $('#modal-preview-display-name').text();
            alert(`Chức năng Chặn '${partnerName}' (Đang phát triển)`);
            $('#profilePreviewModal').modal('hide');
        });

        // =================================================================
        // XỬ LÝ CLICK NÚT ACTION (TRONG MODAL)
        // =================================================================
        $('#profilePreviewModal').on('click', '.modal-friend-action', function () {
            const button = $(this);
            const action = button.data('action');
            const receiverId = button.data('receiver-id');
            const modalActionArea = $('#modal-action-area');
            const originalHtml = button.html();

            let url = '';
            let newStatus = '';
            let newAction = '';

            if (action === 'send') {
                url = '@Url.Action("SendRequest", "Friend")';
                newStatus = '@FriendshipStatus.Pending.ToString()';
                newAction = 'cancel';
            } else if (action === 'cancel') {
                url = '@Url.Action("CancelRequest", "Friend")';
                newStatus = '';
                newAction = 'send';
            } else {
                return;
            }

            button.prop('disabled', true).html('<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Đang xử lý...');

            $.ajax({
                url: url,
                type: 'POST',
                data: {
                    __RequestVerificationToken: token,
                    receiverId: receiverId
                },
                success: function (response) {
                    if (response.success) {
                        // 1. Cập nhật nút TRONG MODAL
                        if (action === 'send') {
                            modalActionArea.html(`<button class="btn btn-sm btn-action-search btn-cancel modal-friend-action" data-action="cancel" data-receiver-id="${receiverId}"><i class="fas fa-times me-1"></i> Hủy lời mời</button>`);
                        } else if (action === 'cancel') {
                            modalActionArea.html(`<button class="btn btn-sm btn-action-search btn-add modal-friend-action" data-action="send" data-receiver-id="${receiverId}"><i class="fas fa-user-plus me-1"></i> Gửi lời mời</button>`);
                        }

                        // 2. TÌM VÀ CẬP NHẬT NÚT BÊN NGOÀI LIST
                        const listItem = $(`#search-results .list-group-item[data-user-id='${receiverId}']`);
                        if(listItem.length > 0) {
                            // Cập nhật data-status trên <li>
                            listItem.data('friendship-status', newStatus);

                            // Cập nhật nút trên list
                            const listButton = listItem.find('button.list-friend-action');
                            if(listButton.length > 0) {
                                listButton.data('action', newAction);
                                if (action === 'send') {
                                    listButton.removeClass('btn-add').addClass('btn-cancel')
                                        .html('<i class="fas fa-times me-1"></i> Hủy lời mời');
                                } else if (action === 'cancel') {
                                    listButton.removeClass('btn-cancel').addClass('btn-add')
                                        .html('<i class="fas fa-user-plus me-1"></i> Kết bạn');
                                }
                            }
                        }
                    } else {
                        alert(response.message || "Có lỗi xảy ra.");
                        button.html(originalHtml);
                    }
                },
                error: function () {
                    alert("Lỗi kết nối. Vui lòng thử lại.");
                    button.html(originalHtml);
                }
            });
        });

    });
    </script>
}