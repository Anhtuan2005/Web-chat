@{
    ViewBag.Title = "Cài đặt";
    Layout = "~/Views/Shared/_ChatLayout.cshtml";
    string activePage = (string)ViewBag.ActivePage ?? "Appearance";
}

<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css" />

<style>
    .settings-container {
        display: flex;
        height: 100%;
        background-color: #fafffe;
    }

    .settings-sidebar {
        width: 280px;
        background-color: #ffffff;
        border-right: 1px solid #e8f5e9;
        padding: 20px;
        box-shadow: 2px 0 5px rgba(0,0,0,0.03);
        flex-shrink: 0;
    }

    .settings-menu-title {
        font-weight: 700;
        color: #2e7d32;
        font-size: 1.5rem;
        margin-bottom: 25px;
        padding-left: 15px;
    }

    .settings-menu ul {
        list-style: none;
        padding: 0;
        margin: 0;
    }

    .settings-menu li a {
        display: flex;
        align-items: center;
        padding: 15px 20px;
        color: #333;
        text-decoration: none;
        border-radius: 12px;
        margin-bottom: 8px;
        font-weight: 500;
        transition: all 0.3s ease;
    }

        .settings-menu li a:hover, .settings-menu li a.active {
            background-color: #e8f5e9;
            color: #2e7d32;
        }

    .settings-menu .menu-icon {
        margin-right: 15px;
        width: 20px;
        text-align: center;
    }

    .settings-content {
        flex-grow: 1;
        padding: 40px;
        overflow-y: auto;
    }

    /* Styles from the old page that are still needed */
    .settings-card {
        max-width: 800px;
        margin: 0 auto 30px auto;
        background: #fff;
        border-radius: 18px;
        border: 1px solid #e8f5e9;
        box-shadow: 0 4px 12px rgba(0,0,0,0.05);
        overflow: hidden;
    }

    .settings-header {
        padding: 20px 25px;
        border-bottom: 1px solid #e8f5e9;
        font-weight: 700;
        color: #2e7d32;
        font-size: 1.2rem;
    }

    .settings-body {
        padding: 25px;
    }

    .settings-item {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 15px 0;
        border-bottom: 1px solid #f1f8e9;
    }

        .settings-item:last-child {
            border-bottom: none;
        }

    .settings-item-label strong {
        color: #333;
    }

    .settings-item-label p {
        color: #6c757d;
        font-size: 0.9rem;
        margin: 0;
    }

    .custom-toggle-switch {
        position: relative;
        display: inline-block;
        width: 50px;
        height: 28px;
    }

        .custom-toggle-switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }

    .slider {
        position: absolute;
        cursor: pointer;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background-color: #ccc;
        transition: .4s;
    }

        .slider:before {
            position: absolute;
            content: "";
            height: 20px;
            width: 20px;
            left: 4px;
            bottom: 4px;
            background-color: white;
            transition: .4s;
        }

    input:checked + .slider {
        background-color: #43a047;
    }

        input:checked + .slider:before {
            transform: translateX(22px);
        }

    .slider.round {
        border-radius: 28px;
    }

        .slider.round:before {
            border-radius: 50%;
        }

    .form-group label {
        font-weight: 600;
        color: #388e3c;
    }

    .form-control {
        background-color: #f1f8e9;
        border: 2px solid #c8e6c9;
        border-radius: 12px;
    }

        .form-control:focus {
            background-color: #fff;
            border-color: #43a047;
            box-shadow: 0 0 0 3px rgba(67, 160, 71, 0.2);
        }

    .btn-save-password {
        background: linear-gradient(135deg, #43a047 0%, #388e3c 100%);
        color: white;
        font-weight: 600;
        border: none;
        border-radius: 12px;
        padding: 10px 20px;
    }
</style>

<div class="settings-container">
    <div class="settings-sidebar">
        <div class="settings-menu-title">Cài đặt</div>
        <nav class="settings-menu">
            <ul>
                <li><a href="@Url.Action("Index", new { page = "Appearance" })" class="@(activePage == "Appearance" ? "active" : "")"><i class="fas fa-paint-brush menu-icon"></i>Giao diện</a></li>
                <li><a href="@Url.Action("Index", new { page = "Notifications" })" class="@(activePage == "Notifications" ? "active" : "")"><i class="fas fa-bell menu-icon"></i>Thông báo</a></li>
                <li><a href="@Url.Action("Index", new { page = "Security" })" class="@(activePage == "Security" ? "active" : "")"><i class="fas fa-shield-alt menu-icon"></i>Tài khoản & Bảo mật</a></li>
                <li><a href="@Url.Action("Index", new { page = "Block" })" class="@(activePage == "Block" ? "active" : "")"><i class="fas fa-ban menu-icon"></i>Danh sách chặn</a></li>
                <li><a href="@Url.Action("Index", new { page = "Language" })" class="@(activePage == "Language" ? "active" : "")"><i class="fas fa-language menu-icon"></i>Ngôn ngữ</a></li>
            </ul>
        </nav>
    </div>
    <div class="settings-content">
        @switch (activePage)
        {
            case "Notifications":
                Html.RenderPartial("_NotificationSettings");
                break;
            case "Security":
                Html.RenderPartial("_SecuritySettings");
                break;
            case "Block":
                Html.RenderPartial("_BlockSettings", (IEnumerable<Online_chat.Models.BlockedUser>)ViewBag.BlockedUsers);
                break;
            case "Language":
                Html.RenderPartial("_LanguageSettings");
                break;
            case "Appearance":
            default:
                Html.RenderPartial("_AppearanceSettings");
                break;
        }
    </div>
</div>

@section scripts {
    <script>
        $(document).ready(function () {

            // =-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=
            // EVENT HANDLERS FOR SETTINGS PAGES
            // =-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=

            // For _AppearanceSettings.cshtml
            $('#darkModeToggle').change(function () {
                if ($(this).is(":checked")) {
                    $('html').addClass('dark-mode');
                    localStorage.setItem('theme', 'dark');
                } else {
                    $('html').removeClass('dark-mode');
                    localStorage.setItem('theme', 'light');
                }
            });
            // check darkmode is enable or not
            var theme = localStorage.getItem('theme');
            if (theme === 'dark') {
                $('#darkModeToggle').prop('checked', true);
            } else {
                $('#darkModeToggle').prop('checked', false);
            }


            // For _NotificationSettings.cshtml
            $('#soundNotificationToggle').change(function () {
                if ($(this).is(":checked")) {
                    console.log("Sound notifications enabled (UI only)");
                } else {
                    console.log("Sound notifications disabled (UI only)");
                }
            });

            // For _LanguageSettings.cshtml
            $('#languageSelect').change(function () {
                var selectedLanguage = $(this).val();
                console.log("Language selected: " + selectedLanguage + " (UI only)");
            });

            // For _SecuritySettings.cshtml (Change Password)
            $('#changePasswordForm').submit(function (e) {
                e.preventDefault();
                var form = $(this);
                var messagePlaceholder = $('#password-message-placeholder');
                $.ajax({
                    type: "POST",
                    url: '@Url.Action("ChangePassword")',
                    data: form.serialize(),
                    success: function (data) {
                        var alertClass = data.success ? 'alert-success' : 'alert-danger';
                        messagePlaceholder.html('<div class="alert ' + alertClass + '">' + data.message + '</div>');
                        if (data.success) {
                            form[0].reset();
                        }
                    },
                    error: function () {
                        messagePlaceholder.html('<div class="alert alert-danger">Đã có lỗi xảy ra. Vui lòng thử lại.</div>');
                    }
                });
            });
            
            // For _BlockSettings.cshtml
            $('.unblock-user-btn').click(function () {
                var button = $(this);
                var blockedId = button.data('userid');
                if (confirm('Bạn có chắc chắn muốn bỏ chặn người dùng này không?')) {
                    $.ajax({
                        url: '@Url.Action("UnblockUser")',
                        type: 'POST',
                        data: { blockedId: blockedId },
                        success: function (response) {
                            if (response.success) {
                                $('#blocked-user-' + blockedId).fadeOut(300, function () { $(this).remove(); });
                            } else {
                                alert('Lỗi: ' + response.message);
                            }
                        },
                        error: function () {
                            alert('Đã xảy ra lỗi khi kết nối tới máy chủ.');
                        }
                    });
                }
            });
        });
    </script>
}