    <!DOCTYPE html>
    <html>
    <head>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>@ViewBag.Title</title>
        @Styles.Render("~/Content/css")
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css" />
        <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
        <style>

            * {
                margin: 0;
                padding: 0;
                box-sizing: border-box;
            }

            body {
                overflow: hidden;
                font-family: 'Inter', sans-serif;
                background: linear-gradient(135deg, #e8f5e9 0%, #f1f8e9 100%);
            }

            .app-layout {
                display: flex;
                height: 100vh;
                padding: 12px;
                gap: 12px;
            }

            .main-nav-bar {
                width: 80px;
                background: linear-gradient(180deg, #2e7d32 0%, #388e3c 50%, #43a047 100%);
                box-shadow: 0 8px 32px rgba(46, 125, 50, 0.25);
                display: flex;
                flex-direction: column;
                justify-content: space-between;
                align-items: center;
                padding: 25px 0;
                flex-shrink: 0;
                z-index: 10;
                position: relative;
                border-radius: 28px;
                border: 3px solid rgba(255, 255, 255, 0.2);
            }

            .nav-separator {
                width: 32px;
                height: 2px;
                background-color: #40444b;
                border-radius: 1px;
                margin: 10px 0;
            }

            .nav-group {
                display: flex;
                flex-direction: column;
                align-items: center;
                gap: 15px;
            }

            .nav-icon {
                font-size: 1.5rem;
                color: #b9bbbe;
                background-color: #40444b;
                cursor: pointer;
                width: 50px;
                height: 50px;
                display: flex;
                align-items: center;
                justify-content: center;
                border-radius: 50%;
                transition: all 0.2s ease-in-out;
                position: relative;
            }

                .nav-icon:hover {
                    border-radius: 15px;
                    background-color: #3ba55d;
                    color: #fff;
                }

                .nav-icon.active {
                    border-radius: 15px;
                    background-color: #3ba55d;
                    color: #fff;
                }

            .profile-section {
                position: relative;
            }

            #user-avatar {
                width: 50px;
                height: 50px;
                padding: 0;
                background-color: #7289da;
                color: white;
                font-weight: 600;
                font-size: 1.5rem;
            }

                #user-avatar:hover {
                    border-radius: 15px;
                }

            .profile-dropdown-menu {
                display: none;
                position: absolute;
                top: 5px;
                left: 90px;
                width: 250px;
                background-color: #2c2f33;
                border-radius: 8px;
                box-shadow: 0 10px 30px rgba(0,0,0,0.3);
                z-index: 1000;
                padding: 8px;
                color: #fff;
            }

            .dropdown-header {
                padding: 12px 16px;
                font-size: 1.1rem;
                font-weight: 600;
                border-bottom: 1px solid #4f545c;
                margin-bottom: 8px;
            }

            .dropdown-item {
                display: block;
                padding: 10px 16px;
                color: #dcddde;
                text-decoration: none;
                border-radius: 4px;
                transition: background-color 0.2s;
            }

                .dropdown-item:hover {
                    background-color: #40444b;
                    color: #fff;
                    text-decoration: none;
                }

            .dropdown-divider {
                height: 1px;
                margin: 8px 0;
                background-color: #4f545c;
            }

            .main-nav-bar::before {
                content: '';
                position: absolute;
                top: 0;
                left: 0;
                right: 0;
                height: 6px;
                background: linear-gradient(90deg, #66bb6a, #81c784, #a5d6a7, #81c784, #66bb6a);
                background-size: 200% 100%;
                animation: shimmer 3s linear infinite;
                border-radius: 28px 28px 0 0;
            }

            @@keyframes shimmer {
                0% {
                    background-position: 0% 0%;
                }

                100% {
                    background-position: 200% 0%;
                }
            }

            .main-nav-bar .nav-icon {
                font-size: 1.6rem;
                color: rgba(255, 255, 255, 0.85);
                margin-bottom: 22px;
                cursor: pointer;
                padding: 16px;
                border-radius: 20px;
                transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
                position: relative;
                background: rgba(255, 255, 255, 0.08);
                backdrop-filter: blur(10px);
            }

                .main-nav-bar .nav-icon::before {
                    content: '';
                    position: absolute;
                    inset: 0;
                    border-radius: 20px;
                    padding: 2px;
                    background: linear-gradient(135deg, rgba(255,255,255,0.3), rgba(255,255,255,0.1));
                    -webkit-mask: linear-gradient(#fff 0 0) content-box, linear-gradient(#fff 0 0);
                    -webkit-mask-composite: xor;
                    mask-composite: exclude;
                    opacity: 0;
                    transition: opacity 0.4s ease;
                }

                .main-nav-bar .nav-icon:hover {
                    background: rgba(255, 255, 255, 0.25);
                    color: #fff;
                    transform: translateY(-4px) scale(1.08);
                    box-shadow: 0 8px 24px rgba(0, 0, 0, 0.3);
                }

                    .main-nav-bar .nav-icon:hover::before {
                        opacity: 1;
                    }

                .main-nav-bar .nav-icon.active {
                    background: linear-gradient(135deg, rgba(255, 255, 255, 0.3), rgba(255, 255, 255, 0.2));
                    color: #fff;
                    box-shadow: 0 8px 32px rgba(0, 0, 0, 0.35), inset 0 2px 8px rgba(255, 255, 255, 0.2);
                    transform: scale(1.05);
                }

                    .main-nav-bar .nav-icon.active::after {
                        content: '';
                        position: absolute;
                        right: -18px;
                        top: 50%;
                        transform: translateY(-50%);
                        width: 5px;
                        height: 35px;
                        background: linear-gradient(180deg, #fff, #e8f5e9);
                        border-radius: 10px 0 0 10px;
                        box-shadow: 0 4px 12px rgba(255, 255, 255, 0.5);
                    }

            /* 2. Cột danh sách hội thoại */
            .conversation-list {
                width: 360px;
                background: rgba(255, 255, 255, 0.95);
                backdrop-filter: blur(20px);
                flex-direction: column;
                flex-shrink: 0;
                transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
                border-radius: 28px;
                overflow: hidden;
                box-shadow: 0 8px 32px rgba(46, 125, 50, 0.15);
                border: 2px solid rgba(255, 255, 255, 0.8);
            }

            .conv-header {
                padding: 24px;
                font-size: 1.4rem;
                font-weight: 700;
                background: linear-gradient(135deg, #66bb6a 0%, #4caf50 100%);
                color: white;
                display: flex;
                align-items: center;
                gap: 12px;
                position: relative;
                overflow: hidden;
            }

                .conv-header::before {
                    content: '';
                    position: absolute;
                    top: -50%;
                    right: -50%;
                    width: 200%;
                    height: 200%;
                    background: radial-gradient(circle, rgba(255,255,255,0.2) 0%, transparent 70%);
                    animation: pulse 4s ease-in-out infinite;
                }

            @@keyframes pulse {
                0%, 100% {
                    transform: scale(1) translate(0, 0);
                    opacity: 0.5;
                }

                50% {
                    transform: scale(1.1) translate(-10%, -10%);
                    opacity: 0.8;
                }
            }

            .message-area {
                padding: 20px;
                display: flex;
                flex-direction: column;
                gap: 4px;
            }

            @@keyframes slideIn {
                from {
                    opacity: 0;
                    transform: translateY(10px);
                }

                to {
                    opacity: 1;
                    transform: translateY(0);
                }
            }

            .chat-message {
                display: flex;
                align-items: flex-end;
                margin: 8px 0;
                width: 100%;
            }

                /* Tin nhắn của người khác (bên trái) */
                .chat-message.other {
                    justify-content: flex-start;
                }

                    .chat-message.other .chat-bubble {
                        background-color: #e4e6eb;
                        color: #050505;
                        border-radius: 18px 18px 18px 0;
                        padding: 10px 14px;
                        max-width: 65%;
                        display: inline-block;
                        word-wrap: break-word;
                        white-space: pre-wrap;
                        box-shadow: 0 2px 6px rgba(0, 0, 0, 0.1);
                    }



            .chat-bubble .timestamp {
                display: none; /* Ẩn timestamp đi cho gọn, có thể bật lại nếu muốn */
            }


            /* Image Messages */
            .chat-bubble img {
                border-radius: 15px;
                display: block;
                max-width: 100%;
            }

            /* --- INPUT AREA STYLES --- */
            .input-area {
                background: #fff;
                padding: 10px 15px;
                display: flex; 
                align-items: center; 
                gap: 10px;
            }

                .input-area #messageInput {
                     background-color: #f0f2f5;
                     border-radius: 20px;
                     padding: 8px 16px;
                     flex-grow: 1; 
                     border: none; 
                     width: auto;
                                   
                }

                    .input-area #messageInput:focus {
                        background-color: #e8f0fe;
                        border-color: #8ab4f8;
                        box-shadow: none;
                    }

            .conv-header i {
                font-size: 1.5rem;
                filter: drop-shadow(0 2px 4px rgba(0,0,0,0.2));
                position: relative;
                z-index: 1;
            }

            .conv-header span {
                position: relative;
                z-index: 1;
            }

            .conv-items {
                flex-grow: 1;
                overflow-y: auto;
                padding: 16px;
            }

                .conv-items::-webkit-scrollbar {
                    width: 8px;
                }

                .conv-items::-webkit-scrollbar-track {
                    background: #f1f8e9;
                    border-radius: 10px;
                    margin: 8px 0;
                }

                .conv-items::-webkit-scrollbar-thumb {
                    background: linear-gradient(180deg, #81c784, #66bb6a);
                    border-radius: 10px;
                    border: 2px solid #f1f8e9;
                }

                    .conv-items::-webkit-scrollbar-thumb:hover {
                        background: linear-gradient(180deg, #66bb6a, #4caf50);
                    }

            .list-group {
                margin-bottom: 0;
            }

            .list-group-item {
                border: none;
                border-radius: 18px;
                margin-bottom: 10px;
                padding: 16px 20px;
                transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
                background: linear-gradient(135deg, #f9fdf9 0%, #ffffff 100%);
                border: 2px solid transparent;
                position: relative;
                overflow: hidden;
            }

                .list-group-item:hover {
                    background: linear-gradient(135deg, #e8f5e9 0%, #c8e6c9 100%);
                    transform: translateX(8px) scale(1.02);
                    box-shadow: 0 6px 24px rgba(46, 125, 50, 0.2);
                }

           
                .list-group-item.active {
                    background: linear-gradient(135deg, #66bb6a 0%, #4caf50 100%);
                    color: white;
                    transform: translateX(8px) scale(1.02);
                    box-shadow: 0 8px 32px rgba(46, 125, 50, 0.4);
                    border: 2px solid rgba(255, 255, 255, 0.3);
                }

                    .list-group-item.active::before {
                        opacity: 0;
                    }

                    .list-group-item.active strong {
                        color: white !important;
                    }

                .list-group-item strong {
                    font-weight: 600;
                    color: #2e7d32;
                    display: flex;
                    align-items: center;
                    gap: 12px;
                }

                .list-group-item i {
                    font-size: 1.15rem;
                    width: 24px;
                    text-align: center;
                }

            .chat-area {
                flex-grow: 1;
                display: flex;
                flex-direction: column;
                background: linear-gradient(135deg, #fafffe 0%, #f1f8f4 100%);
                border-radius: 28px;
                overflow: hidden;
                box-shadow: 0 8px 32px rgba(46, 125, 50, 0.15);
                border: 2px solid rgba(255, 255, 255, 0.8);
            }

            /* Hiệu ứng lá cây nền */
            body::before {
                content: '🌿';
                position: fixed;
                font-size: 300px;
                opacity: 0.03;
                right: -50px;
                top: 50%;
                transform: translateY(-50%) rotate(-25deg);
                pointer-events: none;
                z-index: 0;
                animation: float 6s ease-in-out infinite;
            }

            @@keyframes float {
                0%, 100% {
                    transform: translateY(-50%) rotate(-25deg);
                }

                50% {
                    transform: translateY(-55%) rotate(-20deg);
                }
            }

            body::after {
                content: '🍃';
                position: fixed;
                font-size: 200px;
                opacity: 0.02;
                left: -30px;
                bottom: 10%;
                transform: rotate(15deg);
                pointer-events: none;
                z-index: 0;
                animation: float 8s ease-in-out infinite reverse;
            }

            .notification-badge {
                position: absolute;
                top: 10px;
                right: 10px;
                min-width: 22px;
                height: 22px;
                padding: 0 6px;
                background-color: #f04747;
                border-radius: 12px;
                border: 2px solid #2e7d32;
                color: white;
                font-size: 0.8rem;
                font-weight: 700;
                display: flex;
                align-items: center;
                justify-content: center;
                animation: popIn 0.3s ease;
            }

            @@keyframes popIn {
                from {
                    transform: scale(0.5);
                    opacity: 0;
                }

                to {
                    transform: scale(1);
                    opacity: 1;
                }
            }

            #layout-user-avatar-img {
                width: 100%;
                height: 100%;
                border-radius: 50%;
                object-fit: cover;
                border: 2px solid rgba(255, 255, 255, 0.5); /* viền nhẹ */
                transition: transform 0.2s ease;
            }

                #layout-user-avatar-img:hover {
                    transform: scale(1.05);
                }

            .profile-section .nav-icon {
                padding: 0;
                border-radius: 50%;
                overflow: hidden;
            }
            /* --- Hiển thị avatar đối phương ở bên trái --- */
            .chat-message.other {
                display: flex;
                align-items: flex-end;
                justify-content: flex-start;
                gap: 8px;
            }

                .chat-message.other .avatar {
                    background: #43a047;
                    color: #fff;
                    font-weight: 600;
                    border-radius: 50%;
                    width: 36px;
                    height: 36px;
                    display: flex;
                    justify-content: center;
                    align-items: center;
                    font-size: 0.95rem;
                    flex-shrink: 0;
                    box-shadow: 0 2px 4px rgba(67, 160, 71, 0.3);
                }

                .chat-message.other .chat-bubble {
                    background-color: #e4e6eb;
                    color: #050505;
                    border-radius: 18px 18px 18px 0;
                    padding: 10px 14px;
                    max-width: 65%;
                    display: inline-block;
                    word-wrap: break-word;
                    white-space: pre-wrap;
                    box-shadow: 0 2px 6px rgba(0, 0, 0, 0.1);
                }

            /* --- Tin nhắn của bạn (bên phải) --- */
            .chat-message.self {
                display: flex;
                justify-content: flex-end;
                align-items: flex-end;
                gap: 8px;
            }

                .chat-message.self .chat-bubble {
                    background-color: #007bff;
                    color: white;
                    border-radius: 18px 18px 0 18px;
                    padding: 10px 14px;
                    max-width: 65%;
                    display: inline-block;
                    word-wrap: break-word;
                    white-space: pre-wrap;
                    box-shadow: 0 2px 6px rgba(0, 123, 255, 0.2);
                }
            .chat-bubble img,
            .chat-bubble video {
                border-radius: 12px;
                margin-top: 4px;
                max-width: 100%;
                transition: transform 0.2s ease;
            }

            .chat-bubble img:hover {
                    transform: scale(1.02);
            }


        </style>
    </head>
    <body>
        <div class="app-layout">

            <nav class="main-nav-bar">
                <div class="profile-section">
                    <a href="#" data-bs-toggle="modal" data-bs-target="#myProfileModal" class="nav-icon" title="@User.Identity.Name">
                        <img id="layout-user-avatar-img"
                             src="@Url.Content(string.IsNullOrEmpty(ViewBag.CurrentUserAvatarUrl) ? "/Content/default-avatar.png" : ViewBag.CurrentUserAvatarUrl + "?v=" + (ViewBag.CurrentUserAvatarVersion ?? "1"))"
                             onerror="this.onerror=null;this.src='/Content/default-avatar.png';"
                             alt="Avatar"
                             style="width: 50px; height: 50px; border-radius: 50%; object-fit: cover; border: 2px solid rgba(255,255,255,0.5);" />
                    </a>
                </div>

                <div class="nav-separator"></div>

                <div class="nav-group">
                    <a href="@Url.Action("Index", "Chat")" id="chat-nav-icon" class="nav-icon @(ViewBag.Title == "Chat" ? "active" : "")" title="Tin nhắn">
                        <i class="fas fa-comments"></i>
                    </a>

                    <a href="@Url.Action("Index", "Friend")" id="friend-nav-icon" class="nav-icon @(ViewBag.Title == "Friends" ? "active" : "")" title="Danh bạ">
                        <i class="fas fa-user-friends"></i>
                    </a>
                </div>

                <div class="nav-separator"></div>

                <div class="nav-group">
                    <a href="@Url.Action("Index", "Settings")" class="nav-icon" title="Cài đặt">
                        <i class="fas fa-cog"></i>
                    </a>
                    @using (Html.BeginForm("Logout", "Account", FormMethod.Post, new { id = "logoutForm" }))
                    {
                        @Html.AntiForgeryToken()
                        <a href="javascript:document.getElementById('logoutForm').submit()" class="nav-icon" title="Đăng xuất">
                            <i class="fas fa-sign-out-alt"></i>
                        </a>
                    }
                </div>
            </nav>

            @if (ViewBag.Title != "Hồ sơ của bạn")
            {
                if (ViewBag.Title == "Chat")
                {
                    <aside class="conversation-list">
                        <div class="conv-header">
                            <i class="fas fa-leaf"></i>
                            <span>Tin nhắn</span>
                        </div>
                        <div class="conv-items">
                            <ul class="list-group list-group-flush" id="conversation-list-ul">
                                <a href="#" class="list-group-item list-group-item-action" id="ai-chat-btn" data-chat-mode="ai">
                                    <strong><i class="fas fa-robot"></i> AI Assistant</strong>
                                </a>
                            </ul>
                        </div>
                    </aside>
                }
            }


            <main class="chat-area">
                @RenderBody()
            </main>
        </div>

        <div class="modal fade" id="myProfileModal" tabindex="-1" role="dialog">
            <div class="modal-dialog modal-dialog-centered" role="document">
                <div class="modal-content" style="border-radius: 20px; overflow: hidden; background: #f1f8e9;">
                    <div id="modal-cover" style="height: 150px; background-size: cover; background-position: center; background-color: #c8e6c9;"></div>
                    <img id="modal-avatar" src="" style="width: 100px; height: 100px; border-radius: 50%; border: 4px solid #fff; position: absolute; top: 100px; left: 50%; transform: translateX(-50%); background-color: #fff;" />
                    <div class="modal-body" style="padding-top: 65px; text-align: center;">
                        <h3 id="modal-display-name" style="font-weight: 700; color: #2e7d32; margin-bottom: 5px;"></h3>
                        <hr style="margin-top: 20px; margin-bottom: 20px;" />
                        <div style="text-align: left; padding: 0 20px; color: #388e3c;">
                            <p><i class="fas fa-phone-alt" style="width: 20px;"></i> <strong id="modal-phone"></strong></p>
                            <p><i class="fas fa-envelope" style="width: 20px;"></i> <strong id="modal-email"></strong></p>
                        </div>
                        <hr style="margin-top: 20px; margin-bottom: 20px;" />
                        <h5 style="color: #388e3c; font-weight: 600;">Quét mã để kết bạn</h5>
                        <img id="modal-qr-code" src="" style="width: 200px; height: 200px; border-radius: 10px; border: 2px solid #c8e6c9;" />
                    </div>
                    <div class="modal-footer" style="background-color: #e8f5e9; border-top: 1px solid #c8e6c9;">
                        <a href="@Url.Action("Index", "Profile")" class="btn btn-success" style="background: #43a047; border: none; border-radius: 10px;">
                            <i class="fas fa-edit"></i> Chỉnh sửa hồ sơ
                        </a>
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal" style="border-radius: 10px;">Đóng</button>
                    </div>
                </div>
            </div>
        </div>

        @Scripts.Render("~/bundles/jquery")
        @Scripts.Render("~/bundles/popper")
        @Scripts.Render("~/bundles/bootstrap")
        <script src="~/Scripts/jquery-3.6.0.min.js"></script>
        <script src="~/Scripts/jquery.signalR-2.4.3.min.js"></script>
        <script src="~/signalr/hubs"></script>

        @RenderSection("scripts", required: false)

    <script>
        var CurrentPageTitle = @Html.Raw(Json.Encode(ViewBag.Title));

        $(function () {
            window.chatHub = $.connection.chatHub;
            window.currentChat = { mode: 'ai', partnerUsername: null };
            const urlParams = new URLSearchParams(window.location.search);
            const friendUsername = urlParams.get('friendUsername');

            if (friendUsername) {
                const checkFriendLoaded = setInterval(() => {
                    const target = $(`.list-group-item-action[data-username='${friendUsername}']`);
                    if (target.length) {
                        clearInterval(checkFriendLoaded);
                        switchChat(target);
                    }
                }, 300);
            }
            if ('@User.Identity.IsAuthenticated' !== 'True') {
                return;
            }

            const chatHub = $.connection.chatHub;
            const currentUsername = @Html.Raw(Json.Encode(User.Identity.Name));
            window.currentChat = { mode: 'ai', partnerUsername: null };
            let currentChat = { mode: 'ai', partnerUsername: null };
            let aiChatHistory = [];

            loadFriendsList();

            function sendTextMessage(e) {
                if (e) e.preventDefault();
                const messageContent = $('#messageInput').val();
                if (messageContent.trim() === '') return;

                if (currentChat.mode === 'ai') {
                    chatHub.server.sendMessageToAI(messageContent);
                } else if (currentChat.mode === 'private') {
                    const msg = JSON.stringify({ type: "text", content: messageContent });
                    chatHub.server.sendPrivateMessage(currentChat.partnerUsername, msg);
                }

                if (currentChat.mode === 'private') {
                    localStorage.setItem('lastChatPartner', currentChat.partnerUsername);
                }

                $('#messageInput').val('').focus();
            }




            function switchChat(target) {
                $('#messagesList').empty();
                currentChat.mode = $(target).data('chat-mode');

                $('.conversation-list .list-group-item-action').removeClass('active');
                $(target).addClass('active');

                if (currentChat.mode === 'ai') {
                    aiChatHistory = [];
                    currentChat.partnerUsername = null;
                    $('#current-group-name').html('<i class="fas fa-robot"></i> Trò chuyện với AI Assistant');
                } else {
                    currentChat.partnerUsername = $(target).data('username');
                    $('#current-group-name').html(`<i class="fas fa-user"></i> Trò chuyện với ${currentChat.partnerUsername}`);

                    if (chatHub.server.joinPrivateGroup) {
                        chatHub.server.joinPrivateGroup(currentChat.partnerUsername);
                    }
                }

                if ($(window).width() < 768) {
                    $('.conversation-list').hide();
                }
                if (currentChat.mode === 'private') {
                    // Gọi API để lấy lịch sử tin nhắn
                    $.getJSON(`/Chat/GetChatHistory?partnerUsername=${currentChat.partnerUsername}`, function (response) {
                        if (response.success) {
                            $('#messagesList').empty();
                            response.messages.forEach(msg => {
                                const isSelf = msg.SenderUsername === currentUsername;
                                const firstLetter = msg.SenderUsername.charAt(0).toUpperCase();
                                let messageBodyHtml;
                                if (msg.Content.startsWith("data:image") || msg.Content.startsWith("/Uploads/Images/")) {
                                    messageBodyHtml = `
                                    <div class="chat-bubble">
                                        <img src="${msg.Content}" class="img-fluid rounded"
                                             style="max-width: 250px; cursor: pointer;"
                                             onclick="window.open(this.src, '_blank');" />
                                    </div>`;
                                } else {
                                    const escapedContent = $('<div/>').text(msg.Content).html();
                                    messageBodyHtml = `<div class="chat-bubble">${escapedContent}</div>`;
                                }

                                const messageHtml = `
                                <div class="chat-message ${isSelf ? 'self' : 'other'}">
                                    ${isSelf ? '' : `<div class="avatar" title="${msg.SenderUsername}">${firstLetter}</div>`}
                                    ${messageBodyHtml}
                                </div>`;

                                $('#messagesList').append(messageHtml);
                            });

                            // 🔹 Cuộn xuống cuối khung chat sau khi load
                            $('#messagesList').scrollTop($('#messagesList')[0].scrollHeight);

                        }
                    });
                }
                if ($(window).width() < 768) {
                    $('.conversation-list').hide();
                }
            }

            function loadFriendsList(selectedFriendUsername) {
                const container = $('#conversation-list-ul');
                container.find('.friend-item').remove();

                $.getJSON("@Url.Action("GetFriendsList", "Friend")", function (friends) {
                    friends.forEach(function (friend) {
                        const friendHtml = `
                            <a href="#" class="list-group-item list-group-item-action friend-item"
                               data-chat-mode="private"
                               data-username="${friend.Username}"
                               data-userid="${friend.Id}">
                                <strong><i class="fas fa-user"></i> ${friend.DisplayName}</strong>
                            </a>`;
                        container.append(friendHtml);
                    });
                    if (CurrentPageTitle === "Chat") {
                        let target;
                        if (selectedFriendUsername) {
                            target = container.find(`.list-group-item-action[data-username='${selectedFriendUsername}']`);
                        }

                        if (!target || target.length === 0) {
                            target = $('#ai-chat-btn');
                        }

                        switchChat(target);
                    }
                });
            }

            if (chatHub && chatHub.client) {
                chatHub.client.receiveMessage = function (senderUsername, senderAvatar, type, messageContent, time) {
                    const isSelf = senderUsername === currentUsername;
                    const firstLetter = senderUsername.charAt(0).toUpperCase();
                    let messageBodyHtml = "";

                    if (type === "image") {
                        messageBodyHtml = `
                        <div class="chat-bubble">
                            <img src="${messageContent}" alt="image"
                                 class="img-fluid rounded"
                                 style="max-width: 250px; cursor: pointer;"
                                 onclick="window.open(this.src, '_blank');" />
                        </div>`;
                    } else if (type === "video") {
                        messageBodyHtml = `
                        <div class="chat-bubble">
                            <video controls src="${messageContent}" 
                                   style="max-width: 300px; border-radius: 10px;"></video>
                        </div>`;
                    } else if (type === "file") {
                        messageBodyHtml = `
                        <div class="chat-bubble">
                            <a href="${messageContent}" target="_blank" style="color:#007bff; text-decoration:none;">
                                📄 Tải file
                            </a>
                        </div>`;
                    } else {
                        const escaped = $('<div/>').text(messageContent).html();
                        messageBodyHtml = `<div class="chat-bubble">${escaped}</div>`;
                    }

                    const messageHtml = `
                        <div class="chat-message ${isSelf ? 'self' : 'other'}">
                            ${isSelf ? '' : `<div class="avatar" title="${senderUsername}">${firstLetter}</div>`}
                            ${messageBodyHtml}
                        </div>`;

                    const messagesList = $('#messagesList');
                    messagesList.append(messageHtml);
                    messagesList.scrollTop(messagesList[0].scrollHeight);
                };

                $.connection.hub.error(function (error) {
                    console.error('SignalR Error: ', error);
                    alert('Erreur de connexion : ' + error.message);
                });

                chatHub.client.receiveFriendRequestNotification = function (senderName) {
                    const friendIcon = $('#friend-nav-icon');
                    if (friendIcon.length > 0) {
                        let badge = friendIcon.find('.notification-badge');
                        if (badge.length === 0) {
                            friendIcon.append('<span class="notification-badge">1</span>');
                        } else {
                            let count = parseInt(badge.text() || '0') + 1;
                            badge.text(count);
                        }
                    }
                };

                chatHub.client.updateAvatar = function (newAvatarUrlWithVersion) {
                    const avatarImgOnLayout = $('#layout-user-avatar-img');
                    if (avatarImgOnLayout.length) {
                        avatarImgOnLayout.attr('src', newAvatarUrlWithVersion);
                    }
                };
            }

            $('#myProfileModal').on('show.bs.modal', function () {
                $.getJSON('@Url.Action("GetMyProfileSummary", "Profile")', function (data) {
                    if (data.success) {
                        $('#modal-cover').css('background-image', `url(${data.coverUrl ?? '/Content/default-cover.jpg'})`);
                        $('#modal-avatar').attr('src', data.avatarUrl ?? '/Content/default-avatar.png');
                        $('#modal-display-name').text(data.displayName);
                        $('#modal-phone').text(data.phoneNumber || "Chưa cập nhật");
                        $('#modal-email').text(data.email || "Chưa cập nhật");
                        $('#modal-qr-code').attr('src', `${data.qrCodeUrl}?v=${new Date().getTime()}`);
                    }
                });
            });

            $('.conversation-list').on('click', '.list-group-item-action', function (e) {
                e.preventDefault();
                switchChat(this);
            });
            $('body').off('click', '#sendButton').on('click', '#sendButton', function (e) {
                e.preventDefault();
                sendTextMessage(e);
            });

            $('body').off('keypress', '#messageInput').on('keypress', '#messageInput', function (e) {
                if (e.which === 13 && !e.shiftKey) {
                    e.preventDefault();
                    sendTextMessage(e);
                }
            });

            $('body').on('click', '#toggle-conversations-btn', function (e) {
                e.preventDefault();
                $('.conversation-list').toggle();
            });

            $.connection.hub.url = (window.location.protocol === "https:"
                ? "wss://"
                : "ws://") + window.location.host + "/signalr";

                $.connection.hub.qs = { "noCache": new Date().getTime() }; 
                $.connection.hub.transportConnectTimeout = 10000; 
                $.connection.hub.keepAlive = 15000; 
                $.connection.hub.reconnectDelay = 5000; 

            $.connection.hub.url = window.location.origin + "/signalr";
            $.connection.hub.start({ transport: ['webSockets', 'serverSentEvents', 'longPolling'] })
                .done(function () {
                    console.log("✅ SignalR connected successfully");
                    const lastPartner = localStorage.getItem('lastChatPartner');
                    if (lastPartner) {
                        const openChatInterval = setInterval(() => {
                            const friendItem = $(`.friend-item[data-username='${lastPartner}']`);
                            if (friendItem.length) {
                                clearInterval(openChatInterval);
                                friendItem.trigger('click');
                            }
                        }, 400);
                    }

                    const urlParams = new URLSearchParams(window.location.search);
                    const friendUsername = urlParams.get('friendUsername') || lastPartner;

                    if (friendUsername) {
                        console.log("🔍 Auto-open chat with:", friendUsername);

                        const openChatInterval = setInterval(() => {
                            const friendItem = $(`.friend-item[data-username='${friendUsername}']`);
                            if (friendItem.length) {
                                clearInterval(openChatInterval);
                                friendItem.trigger('click');
                                console.log("✅ Auto opened chat with:", friendUsername);
                            }
                        }, 400);
                    }
                })
                .fail(function (err) {
                    console.error("❌ SignalR connection failed:", err);
                });

        });
    </script>

    </body>
    </html>