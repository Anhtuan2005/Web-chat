<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>@ViewBag.Title - Online Chat App</title>

    @Styles.Render("~/Content/css")
    <style>
                .notification-badge {
                        position: absolute;
                        top: 5px;
                        right: -5px;
                        width: 20px;
                        height: 20px;
                        background-color: #f04747;
                        border-radius: 50%;
                        color: white;
                        font-size: 0.7rem;
                        font-weight: 700;
                        display: flex;
                        align-items: center;
                        justify-content: center;
                        border: 2px solid #343a40;

        }


    </style>
</head>
<body>
    <nav class="navbar navbar-expand-lg navbar-dark bg-dark">
        <div class="container-fluid">
            <a class="navbar-brand" href="@Url.Action("Index", "Home")">🌿 Chat</a>             <div class="collapse navbar-collapse">
                <ul class="navbar-nav ml-auto">
                    @if (Request.IsAuthenticated)
                    {
                        <li class="nav-item"><a class="nav-link" href="@Url.Action("Index", "Home")">Phòng chat</a></li>
                        <li class="nav-item"><a class="nav-link" href="@Url.Action("Index", "Feed")">Bảng tin</a></li>
                        <li class="nav-item">
                            <a class="nav-link" href="@Url.Action("Index", "Friend")">Danh bạ</a>
                        </li>

                        <li class="nav-item"><a class="nav-link" href="@Url.Action("Index", "Profile")">Tài khoản</a></li>
                        <li class="nav-item">
                            @using (Html.BeginForm("Logout", "Account", FormMethod.Post, new { id = "logoutForm", @class = "form-inline" }))
                            {
                                @Html.AntiForgeryToken()
                                <a class="nav-link" href="javascript:document.getElementById('logoutForm').submit()">Đăng xuất</a>
                            }
                        </li>
                    }
                    else
                    {
                        <li class="nav-item"><a class="nav-link" href="@Url.Action("Register", "Account")">Đăng ký</a></li>
                        <li class="nav-item"><a class="nav-link" href="@Url.Action("Login", "Account")">Đăng nhập</a></li>
                    }
                </ul>
            </div>
        </div>
    </nav>

    <div class="container body-content mt-4">
        @RenderBody()
        <hr />
        <footer>
            <p>&copy; @DateTime.Now.Year - Chat Application</p>
        </footer>
    </div>

    @Scripts.Render("~/bundles/jquery")
    @Scripts.Render("~/bundles/bootstrap")
    @RenderSection("scripts", required: false)

    @if (User.Identity.IsAuthenticated)
    {
        <script src="~/Scripts/jquery.signalR-2.4.3.js"></script>
        <script src="~/signalr/hubs"></script>

        <script>
            $(function () {
                var chatHub = $.connection.chatHub;

                if (chatHub) {
                    chatHub.client.receiveFriendRequestNotification = function (senderName) {
                        console.log(`Nhận được lời mời kết bạn từ ${senderName}`);

                        const navIcon = $('.navbar a[href*="/Friend"]');
                        if (navIcon.length > 0) {
                            let badge = navIcon.find('.notification-badge');
                            if (badge.length === 0) {
                                navIcon.css('position', 'relative').append('<span class="notification-badge">1</span>');
                            } else {
                                let count = parseInt(badge.text() || 0) + 1;
                                badge.text(count);
                            }
                        }

                        const buttonBadge = $('#pending-requests-badge');
                        if (buttonBadge.length > 0) {
                            let count = parseInt(buttonBadge.text() || '0') + 1;
                            buttonBadge.text(count);
                        }
                    }; 

                    $.connection.hub.start()
                        .done(function () { console.log("Đã kết nối SignalR."); })
                        .fail(function (err) { console.error("Kết nối SignalR thất bại: ", err); });
                }
            });
        </script>
    }

</body>
</html>